<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[logo占位符]种梦音乐 - 交互式原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
        }

        /* 隐藏滚动条但保持滚动功能 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        /* 按钮悬停效果 */
        .btn-primary {
            transition: all 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        /* 表格行悬停 */
        .table-row:hover {
            background: #f9fafb;
        }

        /* 导航项激活状态 */
        .nav-item.active {
            background: #eff6ff;
            color: #1d4ed8;
            border-left: 3px solid #3b82f6;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        /* 模态框动画 */
        .modal-overlay {
            animation: fadeIn 0.2s;
        }

        .modal-content {
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast 动画 */
        .toast {
            animation: toastSlide 0.3s;
        }

        @keyframes toastSlide {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3b82f6;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* 标签样式 */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-interview {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-contract {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-waiting {
            background: #fce7f3;
            color: #9f1239;
        }

        .status-certified {
            background: #d1fae5;
            color: #065f46;
        }

        /* 文件上传区域 */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        /* 富文本编辑器模拟 */
        .rich-editor {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            min-height: 200px;
        }

        .editor-toolbar {
            border-bottom: 1px solid #e5e7eb;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px 8px 0 0;
        }

        .editor-content {
            padding: 12px;
            min-height: 150px;
            outline: none;
        }

        /* 隐藏元素 */
        .hidden {
            display: none !important;
        }

        /* 加载状态 */
        .loading {
            pointer-events: none;
            opacity: 0.6;
        }

        /* 图片预览 */
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* 搜索下拉列表样式 */
        .search-dropdown {
            position: relative;
        }

        .search-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            z-index: 50;
        }

        .search-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-dropdown-item:hover {
            background: #f3f4f6;
        }

        /* 带内置搜索的下拉选择器样式 */
        .select-with-search {
            position: relative;
        }

        .select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 36px;
            padding: 0 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .select-trigger:hover {
            border-color: #9ca3af;
        }

        .select-trigger.active {
            border-color: #3b82f6;
        }

        .select-value {
            color: #374151;
            font-size: 14px;
        }

        .select-value.placeholder {
            color: #9ca3af;
        }

        .select-arrow {
            width: 16px;
            height: 16px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .select-trigger.active .select-arrow {
            transform: rotate(180deg);
        }

        .select-dropdown-panel {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            z-index: 50;
        }

        .dropdown-search-box {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .dropdown-search-input {
            width: 100%;
            height: 32px;
            padding: 0 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }

        .dropdown-search-input:focus {
            border-color: #3b82f6;
        }

        .dropdown-options-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .dropdown-option-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .dropdown-option-item:hover {
            background: #f3f4f6;
        }

        .dropdown-option-item.selected {
            background: #eff6ff;
            color: #2563eb;
        }

        .dropdown-no-result {
            padding: 12px;
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
        }

        /* 拖拽排序样式 */
        .drag-handle {
            cursor: grab;
            color: #9ca3af;
            padding: 4px;
            display: flex;
            align-items: center;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .song-item {
            transition: all 0.15s ease;
        }

        .song-item.dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }

        .song-item.drag-over {
            border-top: 2px solid #3b82f6;
            margin-top: -2px;
        }

        .filter-group { margin-top: 12px; }
        .filter-title { font-size: 12px; color: #6b7280; margin-bottom: 8px; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-option { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; cursor: pointer; transition: all .15s; }
        .filter-option:hover { border-color: #cbd5e1; background: #f9fafb; }
        .filter-option.active { border-color: #f97316; background: #fff7ed; color: #b45309; }
        .breadcrumb { display:flex; flex-wrap:wrap; gap:6px; font-size: 12px; color:#6b7280; }
        .breadcrumb span { color:#374151; }
        .filter-option.disabled { opacity: .5; cursor: not-allowed; border-color: #e5e7eb; background: #f9fafb; }
    </style>
</head>
<body data-component="main-container">

    <!-- Top Bar 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-40" data-component="topbar">
        <div class="flex items-center justify-between h-16 px-6">
            <div class="flex items-center">
                <div class="text-xl font-semibold text-gray-800">[logo占位符]种梦音乐</div>
            </div>

            <div class="flex items-center gap-4">
                <!-- 搜索框 -->
                <div class="relative" data-component="global-search">
                    <input type="text" placeholder="搜索..."
                           class="w-64 h-9 pl-10 pr-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    <svg class="w-4 h-4 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <!-- 通知 -->
                <button class="relative p-2 hover:bg-gray-100 rounded-lg" data-type="button">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>

                <!-- 用户信息 -->
                <div class="flex items-center gap-3 pl-3 border-l border-gray-200" data-component="user-info">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                        管
                    </div>
                    <div class="text-sm">
                        <div class="font-medium text-gray-800">管理员</div>
                        <div class="text-gray-500 text-xs">超级管理员</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar 左侧导航 -->
    <aside class="fixed left-0 top-16 bottom-0 w-64 bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar" data-component="sidebar">
        <nav class="py-4">
            <!-- 艺人管理模块 -->
            <div class="mb-2">
                <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">艺人管理</div>
                <div class="nav-item active flex items-center px-4 py-3 text-sm cursor-pointer" data-page="artist-applications" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>艺人申请</span>
                </div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="artist-list" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <span>艺人列表</span>
                </div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="song-management" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                    </svg>
                    <span>歌曲管理</span>
                </div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="album-management" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <span>专辑管理</span>
                </div>
            </div>

            <!-- 数据中心模块 -->
            <div class="mb-2">
                <div class="px-4 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">数据中心</div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="data-overview" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>平台总览</span>
                </div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="data-ops" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>作品经营</span>
                </div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="data-import" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v12m0 0l-4-4m4 4l4-4M4 20h16"></path>
                    </svg>
                    <span>导入数据</span>
                </div>
                <div class="nav-item flex items-center px-4 py-3 text-sm cursor-pointer" data-page="data-import-history" data-type="nav-item">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>导入历史</span>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content 主内容区 -->
    <main class="ml-64 mt-16 p-6" data-component="main-content">

        <!-- 艺人申请管理页面 -->
        <section id="page-artist-applications" class="page-view" data-page="artist-applications" data-view="list">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- 页面标题 -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">艺人申请管理</h1>
                    <p class="text-sm text-gray-500 mt-1">管理艺人申请工单，跟进申请流程</p>
                </div>

                <!-- 表格 -->
                <div class="overflow-x-auto" data-component="table-list">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">工单ID</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">申请人姓名</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">艺名</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">性别</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">联系电话</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">微信号</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">个人介绍</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">负责人/经纪人</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">歌曲demo</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">完整首发歌曲</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">申请时间</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="application-table-body" class="divide-y divide-gray-200">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between" data-component="pagination">
                    <div class="text-sm text-gray-600">共 <span id="app-total-count">0</span> 条</div>
                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&lt;</button>
                        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm" data-type="button">1</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">2</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">3</button>
                        <span class="px-2 text-gray-500">...</span>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">7</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&gt;</button>
                        <select class="ml-4 px-3 py-1 border border-gray-300 rounded text-sm" data-type="input">
                            <option>10条/页</option>
                            <option>20条/页</option>
                            <option>50条/页</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 艺人列表管理页面 -->
        <section id="page-artist-list" class="page-view hidden" data-page="artist-list" data-view="list">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- 页面标题 -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">艺人列表管理</h1>
                    <p class="text-sm text-gray-500 mt-1">管理已认证艺人信息</p>
                </div>

                <!-- 查询栏 -->
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50" data-component="filter-bar">
                    <div class="flex items-center gap-4">
                        <input type="text" id="artist-search-input" placeholder="真实姓名/艺名/ID/手机号"
                               class="flex-1 max-w-md h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                        <button class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">查询</button>
                        <button onclick="openArtistFormModal('add')" class="btn-primary px-6 py-2 bg-green-500 text-white rounded-lg text-sm font-medium" data-type="button">新增</button>
                    </div>
                </div>

                <!-- 表格 -->
                <div class="overflow-x-auto" data-component="table-list">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">UID</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">艺名</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">真实姓名</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">联系电话</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">经纪人</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">认证时间</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">上线状态</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="artist-table-body" class="divide-y divide-gray-200">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between" data-component="pagination">
                    <div class="text-sm text-gray-600">共 <span id="artist-total-count">0</span> 条</div>
                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&lt;</button>
                        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm" data-type="button">1</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">2</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">3</button>
                        <span class="px-2 text-gray-500">...</span>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">6</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&gt;</button>
                        <select class="ml-4 px-3 py-1 border border-gray-300 rounded text-sm" data-type="input">
                            <option>10条/页</option>
                            <option>20条/页</option>
                            <option>50条/页</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 歌曲管理页面 -->
        <section id="page-song-management" class="page-view hidden" data-page="song-management" data-view="list">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- 页面标题 -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">歌曲管理</h1>
                    <p class="text-sm text-gray-500 mt-1">管理歌曲库及版权信息</p>
                </div>

                <!-- 查询栏 -->
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50" data-component="filter-bar">
                    <div class="flex items-center gap-4">
                        <input type="text" placeholder="按歌曲名称搜索"
                               class="flex-1 max-w-md h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                        <button class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">查询</button>
                        <button onclick="openSongFormModal()" class="btn-primary px-6 py-2 bg-green-500 text-white rounded-lg text-sm font-medium" data-type="button">新增</button>
                    </div>
                </div>

                <!-- 表格 -->
                <div class="overflow-x-auto" data-component="table-list">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">歌曲ID</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">歌曲名称</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">所属专辑</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">艺人</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">版权类型</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">录音版权</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">歌曲附件</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">合同</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">上线状态</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">负责人/经纪人</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="song-table-body" class="divide-y divide-gray-200">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between" data-component="pagination">
                    <div class="text-sm text-gray-600">共 <span id="song-total-count">0</span> 条</div>
                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&lt;</button>
                        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm" data-type="button">1</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">2</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&gt;</button>
                        <select class="ml-4 px-3 py-1 border border-gray-300 rounded text-sm" data-type="input">
                            <option>10条/页</option>
                            <option>20条/页</option>
                            <option>50条/页</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 专辑管理页面 -->
        <section id="page-album-management" class="page-view hidden" data-page="album-management" data-view="list">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- 页面标题 -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">专辑管理</h1>
                    <p class="text-sm text-gray-500 mt-1">管理专辑信息及关联歌曲</p>
                </div>

                <!-- 查询栏 -->
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50" data-component="filter-bar">
                    <div class="flex items-center gap-4">
                        <input type="text" placeholder="按专辑名称搜索"
                               class="flex-1 max-w-xs h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                        <div class="select-with-search" id="album-artist-select-container" data-type="select" style="min-width: 160px;">
                            <div class="select-trigger" onclick="toggleSelectDropdown('album-artist')">
                                <span class="select-value placeholder" id="album-artist-select-value">全部艺人</span>
                                <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <div class="select-dropdown-panel hidden" id="album-artist-dropdown-panel">
                                <div class="dropdown-search-box">
                                    <input type="text" class="dropdown-search-input" id="album-artist-search-input" placeholder="搜索艺人..." oninput="filterSelectOptions('album-artist')">
                                </div>
                                <div class="dropdown-options-list" id="album-artist-options-list"></div>
                            </div>
                        </div>
                        <button class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">查询</button>
                        <button onclick="openAlbumFormModal('add')" class="btn-primary px-6 py-2 bg-green-500 text-white rounded-lg text-sm font-medium" data-type="button">新增</button>
                    </div>
                </div>

                <!-- 表格 -->
                <div class="overflow-x-auto" data-component="table-list">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">专辑序号</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">专辑ID</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">专辑封面</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">专辑名称</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">艺人</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">发布时间</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">歌曲数量</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">上线状态</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="album-table-body" class="divide-y divide-gray-200">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between" data-component="pagination">
                    <div class="text-sm text-gray-600">共 <span id="album-total-count">0</span> 条</div>
                    <div class="flex items-center gap-2">
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&lt;</button>
                        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm" data-type="button">1</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">2</button>
                        <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm" data-type="button">&gt;</button>
                        <select class="ml-4 px-3 py-1 border border-gray-300 rounded text-sm" data-type="input">
                            <option>10条/页</option>
                            <option>20条/页</option>
                            <option>50条/页</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-data-overview" class="page-view hidden" data-page="data-overview" data-view="data">
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">平台总览</h1>
                </div>
                <div id="dc-overview" class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" id="dc-metric-cards"></div>
                    <div class="mt-4" id="dc-metric-filter">
                        <div class="flex items-center gap-3" data-component="filter-bar">
                            <div id="dc-date-filter" class="flex items-center gap-2 hidden">
                                <input type="date" id="dc-start-date" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" data-type="input">
                                <span class="text-gray-500 text-sm">至</span>
                                <input type="date" id="dc-end-date" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" data-type="input">
                            </div>
                            <div id="dc-month-filter" class="flex items-center gap-2">
                                <input type="text" id="dc-start-month" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" data-type="input">
                                <span class="text-gray-500 text-sm">至</span>
                                <input type="text" id="dc-end-month" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" data-type="input">
                            </div>
                            <button id="dc-apply-range" class="px-4 py-2 border border-gray-300 rounded-lg text-sm" data-type="button">应用</button>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div class="h-80" id="dc-overview-line"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-data-ops" class="page-view hidden" data-page="data-ops" data-view="data">
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">作品经营</h1>
                </div>
                <div id="dc-ops" class="px-6 py-4">
                    <div class="flex items-center gap-2 border-b border-gray-200">
                        <button class="px-3 py-2 text-sm" data-ops-tab="ops">经营情况</button>
                        <button class="px-3 py-2 text-sm" data-ops-tab="platform">平台分布</button>
                    </div>
                    <div class="mt-4 flex items-center gap-3">
                        <button id="ops-filter-open" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">筛选</button>
                        <div class="flex items-center gap-2">
                            <div id="ops-breadcrumb" class="text-xs text-gray-600"></div>
                            <button id="ops-reset-drill" class="px-3 py-2 border border-gray-300 rounded-lg text-xs">清除下钻</button>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-3" data-component="filter-bar">
                        <input type="text" id="ops-start-month" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" data-type="input">
                        <span class="text-gray-500 text-sm">至</span>
                        <input type="text" id="ops-end-month" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" data-type="input">
                        <button id="ops-apply-range" class="px-4 py-2 border border-gray-300 rounded-lg text-sm" data-type="button">应用</button>
                    </div>
                    <div id="ops-panel" class="mt-6">
                        <div class="h-96" id="ops-combo-chart"></div>
                    </div>
                    <div id="ops-platform-panel" class="mt-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="h-96" id="platform-play-pie"></div>
                            <div class="h-96" id="platform-income-pie"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 导入数据页面 -->
        <section id="page-data-import" class="page-view hidden" data-page="data-import" data-view="data">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- 页面标题 -->
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold text-gray-800">导入数据</h1>
                        <p class="text-sm text-gray-500 mt-1">导入各平台不同表格结构的经营数据。</p>
                    </div>
                    <button onclick="openCollectionPresetModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 flex items-center gap-2" data-type="button">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        采集预设
                    </button>
                </div>

                <!-- 步骤条 -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-center">
                        <div class="flex items-center space-x-4">
                            <div class="step-item flex items-center" data-step="1">
                                <div class="step-circle w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium">1</div>
                                <span class="step-text ml-2 text-sm font-medium text-blue-600">上传表格</span>
                            </div>
                            <div class="step-connector w-12 h-px bg-gray-300"></div>
                            <div class="step-item flex items-center" data-step="2">
                                <div class="step-circle w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-medium">2</div>
                                <span class="step-text ml-2 text-sm text-gray-600">模拟确认</span>
                            </div>
                            <div class="step-connector w-12 h-px bg-gray-300"></div>
                            <div class="step-item flex items-center" data-step="3">
                                <div class="step-circle w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-medium">3</div>
                                <span class="step-text ml-2 text-sm text-gray-600">导入成功</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤内容 -->
                <div class="p-6">
                    <!-- 步骤1：上传表格 -->
                    <div id="import-step-1" class="step-content">
                        <div class="max-w-5xl mx-auto">
                            <!-- 平台选择 -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">选择平台 <span class="text-red-500">*</span></label>
                                <select id="import-platform-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">请选择平台</option>
                                    <option value="netease">网易</option>
                                    <option value="tme">TME</option>
                                    <option value="bytedance">字节</option>
                                    <option value="kugou">酷狗</option>
                                    <option value="aiting">爱听</option>
                                </select>
                            </div>

                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                                <div class="upload-area cursor-pointer">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9.9.9 0 01-.9.9H7z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m0 0l-3-3m3 3l3-3"></path>
                                    </svg>
                                    <p class="text-lg font-medium text-gray-700 mb-2">点击上传文件</p>
                                    <p class="text-sm text-gray-500">或将文件拖拽到此处</p>
                                    <p class="text-xs text-gray-400 mt-2">支持 .xlsx 格式，可上传多个文件，单个最大 10MB</p>
                                </div>
                                <input type="file" id="file-input" accept=".xlsx" multiple class="hidden">
                            </div>
                            <!-- 文件列表 -->
                            <div id="file-list" class="mt-4 space-y-2">
                                <!-- 动态生成文件列表 -->
                            </div>
                        </div>
                    </div>

                    <!-- 步骤2：模拟确认 -->
                    <div id="import-step-2" class="step-content hidden">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                <p class="text-sm text-green-800">模拟导入完成，请确认数据结果：</p>
                            </div>

                            <!-- 模拟结果表格 -->
                            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">币种</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">平台</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">渠道</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">歌曲名</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">结算期</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">艺人</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">播放量</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">下载量</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">销售量</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">收入</th>
                                            </tr>
                                        </thead>
                                        <tbody id="simulation-results" class="divide-y divide-gray-200">
                                            <!-- 动态生成模拟结果 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 步骤3：导入成功 -->
                    <div id="import-step-3" class="step-content hidden">
                        <div class="max-w-2xl mx-auto text-center">
                            <div id="import-progress" class="mb-8">
                                <div class="bg-gray-200 rounded-full h-2 mb-4">
                                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="progress-text" class="text-sm text-gray-600">正在导入数据...</p>
                            </div>
                            
                            <div id="import-success" class="hidden">
                                <svg class="w-16 h-16 text-green-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">导入成功！</h3>
                                <p class="text-gray-600">数据已成功导入系统，并更新到经营情况图表中。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div id="import-actions" class="px-6 py-4 border-t border-gray-200 flex justify-between">
                    <button id="prev-step" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled data-type="button">上一步</button>
                    <button id="next-step" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled data-type="button">下一步</button>
                </div>
            </div>
        </section>

        <section id="page-data-import-history" class="page-view hidden" data-page="data-import-history" data-view="data">
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">导入历史</h1>
                    <p class="text-sm text-gray-500 mt-1">显示所有管理角色的导入记录</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">导入文件名</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">工作表个数</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">导入结果</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作人</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">导入完成时间</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="import-history-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- 模态框容器 -->
        <div id="modal-container" data-component="modal-container"></div>
        <div id="import-history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">导入结果详情</h3>
                    <p class="text-sm text-gray-500 mt-1" id="import-history-modal-title"></p>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <div id="history-detail-content"></div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button onclick="closeHistoryModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">关闭</button>
                </div>
            </div>
        </div>

        <!-- 文件错误详情模态框 -->
        <div id="file-error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">文件错误详情</h3>
                    <p class="text-sm text-gray-500 mt-1" id="file-error-modal-title"></p>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <div id="file-error-content" class="space-y-4">
                        <!-- 动态生成错误详情 -->
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button onclick="closeFileErrorModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">关闭</button>
                </div>
            </div>
        </div>

        <!-- 合同电子签模态框 -->
        <div id="contract-sign-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[85vh] overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">电子签章</h3>
                        <p class="text-sm text-gray-500 mt-1">
                            <span id="contract-sign-song-name"></span> - <span id="contract-sign-type"></span>
                        </p>
                    </div>
                    <button onclick="closeContractSignModal()" class="text-gray-400 hover:text-gray-600" data-type="button">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <!-- 模拟第三方电子签内嵌界面 -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 h-96 flex flex-col items-center justify-center">
                        <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium text-gray-600 mb-2">第三方电子签平台</p>
                        <p class="text-sm text-gray-500 mb-4">此处将嵌入电子签章服务</p>
                        <div class="flex items-center gap-4">
                            <div class="text-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-1">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs text-gray-500">签署</span>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-1">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs text-gray-500">验证</span>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-1">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs text-gray-500">存证</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                    <button onclick="closeContractSignModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">关闭</button>
                </div>
            </div>
        </div>

        <!-- 采集预设模态框 -->
        <div id="collection-preset-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[85vh] overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">采集预设</h3>
                    <p class="text-sm text-gray-500 mt-1">配置数据字段采集规则和平台保留字</p>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <!-- 字段采集特征与用途 -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">字段采集特征与用途</h4>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">字段名称</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">特征</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">采集用途</th>
                                        <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 w-16">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="preset-fields-table" class="divide-y divide-gray-200">
                                    <!-- 动态生成字段行 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 添加字段 -->
                        <div class="mt-3 flex items-center gap-2">
                            <input type="text" id="new-field-name-input" placeholder="输入字段名称"
                                   class="flex-1 max-w-xs h-8 px-3 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                   onkeypress="if(event.key==='Enter'){addPresetField();event.preventDefault();}">
                            <button onclick="addPresetField()" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" data-type="button">添加字段</button>
                        </div>
                    </div>

                    <!-- 平台保留字配置 -->
                    <div class="mb-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">平台保留字</h4>
                        <div class="flex flex-wrap gap-2 mb-3" id="platform-tags-container">
                            <!-- 动态生成平台标签 -->
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" id="new-platform-input" placeholder="输入平台名称" class="flex-1 max-w-xs h-8 px-3 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                            <button onclick="addPlatformTag()" class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded hover:bg-gray-200" data-type="button">添加</button>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <p class="text-xs text-gray-500">"*"表示采集必需表头，若缺少会报错</p>
                        <div class="flex gap-3">
                            <button onclick="closeCollectionPresetModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">取消</button>
                            <button onclick="saveCollectionPreset()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- 字段选择模态框 -->
    <div id="field-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">选择字段映射</h3>
                <p class="text-sm text-gray-500 mt-1" id="field-selection-title"></p>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="field-selection-content">
                    <!-- 动态生成字段选项 -->
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button id="cancel-field-selection" onclick="closeFieldSelectionModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">取消</button>
            <button id="confirm-field-selection" onclick="confirmFieldSelection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">确定</button>
            </div>
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div id="toast-container" class="fixed top-20 right-6 z-50 space-y-2" data-component="toast-container"></div>

    <script>
        // ==================== 数据模型 ====================

        // 艺人申请数据
        const applicationData = [
            {
                id: 'AP001',
                name: '张小明',
                stageName: '小明',
                gender: '男',
                phone: '13800138001',
                wechat: 'zhangxm001',
                intro: '热爱音乐，擅长流行、民谣风格，有5年演唱经验，曾参加过多个音乐比赛并获奖。希望能够加入平台，展示自己的才华，为听众带来更多优秀作品。',
                applyTime: '2025-01-15 14:30',
                status: 'pending', // pending, interview, contract, waiting, certified
                agent: '', // 负责人/经纪人，推进到待访谈后自动填充
                demoUrl: '', // 歌曲demo URL
                firstSongUrl: '' // 完整首发歌曲 URL（完签待传作品状态后才有）
            },
            {
                id: 'AP002',
                name: '李佳音',
                stageName: 'Jia音',
                gender: '女',
                phone: '13900139002',
                wechat: 'lijiayin88',
                intro: '专业音乐学院毕业，主修声乐，擅长R&B和爵士风格。有丰富的舞台表演经验，曾在多个酒吧和livehouse演出。',
                applyTime: '2025-01-14 10:20',
                status: 'interview',
                agent: '张经纪',
                demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                firstSongUrl: ''
            },
            {
                id: 'AP003',
                name: '王浩然',
                stageName: 'Hao Ran',
                gender: '男',
                phone: '13700137003',
                wechat: 'whr_music',
                intro: '独立音乐人，擅长原创歌曲创作，已发布10余首个人单曲。音乐风格多元，涵盖流行、摇滚、电子等。',
                applyTime: '2025-01-13 16:45',
                status: 'contract',
                agent: '李经纪',
                demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                firstSongUrl: ''
            },
            {
                id: 'AP004',
                name: '陈雅婷',
                stageName: 'Yating',
                gender: '女',
                phone: '13600136004',
                wechat: 'cyt_singer',
                intro: '网络歌手，在各大短视频平台拥有百万粉丝。擅长翻唱和改编，声音甜美，深受年轻听众喜爱。',
                applyTime: '2025-01-12 09:15',
                status: 'waiting',
                agent: '王经纪',
                demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
                firstSongUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
            },
            {
                id: 'AP005',
                name: '刘晨曦',
                stageName: 'Morning',
                gender: '女',
                phone: '13500135005',
                wechat: 'morning_music',
                intro: '古风音乐爱好者，擅长古风、国风类型歌曲演唱。曾为多部古装影视剧演唱OST。',
                applyTime: '2025-01-10 11:30',
                status: 'certified',
                agent: '张经纪',
                demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3',
                firstSongUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3'
            }
        ];

        // 艺人列表数据
        const artistData = [
            { uid: 'A10001', stageName: '星辰', realName: '周星辰', phone: '13800138001', agent: '张经纪', certTime: '2024-12-01', online: true, demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', firstSongUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
            { uid: 'A10002', stageName: '月影', realName: '林月影', phone: '13900139002', agent: '李经纪', certTime: '2024-11-15', online: true, demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', firstSongUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
            { uid: 'A10003', stageName: 'Ray Chen', realName: '陈睿', phone: '13700137003', agent: '王经纪', certTime: '2024-10-20', online: false, demoUrl: '', firstSongUrl: '' },
            { uid: 'A10004', stageName: '小鹿', realName: '鹿晓晓', phone: '13600136004', agent: '张经纪', certTime: '2024-09-05', online: true, demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', firstSongUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' },
            { uid: 'A10005', stageName: 'Vivian', realName: '薇薇安', phone: '13500135005', agent: '李经纪', certTime: '2024-08-18', online: true, demoUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', firstSongUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3' }
        ];

        // 歌曲数据
        const songData = [
            { id: 'S001', name: '星空下的约定', album: '梦想专辑', artist: '星辰', copyrightType: '自有', recordingRight: '自有', attachment: '星空下的约定.mp3', contract: '已有合同重签', online: true, agent: '张经纪' },
            { id: 'S002', name: '月光曲', album: '月夜物语', artist: '月影', copyrightType: '代理', recordingRight: '共享', attachment: '月光曲.mp3', contract: '补充协议', online: true, agent: '李经纪' },
            { id: 'S003', name: 'Dream On', album: 'First Light', artist: 'Ray Chen', copyrightType: '自有', recordingRight: '自有', attachment: 'DreamOn.mp3', contract: '新合同', online: false, agent: '张经纪' },
            { id: 'S004', name: '森林漫步', album: '自然之声', artist: '小鹿', copyrightType: '自有', recordingRight: '双方', attachment: '森林漫步.mp3', contract: '', online: true, agent: '王经纪' },
            { id: 'S005', name: 'Love Story', album: 'Romance', artist: 'Vivian', copyrightType: '代理', recordingRight: '无', attachment: 'LoveStory.mp3', contract: '新合同', online: false, agent: '李经纪' }
        ];

        // 专辑数据
        const albumData = [
            { id: 'AL001', cover: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlNWU3ZWIiPjwvcmVjdD48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjE0cHgiIGZpbGw9IiNhMGEwYTAiPmpzb248L3RleHQ+PC9zdmc+',name: '梦想专辑', artist: '星辰', releaseTime: '2024-12-01', songCount: 10, online: true },
            { id: 'AL002', cover: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlNWU3ZWIiPjwvcmVjdD48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjE0cHgiIGZpbGw9IiNhMGEwYTAiPmpzb248L3RleHQ+PC9zdmc+', name: '月夜物语', artist: '月影', releaseTime: '2024-11-15', songCount: 8, online: true },
            { id: 'AL003', cover: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlNWU3ZWIiPjwvcmVjdD48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjE0cHgiIGZpbGw9IiNhMGEwYTAiPmpzb248L3RleHQ+PC9zdmc+', name: 'First Light', artist: 'Ray Chen', releaseTime: '2024-10-20', songCount: 12, online: false },
            { id: 'AL004', cover: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlNWU3ZWIiPjwvcmVjdD48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjE0cHgiIGZpbGw9IiNhMGEwYTAiPmpzb248L3RleHQ+PC9zdmc+', name: '自然之声', artist: '小鹿', releaseTime: '2024-09-05', songCount: 6, online: true },
            { id: 'AL005', cover: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlNWU3ZWIiPjwvcmVjdD48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjE0cHgiIGZpbGw9IiNhMGEwYTAiPmpzb248L3RleHQ+PC9zdmc+', name: 'Romance', artist: 'Vivian', releaseTime: '2024-08-18', songCount: 9, online: true }
        ];

        // ==================== 状态管理 ====================

        let currentPage = 'artist-applications';
        let currentEditArtist = null;
        let currentEditAlbum = null;
        const currentAdmin = '张经纪'; // 当前登录的管理员

        // 经纪人列表
        const agentList = ['张经纪', '李经纪', '王经纪', '赵经纪', '刘经纪'];
        const userList = ['张三 (13800138001)', '李四 (13900139002)', '王五 (15012345678)', '赵六 (18600001234)', '钱七 (13712349876)', '孙八 (15987654321)'];

        // ==================== 工具函数 ====================

        // 显示Toast通知
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.setAttribute('data-type', 'toast');
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === 'success'
                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                        }
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('已复制到剪贴板');
            }).catch(() => {
                showToast('复制失败', 'error');
            });
        }

        // 获取状态标签HTML
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: '待审核', class: 'status-pending' },
                'interview': { text: '待访谈', class: 'status-interview' },
                'contract': { text: '待签约', class: 'status-contract' },
                'waiting': { text: '完签待传作品', class: 'status-waiting' },
                'certified': { text: '认证艺人', class: 'status-certified' }
            };
            const s = statusMap[status] || statusMap['pending'];
            return `<span class="status-badge ${s.class}">${s.text}</span>`;
        }

        // 获取操作按钮HTML
        function getActionButton(status, id) {
            if (status === 'certified') return '-';

            const buttonMap = {
                'pending': { text: '推进', nextStatus: 'interview', confirmText: '是否接受跟进？' },
                'interview': { text: '推进', nextStatus: 'contract', confirmText: '是否沟通达成一致，进行下一步的合同准备？' },
                'contract': { text: '发起合同', nextStatus: 'waiting', confirmText: '确认发起电子合同？' },
                'waiting': { text: '等待中', nextStatus: 'certified', confirmText: '' }
            };

            const btn = buttonMap[status];
            if (!btn) return '-';

            if (status === 'waiting') {
                return `<button class="px-3 py-1 text-sm border border-gray-300 rounded text-gray-400 cursor-not-allowed" disabled>${btn.text}</button>`;
            }

            return `<button onclick="handleStatusChange('${id}', '${status}', '${btn.nextStatus}', '${btn.confirmText}')"
                           class="btn-primary px-4 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600" data-type="button">${btn.text}</button>`;
        }

        // ==================== 页面渲染函数 ====================

        // 获取音频下载按钮HTML
        function getAudioDownloadButton(url) {
            if (!url) return '-';
            return `<button onclick="downloadAudio('${url}')" class="text-blue-600 hover:text-blue-700" data-type="button">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                    </button>`;
        }

        // 下载音频（仅UI演示）
        function downloadAudio(url) {
            showToast('下载功能演示，会打包下载歌曲歌词封面等（实际不下载）');
        }

        // 搜索下拉列表功能
        function initSearchDropdown(inputId, dropdownId, list, onSelect) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            let filteredList = list;

            input.addEventListener('input', () => {
                const searchTerm = input.value.toLowerCase();
                filteredList = list.filter(item => item.toLowerCase().includes(searchTerm));

                if (filteredList.length > 0 && input.value) {
                    dropdown.innerHTML = filteredList.map(item =>
                        `<div class="search-dropdown-item" onclick="selectAgent('${inputId}', '${dropdownId}', '${item}')">${item}</div>`
                    ).join('');
                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
            });

            input.addEventListener('focus', () => {
                if (filteredList.length > 0) {
                    dropdown.classList.remove('hidden');
                }
            });

            // 点击外部关闭下拉
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function selectAgent(inputId, dropdownId, value) {
            document.getElementById(inputId).value = value;
            document.getElementById(dropdownId).classList.add('hidden');
        }

        // 带内置搜索的下拉选择器相关函数
        const selectData = {
            user: { list: userList, selected: '' },
            agent: { list: agentList, selected: '' },
            'album-artist': { list: ['全部艺人'], selected: '全部艺人' },
            'song-form-artist': { list: ['星辰', '月影', 'Ray Chen'], selected: '' },
            'album-form-artist': { list: ['星辰', '月影', 'Ray Chen'], selected: '' }
        };

        // 切换下拉面板显示
        function toggleSelectDropdown(type) {
            const panel = document.getElementById(`${type}-dropdown-panel`);
            const trigger = panel.previousElementSibling;
            const isHidden = panel.classList.contains('hidden');

            // 关闭所有其他下拉
            document.querySelectorAll('.select-dropdown-panel').forEach(p => {
                p.classList.add('hidden');
                p.previousElementSibling?.classList.remove('active');
            });

            if (isHidden) {
                panel.classList.remove('hidden');
                trigger.classList.add('active');
                // 渲染选项列表
                renderSelectOptions(type);
                // 聚焦搜索框
                document.getElementById(`${type}-search-input`).focus();
            }
        }

        // 渲染选项列表
        function renderSelectOptions(type, filter = '') {
            const optionsList = document.getElementById(`${type}-options-list`);
            const list = selectData[type].list;
            const selected = selectData[type].selected;

            const filtered = filter
                ? list.filter(item => item.toLowerCase().includes(filter.toLowerCase()))
                : list;

            if (filtered.length === 0) {
                optionsList.innerHTML = '<div class="dropdown-no-result">无匹配结果</div>';
            } else {
                optionsList.innerHTML = filtered.map(item => `
                    <div class="dropdown-option-item ${item === selected ? 'selected' : ''}"
                         onclick="selectOption('${type}', '${item.replace(/'/g, "\\'")}')">
                        ${item}
                    </div>
                `).join('');
            }
        }

        // 过滤选项
        function filterSelectOptions(type) {
            const searchInput = document.getElementById(`${type}-search-input`);
            renderSelectOptions(type, searchInput.value);
        }

        // 选择选项
        function selectOption(type, value) {
            selectData[type].selected = value;
            const valueSpan = document.getElementById(`${type}-select-value`);
            valueSpan.textContent = value;
            valueSpan.classList.remove('placeholder');

            // 关闭下拉
            const panel = document.getElementById(`${type}-dropdown-panel`);
            const trigger = panel.previousElementSibling;
            panel.classList.add('hidden');
            trigger.classList.remove('active');

            // 清空搜索框
            document.getElementById(`${type}-search-input`).value = '';
        }

        // 初始化下拉选择器
        function initSelectWithSearch(type, initialValue = '') {
            if (initialValue) {
                selectData[type].selected = initialValue;
                const valueSpan = document.getElementById(`${type}-select-value`);
                if (valueSpan) {
                    valueSpan.textContent = initialValue;
                    valueSpan.classList.remove('placeholder');
                }
            }
            renderSelectOptions(type);
        }

        // 点击外部关闭所有下拉
        document.addEventListener('click', (e) => {
            const containers = document.querySelectorAll('.select-with-search');
            containers.forEach(container => {
                if (!container.contains(e.target)) {
                    const panel = container.querySelector('.select-dropdown-panel');
                    const trigger = container.querySelector('.select-trigger');
                    if (panel && trigger) {
                        panel.classList.add('hidden');
                        trigger.classList.remove('active');
                    }
                }
            });
        });

        // 渲染艺人申请表格
        function renderApplicationTable() {
            const tbody = document.getElementById('application-table-body');
            tbody.innerHTML = applicationData.map(app => `
                <tr class="table-row">
                    <td class="px-6 py-4 text-sm text-gray-800">${app.id}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${app.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${app.stageName}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${app.gender}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="text-blue-600 cursor-pointer hover:underline" onclick="copyToClipboard('${app.phone}')">${app.phone}</span>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <span class="text-blue-600 cursor-pointer hover:underline" onclick="copyToClipboard('${app.wechat}')">${app.wechat}</span>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="showIntroModal('${app.name}', \`${app.intro}\`)"
                                class="text-blue-600 hover:text-blue-700" data-type="button">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex items-center gap-2" id="agent-cell-${app.id}">
                            <span class="text-gray-600">${app.agent || '-'}</span>
                            <button onclick="enableAgentEdit('${app.id}', '${app.agent || ''}')"
                                    class="text-blue-500 hover:text-blue-600 p-1" data-type="button" title="指派经纪人">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm">${getAudioDownloadButton(app.demoUrl)}</td>
                    <td class="px-6 py-4 text-sm">${getAudioDownloadButton(app.firstSongUrl)}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${app.applyTime}</td>
                    <td class="px-6 py-4 text-sm">${getStatusBadge(app.status)}</td>
                    <td class="px-6 py-4 text-sm">${getActionButton(app.status, app.id)}</td>
                </tr>
            `).join('');
            document.getElementById('app-total-count').textContent = applicationData.length;
        }

        // 渲染艺人列表表格
        function renderArtistTable() {
            const tbody = document.getElementById('artist-table-body');
            tbody.innerHTML = artistData.map(artist => `
                <tr class="table-row">
                    <td class="px-6 py-4 text-sm text-gray-800">${artist.uid}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">${artist.stageName}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${artist.realName}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="text-blue-600 cursor-pointer hover:underline" onclick="copyToClipboard('${artist.phone}')">${artist.phone}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${artist.agent}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${artist.certTime}</td>
                    <td class="px-6 py-4">
                        <label class="switch">
                            <input type="checkbox" ${artist.online ? 'checked' : ''} onchange="toggleArtistOnline('${artist.uid}')">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="openArtistFormModal('edit', '${artist.uid}')"
                                class="text-blue-600 hover:text-blue-700 font-medium" data-type="button">编辑</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('artist-total-count').textContent = artistData.length;
        }

        // 渲染歌曲表格
        function renderSongTable() {
            const tbody = document.getElementById('song-table-body');
            tbody.innerHTML = songData.map((song, index) => `
                <tr class="table-row">
                    <td class="px-6 py-4 text-sm text-gray-800">${song.id}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">${song.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${song.album}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${song.artist}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${song.copyrightType}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${song.recordingRight}</td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex items-center gap-2">
                            <button onclick="downloadSongAttachment('${song.attachment}')" class="text-blue-600 hover:text-blue-700 flex items-center gap-1" data-type="button" title="下载附件">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>
                            <span class="text-xs text-gray-600">${song.attachment}</span>
                            <button onclick="uploadSongAttachment(${index})" class="text-green-600 hover:text-green-700 text-xs underline" data-type="button">
                                重新上传
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        ${song.contract ? `<button onclick="openContractSignModal('${song.name}', '${song.contract}')" class="px-2 py-1 text-xs rounded hover:opacity-80 ${
                            song.contract === '已有合同重签' ? 'bg-yellow-100 text-yellow-700' :
                            song.contract === '补充协议' ? 'bg-blue-100 text-blue-700' :
                            song.contract === '新合同' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                        }" data-type="button">${song.contract}</button>` : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-center">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${song.online ? 'checked' : ''} onchange="toggleSongOnline(${index})" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${song.agent || '-'}</td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="openSongFormModal('edit', '${song.id}')" class="text-blue-600 hover:text-blue-700 font-medium" data-type="button">编辑</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('song-total-count').textContent = songData.length;
        }

        // 下载歌曲附件
        function downloadSongAttachment(filename) {
            showToast(`正在下载: ${filename}`, 'success');
        }

        // 上传歌曲附件
        function uploadSongAttachment(index) {
            // 创建隐藏的文件输入框
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.mp3,.wav,.flac';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 模拟上传
                    songData[index].attachment = file.name;
                    renderSongTable();
                    showToast(`${songData[index].name} 附件已更新为: ${file.name}`, 'success');
                }
            };
            input.click();
        }

        // 切换歌曲上线状态
        function toggleSongOnline(index) {
            songData[index].online = !songData[index].online;
            const status = songData[index].online ? '已上线' : '已下线';
            showToast(`${songData[index].name} ${status}`, 'success');
        }

        // 打开合同电子签模态框
        function openContractSignModal(songName, contractType) {
            document.getElementById('contract-sign-song-name').textContent = songName;
            document.getElementById('contract-sign-type').textContent = contractType;
            document.getElementById('contract-sign-modal').classList.remove('hidden');
        }

        // 关闭合同电子签模态框
        function closeContractSignModal() {
            document.getElementById('contract-sign-modal').classList.add('hidden');
        }

        // 渲染专辑表格
        function renderAlbumTable() {
            const tbody = document.getElementById('album-table-body');
            tbody.innerHTML = albumData.map((album, index) => `
                <tr class="table-row">
                    <td class="px-4 py-4">
                        <input type="number"
                               class="w-16 h-8 px-2 border border-gray-300 rounded text-sm text-center focus:outline-none focus:border-blue-500"
                               value="${index + 1}"
                               min="1"
                               onchange="updateAlbumOrder('${album.id}', this.value)"
                               data-type="input">
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-800">${album.id}</td>
                    <td class="px-6 py-4">
                        <img src="${album.cover}" alt="${album.name}" class="w-12 h-12 rounded object-cover">
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">${album.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${album.artist}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${album.releaseTime}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${album.songCount} 首</td>
                    <td class="px-6 py-4">
                        <label class="switch">
                            <input type="checkbox" ${album.online ? 'checked' : ''} onchange="toggleAlbumOnline('${album.id}')">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="openAlbumFormModal('edit', '${album.id}')"
                                class="text-blue-600 hover:text-blue-700 font-medium" data-type="button">编辑</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('album-total-count').textContent = albumData.length;
        }

        // 更新艺人专辑序号
        function updateAlbumOrder(albumId, newOrder) {
            showToast(`该艺人的专辑 ${albumId} 序号已更新为 ${newOrder}`);
        }

        // 初始化专辑艺人筛选下拉
        function initAlbumArtistFilter() {
            const artists = ['全部艺人', ...new Set(artistData.map(a => a.stageName))];
            selectData['album-artist'].list = artists;
            initSelectWithSearch('album-artist', '全部艺人');
        }

        // 启用经纪人编辑模式
        function enableAgentEdit(appId, currentAgent) {
            const cell = document.getElementById(`agent-cell-${appId}`);
            if (!cell) return;

            // 创建内联选择器
            cell.innerHTML = `
                <div class="select-with-search inline-agent-select" style="min-width: 120px;">
                    <div class="select-trigger" onclick="toggleInlineAgentDropdown('${appId}')">
                        <span class="select-value ${currentAgent ? '' : 'placeholder'}" id="inline-agent-value-${appId}">${currentAgent || '请选择'}</span>
                        <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="select-dropdown-panel hidden" id="inline-agent-dropdown-${appId}">
                        <div class="dropdown-search-box">
                            <input type="text" class="dropdown-search-input" id="inline-agent-search-${appId}" placeholder="搜索经纪人..." oninput="filterInlineAgentOptions('${appId}')">
                        </div>
                        <div class="dropdown-options-list" id="inline-agent-options-${appId}"></div>
                    </div>
                </div>
                <button onclick="cancelAgentEdit('${appId}', '${currentAgent}')" class="text-gray-400 hover:text-gray-600 p-1 ml-1" title="取消">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            // 渲染选项
            renderInlineAgentOptions(appId);
        }

        // 切换内联经纪人下拉
        function toggleInlineAgentDropdown(appId) {
            const panel = document.getElementById(`inline-agent-dropdown-${appId}`);
            const trigger = panel.previousElementSibling;
            const isHidden = panel.classList.contains('hidden');

            // 关闭其他所有下拉
            document.querySelectorAll('.inline-agent-select .select-dropdown-panel').forEach(p => {
                p.classList.add('hidden');
                p.previousElementSibling?.classList.remove('active');
            });

            if (isHidden) {
                panel.classList.remove('hidden');
                trigger.classList.add('active');
                document.getElementById(`inline-agent-search-${appId}`).focus();
            }
        }

        // 渲染内联经纪人选项
        function renderInlineAgentOptions(appId, filter = '') {
            const optionsList = document.getElementById(`inline-agent-options-${appId}`);
            const filtered = filter
                ? agentList.filter(item => item.toLowerCase().includes(filter.toLowerCase()))
                : agentList;

            if (filtered.length === 0) {
                optionsList.innerHTML = '<div class="dropdown-no-result">无匹配结果</div>';
            } else {
                optionsList.innerHTML = filtered.map(item => `
                    <div class="dropdown-option-item" onclick="selectInlineAgent('${appId}', '${item}')">
                        ${item}
                    </div>
                `).join('');
            }
        }

        // 过滤内联经纪人选项
        function filterInlineAgentOptions(appId) {
            const searchInput = document.getElementById(`inline-agent-search-${appId}`);
            renderInlineAgentOptions(appId, searchInput.value);
        }

        // 选择内联经纪人
        function selectInlineAgent(appId, agent) {
            // 更新数据
            const app = applicationData.find(a => a.id === appId);
            if (app) {
                app.agent = agent;
            }

            // 恢复显示模式
            const cell = document.getElementById(`agent-cell-${appId}`);
            cell.innerHTML = `
                <span class="text-gray-600">${agent}</span>
                <button onclick="enableAgentEdit('${appId}', '${agent}')"
                        class="text-blue-500 hover:text-blue-600 p-1" data-type="button" title="指派经纪人">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                    </svg>
                </button>
            `;

            showToast(`已指派 ${agent} 为负责人`);
        }

        // 取消经纪人编辑
        function cancelAgentEdit(appId, currentAgent) {
            const cell = document.getElementById(`agent-cell-${appId}`);
            cell.innerHTML = `
                <span class="text-gray-600">${currentAgent || '-'}</span>
                <button onclick="enableAgentEdit('${appId}', '${currentAgent || ''}')"
                        class="text-blue-500 hover:text-blue-600 p-1" data-type="button" title="指派经纪人">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                    </svg>
                </button>
            `;
        }

        // ==================== 交互逻辑 ====================

        // 导航切换
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const targetPage = this.getAttribute('data-page');

                // 更新导航激活状态
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                // 切换页面显示
                document.querySelectorAll('.page-view').forEach(page => page.classList.add('hidden'));
                document.getElementById('page-' + targetPage).classList.remove('hidden');

                currentPage = targetPage;
                if (targetPage === 'data-ops') {
                    if (!opsInit.ops) { switchOpsTab('ops'); }
                    ensureDcVisible();
                } else if (targetPage === 'data-overview') {
                    ensureDcVisible();
                } else if (targetPage === 'data-import-history') {
                    renderImportHistoryTable();
                }
            });
        });

        // 状态变更处理
        function handleStatusChange(id, currentStatus, nextStatus, confirmText) {
            openConfirmModal(confirmText, () => {
                const app = applicationData.find(a => a.id === id);
                if (app) {
                    app.status = nextStatus;

                    // 推进到待访谈状态时，自动记录当前操作人为负责人/经纪人
                    if (currentStatus === 'pending' && nextStatus === 'interview') {
                        app.agent = currentAdmin;
                    }

                    renderApplicationTable();

                    if (currentStatus === 'contract') {
                        showToast('电子合同已发送，等待签约完成');
                    } else {
                        showToast('状态已更新');
                    }
                }
            });
        }

        // 显示个人介绍浮层
        function showIntroModal(name, intro) {
            const modal = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                     onclick="closeModal()" data-type="modal">
                    <div class="modal-content bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" onclick="event.stopPropagation()">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${name} - 个人介绍</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600" data-type="button">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="px-6 py-6">
                            <p class="text-sm text-gray-700 leading-relaxed">${intro}</p>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                            <button onclick="closeModal()"
                                    class="btn-secondary px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50" data-type="button">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modal;
        }

        // 确认对话框
        function openConfirmModal(message, onConfirm) {
            const modal = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-type="modal">
                    <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">确认操作</h3>
                        </div>
                        <div class="px-6 py-6">
                            <p class="text-sm text-gray-700">${message}</p>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                            <button onclick="closeModal()"
                                    class="btn-secondary px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50" data-type="button">取消</button>
                            <button onclick="confirmAction()"
                                    class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">确认</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modal;
            window.currentConfirmAction = onConfirm;
        }

        function confirmAction() {
            if (window.currentConfirmAction) {
                window.currentConfirmAction();
                window.currentConfirmAction = null;
            }
            closeModal();
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // 切换艺人上线状态
        function toggleArtistOnline(uid) {
            const artist = artistData.find(a => a.uid === uid);
            if (artist) {
                artist.online = !artist.online;
                showToast(artist.online ? '已上线' : '已下线');
            }
        }

        // 切换专辑上线状态
        function toggleAlbumOnline(id) {
            const album = albumData.find(a => a.id === id);
            if (album) {
                album.online = !album.online;
                showToast(album.online ? '已上线' : '已下线');
            }
        }

        // 打开艺人表单模态框
        function openArtistFormModal(mode, uid = null) {
            currentEditArtist = mode === 'edit' ? artistData.find(a => a.uid === uid) : null;

            const modal = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" data-type="modal">
                    <div class="modal-content bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 my-8">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${mode === 'add' ? '新增艺人' : '编辑艺人'}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600" data-type="button">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="px-6 py-6 max-h-[600px] overflow-y-auto custom-scrollbar" data-component="form-modal">
                            <form id="artist-form" class="space-y-6">
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <span class="text-red-500">*</span> 真实姓名
                                        </label>
                                        <input type="text" required
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                               value="${currentEditArtist?.realName || ''}" data-type="input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <span class="text-red-500">*</span> 艺名
                                        </label>
                                        <input type="text" required
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                               value="${currentEditArtist?.stageName || ''}" data-type="input">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <span class="text-red-500">*</span> 性别
                                        </label>
                                        <select required class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                            <option value="">请选择</option>
                                            <option value="male">男</option>
                                            <option value="female">女</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <span class="text-red-500">*</span> 联系电话
                                        </label>
                                        <input type="tel" required
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                               value="${currentEditArtist?.phone || ''}" data-type="input">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="text-red-500">*</span> 头像
                                    </label>
                                    <div class="upload-area">
                                        <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="mt-2 text-sm text-gray-600">点击上传图片</p>
                                        <p class="mt-1 text-xs text-gray-400">支持 JPG、PNG 格式，建议尺寸 400x400</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">艺人类型</label>
                                        <select class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                            <option value="">请选择</option>
                                            <option value="signed">签约艺人</option>
                                            <option value="settled">入驻艺人</option>
                                            <option value="producer">制作人</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">绑定用户</label>
                                        <div class="select-with-search" id="user-select-container" data-type="select">
                                            <div class="select-trigger" onclick="toggleSelectDropdown('user')">
                                                <span class="select-value placeholder" id="user-select-value">请选择</span>
                                                <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                            <div class="select-dropdown-panel hidden" id="user-dropdown-panel">
                                                <div class="dropdown-search-box">
                                                    <input type="text" class="dropdown-search-input" id="user-search-input" placeholder="搜索用户..." oninput="filterSelectOptions('user')">
                                                </div>
                                                <div class="dropdown-options-list" id="user-options-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">负责人/经纪人</label>
                                    <div class="select-with-search" id="agent-select-container" data-type="select">
                                        <div class="select-trigger" onclick="toggleSelectDropdown('agent')">
                                            <span class="select-value placeholder" id="agent-select-value">${currentEditArtist?.agent || '请选择'}</span>
                                            <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="select-dropdown-panel hidden" id="agent-dropdown-panel">
                                            <div class="dropdown-search-box">
                                                <input type="text" class="dropdown-search-input" id="agent-search-input" placeholder="搜索经纪人..." oninput="filterSelectOptions('agent')">
                                            </div>
                                            <div class="dropdown-options-list" id="agent-options-list"></div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">个人介绍</label>
                                    <div class="rich-editor">
                                        <div class="editor-toolbar">
                                            <button type="button" class="px-2 py-1 hover:bg-gray-200 rounded text-sm" data-type="button">B</button>
                                            <button type="button" class="px-2 py-1 hover:bg-gray-200 rounded text-sm" data-type="button">I</button>
                                            <button type="button" class="px-2 py-1 hover:bg-gray-200 rounded text-sm" data-type="button">U</button>
                                        </div>
                                        <div class="editor-content" contenteditable="true">
                                            请输入个人介绍...
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">轮播图</label>
                                    <div class="upload-area">
                                        <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <p class="mt-2 text-sm text-gray-600">点击上传轮播图（可多张）</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">视频</label>
                                    <div class="upload-area">
                                        <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        <p class="mt-2 text-sm text-gray-600">点击上传视频</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">分成比例</label>
                                        <input type="number" min="0" max="100" placeholder="0-100"
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">签约日期</label>
                                        <input type="date"
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">歌曲demo</label>
                                    ${currentEditArtist?.demoUrl ? `
                                        <div class="border border-gray-200 rounded-lg p-4 flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                                </svg>
                                                <span class="text-sm text-gray-700">demo.mp3</span>
                                            </div>
                                            <button onclick="downloadAudio('${currentEditArtist.demoUrl}')" class="flex items-center gap-1 px-3 py-1 text-sm text-blue-600 hover:text-blue-700 border border-blue-600 rounded-lg hover:bg-blue-50" data-type="button">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                下载
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="upload-area">
                                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                            </svg>
                                            <p class="mt-2 text-sm text-gray-600">点击上传音频文件</p>
                                        </div>
                                    `}
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">首发歌曲</label>
                                    ${currentEditArtist?.firstSongUrl ? `
                                        <div class="border border-gray-200 rounded-lg p-4 flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                                </svg>
                                                <span class="text-sm text-gray-700">首发歌曲.mp3</span>
                                            </div>
                                            <button onclick="downloadAudio('${currentEditArtist.firstSongUrl}')" class="flex items-center gap-1 px-3 py-1 text-sm text-blue-600 hover:text-blue-700 border border-blue-600 rounded-lg hover:bg-blue-50" data-type="button">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                下载
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="upload-area">
                                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                            </svg>
                                            <p class="mt-2 text-sm text-gray-600">点击上传音频文件</p>
                                        </div>
                                    `}
                                </div>

                                <div>
                                    <label class="flex items-center gap-3">
                                        <span class="text-sm font-medium text-gray-700">上线状态</span>
                                        <label class="switch">
                                            <input type="checkbox" ${currentEditArtist?.online ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                            <button onclick="closeModal()"
                                    class="btn-secondary px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50" data-type="button">取消</button>
                            <button onclick="saveArtist('${mode}')"
                                    class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">保存</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modal;

            // 初始化带搜索的下拉选择器
            setTimeout(() => {
                initSelectWithSearch('user');
                initSelectWithSearch('agent', currentEditArtist?.agent || '');
            }, 0);
        }

        // 保存艺人
        function saveArtist(mode) {
            // 表单验证逻辑（简化）
            const form = document.getElementById('artist-form');
            if (!form.checkValidity()) {
                showToast('请填写所有必填项', 'error');
                return;
            }

            // 模拟保存
            setTimeout(() => {
                if (mode === 'add') {
                    showToast('艺人添加成功');
                } else {
                    showToast('艺人信息已更新');
                }
                closeModal();
                renderArtistTable();
            }, 500);
        }

        // 打开歌曲表单模态框
        function openSongFormModal(mode = 'add', id = null) {
            const currentEditSong = mode === 'edit' ? songData.find(s => s.id === id) : null;

            const modal = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-type="modal">
                    <div class="modal-content bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${mode === 'add' ? '新增歌曲' : '编辑歌曲'}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600" data-type="button">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="px-6 py-6 max-h-[500px] overflow-y-auto custom-scrollbar" data-component="form-modal">
                            <form id="song-form" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="text-red-500">*</span> 歌曲名称
                                    </label>
                                    <input type="text" required
                                           class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                           value="${currentEditSong?.name || ''}" data-type="input">
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">所属专辑</label>
                                        <select class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                            <option value="">请选择</option>
                                            <option value="AL001">梦想专辑</option>
                                            <option value="AL002">月夜物语</option>
                                            <option value="AL003">First Light</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <span class="text-red-500">*</span> 艺人
                                        </label>
                                        <div class="select-with-search" id="song-form-artist-select-container" data-type="select">
                                            <div class="select-trigger" onclick="toggleSelectDropdown('song-form-artist')">
                                                <span class="select-value placeholder" id="song-form-artist-select-value">请选择</span>
                                                <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                            <div class="select-dropdown-panel hidden" id="song-form-artist-dropdown-panel">
                                                <div class="dropdown-search-box">
                                                    <input type="text" class="dropdown-search-input" id="song-form-artist-search-input" placeholder="搜索艺人..." oninput="filterSelectOptions('song-form-artist')">
                                                </div>
                                                <div class="dropdown-options-list" id="song-form-artist-options-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">词曲版权比例</label>
                                        <input type="number" min="0" max="100" placeholder="0-100"
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">表演者版权比例</label>
                                        <input type="number" min="0" max="100" placeholder="0-100"
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">著作权代理公司</label>
                                    <input type="text"
                                           class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="text-red-500">*</span> 歌曲URL
                                    </label>
                                    <input type="url" required placeholder="https://"
                                           class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">是否公司录音版权</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="recording-right" value="own" class="text-blue-500">
                                            <span class="text-sm">自有</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="recording-right" value="shared" class="text-blue-500">
                                            <span class="text-sm">共享</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="recording-right" value="both" class="text-blue-500">
                                            <span class="text-sm">双方</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="recording-right" value="none" class="text-blue-500">
                                            <span class="text-sm">无</span>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">版权类型</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="copyright-type" value="own" class="text-blue-500">
                                            <span class="text-sm">自有</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="copyright-type" value="agent" class="text-blue-500">
                                            <span class="text-sm">代理</span>
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                            <button onclick="closeModal()"
                                    class="btn-secondary px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50" data-type="button">取消</button>
                            <button onclick="saveSong('${mode}')"
                                    class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">保存</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modal;

            // 初始化艺人选择器
            selectData['song-form-artist'].selected = '';
            document.getElementById('song-form-artist-select-value').textContent = '请选择';
            document.getElementById('song-form-artist-select-value').classList.add('placeholder');
            initSelectWithSearch('song-form-artist');
        }

        // 保存歌曲
        function saveSong(mode = 'add') {
            const form = document.getElementById('song-form');
            if (!form.checkValidity()) {
                showToast('请填写所有必填项', 'error');
                return;
            }

            setTimeout(() => {
                if (mode === 'add') {
                    showToast('歌曲添加成功');
                } else {
                    showToast('歌曲信息已更新');
                }
                closeModal();
                renderSongTable();
            }, 500);
        }

        // 打开专辑表单模态框
        function openAlbumFormModal(mode, id = null) {
            currentEditAlbum = mode === 'edit' ? albumData.find(a => a.id === id) : null;

            const modal = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-type="modal">
                    <div class="modal-content bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${mode === 'add' ? '新增专辑' : '编辑专辑'}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600" data-type="button">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="px-6 py-6 max-h-[500px] overflow-y-auto custom-scrollbar" data-component="form-modal">
                            <form id="album-form" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="text-red-500">*</span> 专辑名称
                                    </label>
                                    <input type="text" required
                                           class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                           value="${currentEditAlbum?.name || ''}" data-type="input">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="text-red-500">*</span> 专辑描述
                                    </label>
                                    <textarea required rows="4"
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-type="input"></textarea>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">艺人</label>
                                        <div class="select-with-search" id="album-form-artist-select-container" data-type="select">
                                            <div class="select-trigger" onclick="toggleSelectDropdown('album-form-artist')">
                                                <span class="select-value placeholder" id="album-form-artist-select-value">请选择</span>
                                                <svg class="select-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                            <div class="select-dropdown-panel hidden" id="album-form-artist-dropdown-panel">
                                                <div class="dropdown-search-box">
                                                    <input type="text" class="dropdown-search-input" id="album-form-artist-search-input" placeholder="搜索艺人..." oninput="filterSelectOptions('album-form-artist')">
                                                </div>
                                                <div class="dropdown-options-list" id="album-form-artist-options-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">发布时间</label>
                                        <input type="date"
                                               class="w-full h-9 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                               value="${currentEditAlbum?.releaseTime || ''}" data-type="input">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">上线状态</label>
                                    <label class="switch">
                                        <input type="checkbox" ${currentEditAlbum?.online ? 'checked' : ''} id="album-online-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="text-red-500">*</span> 专辑封面
                                    </label>
                                    <div class="upload-area">
                                        <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <p class="mt-2 text-sm text-gray-600">点击上传专辑封面</p>
                                        <p class="mt-1 text-xs text-gray-400">建议尺寸 800x800</p>
                                    </div>
                                </div>

                                ${mode === 'edit' ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">专辑歌曲列表 <span class="text-xs text-gray-400 font-normal">（拖拽排序）</span></label>
                                    <div id="album-song-list" class="border border-gray-200 rounded-lg divide-y">
                                        <div class="song-item px-4 py-3 flex items-center justify-between hover:bg-gray-50" draggable="true" data-song-index="0">
                                            <div class="flex items-center gap-3">
                                                <span class="drag-handle">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                        <circle cx="9" cy="6" r="1.5"></circle>
                                                        <circle cx="15" cy="6" r="1.5"></circle>
                                                        <circle cx="9" cy="12" r="1.5"></circle>
                                                        <circle cx="15" cy="12" r="1.5"></circle>
                                                        <circle cx="9" cy="18" r="1.5"></circle>
                                                        <circle cx="15" cy="18" r="1.5"></circle>
                                                    </svg>
                                                </span>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-800">星空下的约定</div>
                                                    <div class="text-xs text-gray-500">时长: 04:23</div>
                                                </div>
                                            </div>
                                            <button type="button" class="text-red-500 hover:text-red-600 text-sm" data-type="button">移除</button>
                                        </div>
                                        <div class="song-item px-4 py-3 flex items-center justify-between hover:bg-gray-50" draggable="true" data-song-index="1">
                                            <div class="flex items-center gap-3">
                                                <span class="drag-handle">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                        <circle cx="9" cy="6" r="1.5"></circle>
                                                        <circle cx="15" cy="6" r="1.5"></circle>
                                                        <circle cx="9" cy="12" r="1.5"></circle>
                                                        <circle cx="15" cy="12" r="1.5"></circle>
                                                        <circle cx="9" cy="18" r="1.5"></circle>
                                                        <circle cx="15" cy="18" r="1.5"></circle>
                                                    </svg>
                                                </span>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-800">追梦</div>
                                                    <div class="text-xs text-gray-500">时长: 03:56</div>
                                                </div>
                                            </div>
                                            <button type="button" class="text-red-500 hover:text-red-600 text-sm" data-type="button">移除</button>
                                        </div>
                                        <div class="song-item px-4 py-3 flex items-center justify-between hover:bg-gray-50" draggable="true" data-song-index="2">
                                            <div class="flex items-center gap-3">
                                                <span class="drag-handle">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                        <circle cx="9" cy="6" r="1.5"></circle>
                                                        <circle cx="15" cy="6" r="1.5"></circle>
                                                        <circle cx="9" cy="12" r="1.5"></circle>
                                                        <circle cx="15" cy="12" r="1.5"></circle>
                                                        <circle cx="9" cy="18" r="1.5"></circle>
                                                        <circle cx="15" cy="18" r="1.5"></circle>
                                                    </svg>
                                                </span>
                                                <div>
                                                    <div class="text-sm font-medium text-gray-800">夜空中最亮的星</div>
                                                    <div class="text-xs text-gray-500">时长: 04:12</div>
                                                </div>
                                            </div>
                                            <button type="button" class="text-red-500 hover:text-red-600 text-sm" data-type="button">移除</button>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </form>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-between">
                            ${mode === 'edit' ? `
                            <button onclick="deleteAlbum('${id}')"
                                    class="px-6 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600" data-type="button">删除</button>
                            ` : '<div></div>'}
                            <div class="flex gap-3">
                                <button onclick="closeModal()"
                                        class="btn-secondary px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50" data-type="button">取消</button>
                                <button onclick="saveAlbum('${mode}', '${id}')"
                                        class="btn-primary px-6 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium" data-type="button">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modal;

            // 初始化艺人选择器
            selectData['album-form-artist'].selected = '';
            document.getElementById('album-form-artist-select-value').textContent = '请选择';
            document.getElementById('album-form-artist-select-value').classList.add('placeholder');
            initSelectWithSearch('album-form-artist');

            // 初始化拖拽排序（仅编辑模式）
            if (mode === 'edit') {
                setTimeout(() => initSongDragSort(), 0);
            }
        }

        // 歌曲列表拖拽排序
        function initSongDragSort() {
            const container = document.getElementById('album-song-list');
            if (!container) return;

            let draggedItem = null;

            container.querySelectorAll('.song-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    container.querySelectorAll('.song-item').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                    draggedItem = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (item !== draggedItem) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    if (draggedItem && item !== draggedItem) {
                        const allItems = [...container.querySelectorAll('.song-item')];
                        const draggedIndex = allItems.indexOf(draggedItem);
                        const targetIndex = allItems.indexOf(item);

                        if (draggedIndex < targetIndex) {
                            item.parentNode.insertBefore(draggedItem, item.nextSibling);
                        } else {
                            item.parentNode.insertBefore(draggedItem, item);
                        }

                        showToast('歌曲顺序已调整');
                    }
                });
            });
        }

        // 保存专辑
        function saveAlbum(mode, id) {
            const form = document.getElementById('album-form');
            if (!form.checkValidity()) {
                showToast('请填写所有必填项', 'error');
                return;
            }

            setTimeout(() => {
                if (mode === 'add') {
                    showToast('专辑添加成功');
                } else {
                    showToast('专辑信息已更新');
                }
                closeModal();
                renderAlbumTable();
            }, 500);
        }

        // 删除专辑
        function deleteAlbum(id) {
            openConfirmModal('确认删除该专辑？只有空专辑可以删除。', () => {
                const album = albumData.find(a => a.id === id);
                if (album && album.songCount > 0) {
                    showToast('该专辑包含歌曲，无法删除', 'error');
                } else {
                    showToast('专辑已删除');
                    closeModal();
                    renderAlbumTable();
                }
            });
        }

        // ==================== 初始化 ====================

        // 页面加载时初始化所有表格
        document.addEventListener('DOMContentLoaded', function() {
            renderApplicationTable();
            renderArtistTable();
            renderSongTable();
            renderAlbumTable();
            initAlbumArtistFilter();
            initDataCenter();
        });

        let opsInit = { ops: false, platform: false };

        function initDataCenter() {
            const agentSelects = [document.getElementById('dc-agent'), document.getElementById('ops-agent')];
            agentSelects.forEach(sel => {
                if (!sel) return;
                sel.innerHTML = '<option value="">全部经纪人</option>' + agentList.map(a => `<option>${a}</option>`).join('');
            });
            const artistNames = artistData.map(a => a.stageName);
            const artistSelects = [document.getElementById('dc-artist'), document.getElementById('ops-artist')];
            artistSelects.forEach(sel => {
                if (!sel) return;
                sel.innerHTML = '<option value="">全部艺人</option>' + artistNames.map(a => `<option>${a}</option>`).join('');
            });
            const albumSelect = document.getElementById('ops-album');
            if (albumSelect) albumSelect.innerHTML = '<option value="">专辑</option>' + albumData.map(a => `<option>${a.name}</option>`).join('');
            const songSelect = document.getElementById('ops-song');
            if (songSelect) songSelect.innerHTML = '<option value="">歌曲</option>' + songData.map(s => `<option>${s.name}</option>`).join('');
            initOverviewTab();
            initOpsTab();
            document.querySelectorAll('[data-dc-tab]').forEach(btn => {
                btn.addEventListener('click', () => switchDcTab(btn.getAttribute('data-dc-tab')));
            });
            document.querySelectorAll('[data-ops-tab]').forEach(btn => {
                btn.addEventListener('click', () => switchOpsTab(btn.getAttribute('data-ops-tab')));
            });
            const applyOverview = document.getElementById('dc-apply');
            if (applyOverview) applyOverview.addEventListener('click', () => renderOverviewChart());
            const applyOps = document.getElementById('ops-apply');
            if (applyOps) applyOps.addEventListener('click', () => { 
                if (opsInit.ops) { renderOpsCombo(); }
                if (opsInit.platform) { renderPlatformPies(); }
            });
        }

        function ensureDcVisible() {
            const ids = ['dc-overview-line','ops-combo-chart','ops-combo-chart-eur','platform-play-pie','platform-income-pie'];
            ids.forEach(id=>{ const el = document.getElementById(id); if (!el) return; const ins = echarts.getInstanceByDom(el); if (ins) ins.resize(); });
        }
        function updateFilterButtonLabel() {
            const btn = document.getElementById('ops-filter-open');
            if (!btn) return;
            const active = Object.entries(opsFilterState).some(([k, v]) => k !== 'currency' && v && v !== '全部');
            btn.textContent = active ? '已筛选' : '筛选';
        }
        function openOpsFilterModal() {
            const lists = {
                currency: ['CNY', 'EUR'],
                agent: ['全部', ...agentList],
                artist: ['全部', ...artistData.map(a=>a.stageName)],
                platform: ['全部', '网易','TME','酷狗','爱听'],
                album: ['全部', ...albumData.map(a=>a.name)],
                song: ['全部', ...songData.map(s=>s.name)]
            };
            const html = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-type="modal">
                    <div class="modal-content bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">筛选</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600" data-type="button">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="px-6 py-4 space-y-3">
                            ${Object.keys(lists).map(k=>`
                                <div class="filter-group" data-group="${k}">
                                    <div class="filter-title">${k==='currency'?'币种':k==='agent'?'经纪人':k==='artist'?'艺人':k==='platform'?'平台':k==='album'?'专辑':'歌曲'}</div>
                                    <div class="filter-options">
                                        ${k==='currency'
                                            ? lists[k].map(v=>`<div class=\"filter-option${opsFilterState.currency===v ? ' active' : ''}\" data-value=\"${v}\">${v}</div>`).join('')
                                            : lists[k].map(v=>`<div class=\"filter-option${opsFilterState[k]===v || (!opsFilterState[k] && v==='全部') ? ' active' : ''}\" data-value=\"${v}\">${v}</div>`).join('')
                                        }
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                            <button id="ops-reset" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">重置</button>
                            <button id="ops-apply-modal" class="btn-primary px-4 py-2 bg-blue-500 text-white rounded-lg text-sm">应用</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modal-container').innerHTML = html;
            document.querySelectorAll('.filter-group').forEach(group=>{
                const key = group.getAttribute('data-group');
                group.querySelectorAll('.filter-option').forEach(opt=>{
                    opt.addEventListener('click',()=>{
                        group.querySelectorAll('.filter-option').forEach(o=>o.classList.remove('active'));
                        opt.classList.add('active');
                        const val = opt.getAttribute('data-value');
                        if (key === 'currency') {
                            opsFilterState[key] = val;
                        } else {
                            opsFilterState[key] = val === '全部' ? '' : val;
                        }
                    });
                });
            });
            document.getElementById('ops-reset').addEventListener('click',()=>{
                opsFilterState = { currency:'CNY', agent:'', artist:'', platform:'', album:'', song:'' };
                document.querySelectorAll('.filter-group').forEach(group=>{
                    const key = group.getAttribute('data-group');
                    group.querySelectorAll('.filter-option').forEach(o=>o.classList.remove('active'));
                    if (key === 'currency') {
                        const cnyOpt = group.querySelector('.filter-option[data-value="CNY"]');
                        if (cnyOpt) cnyOpt.classList.add('active');
                    } else {
                        const first = group.querySelector('.filter-option'); if (first) first.classList.add('active');
                    }
                });
            });
            document.getElementById('ops-apply-modal').addEventListener('click',()=>{
                closeModal();
                updateFilterButtonLabel();
                const tab = getActiveOpsTab();
                if (tab==='ops') renderOpsCombo();
                if (tab==='platform') renderPlatformPies();
            });
            if (drillState.active && drillState.locks) {
                document.querySelectorAll('.filter-group').forEach(group=>{
                    const key = group.getAttribute('data-group');
                    const lockVal = drillState.locks[key];
                    if (lockVal) {
                        group.querySelectorAll('.filter-option').forEach(opt=>{
                            const val = opt.getAttribute('data-value');
                            if (val === lockVal) {
                                opt.classList.add('active');
                            } else {
                                opt.classList.add('disabled');
                                opt.onclick = null;
                            }
                        });
                    }
                });
            }
        }
        function getActiveOpsTab() {
            if (!document.getElementById('ops-panel').classList.contains('hidden')) return 'ops';
            return 'platform';
        }
        function computeOpsFactor(s) {
            let f = 1;
            if (s.agent) f *= 0.94;
            if (s.artist) f *= 1.06;
            if (s.album) f *= 0.97;
            if (s.song) f *= 1.05;
            if (s.platform) f *= 0.98;
            return f;
        }

        function getMetricColor(metric) {
            if (metric.includes('播放')) return '#22c55e';
            if (metric.includes('销售')) return '#f59e0b';
            if (metric.includes('下载')) return '#3b82f6';
            if (metric.includes('收入')) return '#ef4444';
            return '#64748b';
        }

        function renderOpsFilterTags() {
            const agentBox = document.getElementById('ops-group-agent');
            const artistBox = document.getElementById('ops-group-artist');
            const platformBox = document.getElementById('ops-group-platform');
            const albumBox = document.getElementById('ops-group-album');
            const songBox = document.getElementById('ops-group-song');
            if (!agentBox) return;
            agentBox.innerHTML = agentList.map(a=>`<div class="filter-option" data-value="${a}">${a}</div>`).join('');
            const artists = artistData.map(a=>a.stageName);
            artistBox.innerHTML = artists.map(a=>`<div class="filter-option" data-value="${a}">${a}</div>`).join('');
            const platforms = ['网易','TME','酷狗','爱听'];
            platformBox.innerHTML = platforms.map(a=>`<div class="filter-option" data-value="${a}">${a}</div>`).join('');
            albumBox.innerHTML = albumData.map(a=>`<div class="filter-option" data-value="${a.name}">${a.name}</div>`).join('');
            songBox.innerHTML = songData.map(a=>`<div class="filter-option" data-value="${a.name}">${a.name}</div>`).join('');

            function bindSingle(box, key){
                box.querySelectorAll('.filter-option').forEach(opt=>{
                    opt.addEventListener('click',()=>{
                        box.querySelectorAll('.filter-option').forEach(o=>o.classList.remove('active'));
                        opt.classList.add('active');
                        opsFilterState[key] = opt.getAttribute('data-value');
                    });
                });
            }
            bindSingle(agentBox, 'agent');
            bindSingle(artistBox, 'artist');
            bindSingle(platformBox, 'platform');
            bindSingle(albumBox, 'album');
            bindSingle(songBox, 'song');
        }

        function updateOpsBreadcrumb() {
            const el = document.getElementById('ops-breadcrumb');
            if (!el) return;
            let html = `<span class="cursor-pointer" id="ops-bc-root">全部数据</span>`;
            if (drillState.active && drillState.level >= 1) {
                html += ` <span>›</span> <span class="cursor-pointer" id="ops-bc-month">${drillState.month} · ${drillState.metric}</span>`;
            }
            if (drillState.active && drillState.level >= 2 && drillState.locks.agent) {
                html += ` <span>›</span> <span class="cursor-pointer" id="ops-bc-agent">经纪人：${drillState.locks.agent}</span>`;
            }
            if (drillState.active && drillState.level >= 3 && drillState.locks.artist) {
                html += ` <span>›</span> <span class="cursor-pointer" id="ops-bc-artist">艺人：${drillState.locks.artist}</span>`;
            }
            if (drillState.active && drillState.level >= 4 && drillState.locks.album) {
                html += ` <span>›</span> <span class="cursor-pointer" id="ops-bc-album">专辑：${drillState.locks.album}</span>`;
            }
            el.innerHTML = html;
            const root = document.getElementById('ops-bc-root');
            const monthNode = document.getElementById('ops-bc-month');
            const agentNode = document.getElementById('ops-bc-agent');
            const artistNode = document.getElementById('ops-bc-artist');
            const albumNode = document.getElementById('ops-bc-album');
            if (root) root.onclick = () => { resetOpsDrilldown(); };
            if (monthNode) monthNode.onclick = () => {
                if (drillState.active) { drillState.level = 1; drillState.locks = {}; renderOpsCombo(); }
            };
            if (agentNode) agentNode.onclick = () => {
                if (drillState.active && drillState.locks.agent) { drillState.level = 2; drillState.locks = { agent: drillState.locks.agent }; renderOpsCombo(); }
            };
            if (artistNode) artistNode.onclick = () => {
                if (drillState.active && drillState.locks.artist) { drillState.level = 3; drillState.locks = { agent: drillState.locks.agent, artist: drillState.locks.artist }; renderOpsCombo(); }
            };
            if (albumNode) albumNode.onclick = () => {
                if (drillState.active && drillState.locks.album) { drillState.level = 4; drillState.locks = { agent: drillState.locks.agent, artist: drillState.locks.artist, album: drillState.locks.album }; renderOpsCombo(); }
            };
        }

        function resetOpsDrilldown() {
            drillState = { active: false, level: 0, month: '', metric: '', history: [], locks: {} };
            const tab = getActiveOpsTab();
            if (tab==='ops') renderOpsCombo();
            if (tab==='platform') renderPlatformPies();
            updateOpsBreadcrumb();
        }

        function switchDcTab(tab) {
            document.getElementById('dc-overview').classList.toggle('hidden', tab !== 'overview');
            document.getElementById('dc-ops').classList.toggle('hidden', tab !== 'ops');
            document.querySelectorAll('[data-dc-tab]').forEach(btn=>{
                const isActive = btn.getAttribute('data-dc-tab') === tab;
                btn.classList.toggle('text-blue-600', isActive);
                btn.classList.toggle('border-b-2', isActive);
                btn.classList.toggle('border-blue-600', isActive);
                btn.classList.toggle('bg-blue-50', isActive);
                btn.classList.toggle('text-gray-700', !isActive);
                btn.classList.toggle('bg-transparent', !isActive);
            });
            if (tab === 'overview') {
                ensureDcVisible();
            } else if (tab === 'ops') {
                if (!opsInit.ops) { renderOpsCombo(); opsInit.ops = true; }
                ensureDcVisible();
            }
        }

        function switchOpsTab(tab) {
            document.getElementById('ops-panel').classList.toggle('hidden', tab !== 'ops');
            document.getElementById('ops-platform-panel').classList.toggle('hidden', tab !== 'platform');
            document.querySelectorAll('[data-ops-tab]').forEach(btn=>{
                const isActive = btn.getAttribute('data-ops-tab') === tab;
                btn.classList.toggle('text-blue-600', isActive);
                btn.classList.toggle('border-b-2', isActive);
                btn.classList.toggle('border-blue-600', isActive);
                btn.classList.toggle('bg-blue-50', isActive);
                btn.classList.toggle('text-gray-700', !isActive);
                btn.classList.toggle('bg-transparent', !isActive);
            });
            const resetBtn = document.getElementById('ops-reset-drill');
            if (resetBtn) resetBtn.classList.toggle('hidden', tab === 'platform');
            const breadcrumb = document.getElementById('ops-breadcrumb');
            if (breadcrumb) breadcrumb.classList.toggle('hidden', tab === 'platform');
            requestAnimationFrame(() => {
                if (tab === 'ops') {
                    if (!opsInit.ops) { renderOpsCombo(); opsInit.ops = true; }
                    const el = document.getElementById('ops-combo-chart');
                    const ins = echarts.getInstanceByDom(el); if (ins) ins.resize();
                } else if (tab === 'platform') {
                    if (!opsInit.platform) { renderPlatformPies(); opsInit.platform = true; }
                    const el1 = document.getElementById('platform-play-pie');
                    const el2 = document.getElementById('platform-income-pie');
                    const ins1 = echarts.getInstanceByDom(el1); if (ins1) ins1.resize();
                    const ins2 = echarts.getInstanceByDom(el2); if (ins2) ins2.resize();
                }
            });
        }

        function monthRange(start, end) {
            const s = start.split('-').map(Number); const e = end.split('-').map(Number);
            const res = []; let y = s[0], m = s[1];
            while (y < e[0] || (y === e[0] && m <= e[1])) { res.push(`${y}-${String(m).padStart(2,'0')}`); m++; if (m>12){m=1;y++;} }
            return res;
        }

        function defaultMonths(n) {
            const now = new Date();
            const list = [];
            for (let i = n-1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0');
                list.push(`${y}-${m}`);
            }
            return list;
        }

        function metricIcons(name) {
            const map = {
                '艺人人数':'M12 4a8 8 0 100 16 8 8 0 000-16',
                '作品数':'M4 6h16v12H4z',
                '播放量':'M3 10l18-8v16L3 10z',
                '下载量':'M4 14v2a3 3 0 003 3h10a3 3 0 003-3v-2M12 3v12m0 0l-4-4m4 4l4-4',
                '销售量':'M12 8v8m-6-4h12',
                '粉丝量':'M5 13a7 7 0 0114 0',
                '收入':'M12 3v18M7 8h6a3 3 0 010 6H9'
            };
            if (name.includes('收入')) return map['收入'];
            return map[name] || map['播放量'];
        }

        function updateOverviewFilter(metric) {
            const isDaily = ['艺人人数','作品数','粉丝量'].includes(metric);
            const dateFilter = document.getElementById('dc-date-filter');
            const monthFilter = document.getElementById('dc-month-filter');
            if (!dateFilter || !monthFilter) return;
            if (isDaily) {
                dateFilter.classList.remove('hidden');
                monthFilter.classList.add('hidden');
            } else {
                monthFilter.classList.remove('hidden');
                dateFilter.classList.add('hidden');
            }
        }

        function dayRange(start, end) {
            const s = new Date(start);
            const e = new Date(end);
            const res = [];
            let d = new Date(s.getTime());
            while (d <= e) {
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                res.push(`${y}-${m}-${day}`);
                d.setDate(d.getDate()+1);
            }
            return res;
        }

        function defaultDays(n) {
            const res = [];
            const now = new Date();
            for (let i = n-1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()-i);
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                res.push(`${y}-${m}-${day}`);
            }
            return res;
        }
        function baseValue(seed, idx) {
            return Math.round((seed + idx * 7) * (1 + Math.sin(idx/2)*0.15));
        }

        function initOverviewTab() {
            const metrics = ['艺人人数','作品数','播放量','下载量','销售量','粉丝量','收入（CNY）','收入（EUR）'];
            const container = document.getElementById('dc-metric-cards');
            container.innerHTML = metrics.map((m,i)=>`
                <div class="border border-gray-200 rounded-lg p-4 cursor-pointer" data-metric="${m}">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="${metricIcons(m)}"></path></svg>
                        <div class="text-sm text-gray-500">${m}</div>
                    </div>
                    <div class="mt-3 flex items-end gap-2">
                        <div class="text-2xl font-semibold text-gray-800">${baseValue(100+i*20,0)}</div>
                        <div class="text-xs ${i%2? 'text-green-600':'text-red-600'}">${i%2? '+3.2%':'-1.4%'} 环比</div>
                    </div>
                </div>
            `).join('');
            container.querySelectorAll('[data-metric]').forEach(card=>{
                card.addEventListener('click',()=>{ 
                    container.querySelectorAll('[data-metric]').forEach(c=>c.classList.remove('ring-2','ring-blue-400')); 
                    card.classList.add('ring-2','ring-blue-400'); 
                    const m = card.getAttribute('data-metric');
                    updateOverviewFilter(m);
                    renderOverviewChart(m);
                });
            });
            updateOverviewFilter('播放量');
            renderOverviewChart('播放量');
        }

        function renderOverviewChart(metric) {
            if (typeof echarts === 'undefined') { showToast('图表库加载失败', 'error'); return; }
            const selected = metric || (function(){ const s = document.querySelector('#dc-metric-cards .ring-2'); return s ? s.getAttribute('data-metric') : '播放量'; })();
            const isDaily = ['艺人人数','作品数','粉丝量'].includes(selected);
            let xLabels = [];
            if (isDaily) {
                const sd = document.getElementById('dc-start-date');
                const ed = document.getElementById('dc-end-date');
                xLabels = (sd && ed && sd.value && ed.value) ? dayRange(sd.value, ed.value) : defaultDays(7);
            } else {
                const sm = document.getElementById('dc-start-month');
                const em = document.getElementById('dc-end-month');
                xLabels = (sm && em && sm.value && em.value) ? monthRange(sm.value, em.value) : defaultMonths(6);
            }
            const data = xLabels.map((_,idx)=>{
                if (selected==='艺人人数') return baseValue(50,idx);
                if (selected==='作品数') return baseValue(80,idx);
                if (selected==='播放量') return baseValue(1000,idx);
                if (selected==='下载量') return baseValue(600,idx);
                if (selected==='销售量') return baseValue(400,idx);
                if (selected==='粉丝量') return baseValue(900,idx);
                if (selected==='收入（CNY）') return baseValue(300,idx);
                if (selected==='收入（EUR）') return Math.round(baseValue(300,idx)*0.13);
                return baseValue(200,idx);
            });
            const chart = echarts.init(document.getElementById('dc-overview-line'));
            chart.setOption({
                tooltip:{trigger:'axis'},
                xAxis:{type:'category',data:xLabels},
                yAxis:{type:'value'},
                series:[{type:'line',smooth:true,name:selected,data:data}]
            });
            const card = Array.from(document.querySelectorAll('#dc-metric-cards [data-metric]')).find(c=>c.getAttribute('data-metric')===selected);
            if (card) {
                const valEl = card.querySelector('.text-2xl');
                const pctEl = card.querySelector('.text-xs');
                const last = data[data.length-1] || 0;
                const prev = data[data.length-2] || last;
                const pct = prev ? ((last-prev)/prev*100) : 0;
                if (valEl) valEl.textContent = String(last);
                if (pctEl) { pctEl.textContent = `${pct>=0? '+' : ''}${pct.toFixed(1)}% 环比`; pctEl.classList.toggle('text-green-600', pct>=0); pctEl.classList.toggle('text-red-600', pct<0); }
            }
        }

        let opsFilterState = { currency: 'CNY', agent: '', artist: '', platform: '', album: '', song: '' };
        let drillState = { active: false, level: 0, month: '', metric: '', history: [], locks: {} };

        function initOpsTab() {
            const btn = document.getElementById('ops-filter-open');
            if (btn) { btn.addEventListener('click', openOpsFilterModal); }
            updateFilterButtonLabel();
        }

        function opsData(start,end,rate) {
            const months = defaultMonths(6);
            const play = months.map((_,i)=>baseValue(1200,i));
            const sale = months.map((_,i)=>baseValue(500,i));
            const download = months.map((_,i)=>baseValue(800,i));
            const income = months.map((_,i)=>Math.round(baseValue(700,i)*rate));
            return {months,play,sale,download,income};
        }

        function renderOpsCombo() {
            if (typeof echarts === 'undefined') {
                showToast('图表库加载失败', 'error');
                return;
            }
            const el = document.getElementById('ops-combo-chart');
            if (!el) return;
            const chart = echarts.init(el);

            chart.clear();

            const currency = opsFilterState.currency.toLowerCase();
            const rate = currency === 'eur' ? 0.13 : 1;
            const sm = document.getElementById('ops-start-month');
            const em = document.getElementById('ops-end-month');
            const rangeMonths = (sm && em && sm.value && em.value) ? monthRange(sm.value, em.value) : defaultMonths(6);
            const d = { months: rangeMonths, play: rangeMonths.map((_,i)=>baseValue(1200,i)), sale: rangeMonths.map((_,i)=>baseValue(500,i)), download: rangeMonths.map((_,i)=>baseValue(800,i)), income: rangeMonths.map((_,i)=>Math.round(baseValue(700,i)*rate)) };
            const f = computeOpsFactor(opsFilterState);
            if (drillState.active && drillState.metric && drillState.level === 1) {
                const monthIndex = d.months.indexOf(drillState.month);
                const mi = monthIndex >= 0 ? monthIndex : d.months.length - 1;
                const agents = agentList.slice();
                const values = agents.map((ag, i) => {
                    let base = 0;
                    if (drillState.metric === '播放量') base = baseValue(600, i);
                    else if (drillState.metric === '销售量') base = baseValue(400, i);
                    else if (drillState.metric === '下载量') base = baseValue(500, i);
                    else if (drillState.metric === '收入') base = baseValue(300, i) * rate;
                    return Math.round(base * (1 + mi * 0.03));
                });
                chart.setOption({
                    title: { text: `${drillState.month} - 经纪人 ${drillState.metric}`, left: 'center' },
                    xAxis: { type: 'category', data: agents },
                    yAxis: { name: drillState.metric, axisLabel: { formatter: '{value}' } },
                    series: [{ name: drillState.metric, type: 'bar', data: values, itemStyle: { color: getMetricColor(drillState.metric) } }],
                    tooltip: { trigger: 'axis' },
                    legend: { show: false }
                });
                chart.off('click');
                chart.on('click', function(params) {
                    const agent = params.name;
                    drillState.level = 2;
                    drillState.locks = { agent };
                    renderOpsCombo();
                });
            } else if (drillState.active && drillState.metric && drillState.level === 2) {
                const monthIndex = d.months.indexOf(drillState.month);
                const mi = monthIndex >= 0 ? monthIndex : d.months.length - 1;
                const artists = artistData.filter(a => a.agent === drillState.locks.agent).map(a => a.stageName);
                const values = artists.map((_, i) => {
                    let base = 0;
                    if (drillState.metric === '播放量') base = baseValue(300, i);
                    else if (drillState.metric === '销售量') base = baseValue(200, i);
                    else if (drillState.metric === '下载量') base = baseValue(250, i);
                    else if (drillState.metric === '收入') base = baseValue(150, i) * rate;
                    return Math.round(base * (1 + mi * 0.02));
                });
                chart.setOption({
                    title: { text: `${drillState.month} - ${drillState.locks.agent} 艺人 ${drillState.metric}`, left: 'center' },
                    xAxis: { type: 'category', data: artists },
                    yAxis: { name: drillState.metric },
                    series: [{ name: drillState.metric, type: 'bar', data: values, itemStyle: { color: getMetricColor(drillState.metric) } }],
                    tooltip: { trigger: 'axis' },
                    legend: { show: false }
                });
                chart.off('click');
                chart.on('click', function(params) {
                    const artist = params.name;
                    drillState.level = 3;
                    drillState.locks = { agent: drillState.locks.agent, artist };
                    renderOpsCombo();
                });
            } else if (drillState.active && drillState.metric && drillState.level === 3) {
                const albums = albumData.filter(a => a.artist === drillState.locks.artist).map(a => a.name);
                const values = albums.map((_, i) => {
                    let base = 0;
                    if (drillState.metric === '播放量') base = baseValue(180, i);
                    else if (drillState.metric === '销售量') base = baseValue(160, i);
                    else if (drillState.metric === '下载量') base = baseValue(140, i);
                    else if (drillState.metric === '收入') base = baseValue(120, i) * rate;
                    return Math.round(base * 1.0);
                });
                chart.setOption({
                    title: { text: `${drillState.month} - ${drillState.locks.artist} 专辑 ${drillState.metric}`, left: 'center' },
                    xAxis: { type: 'category', data: albums },
                    yAxis: { name: drillState.metric },
                    series: [{ name: drillState.metric, type: 'bar', data: values, itemStyle: { color: getMetricColor(drillState.metric) } }],
                    tooltip: { trigger: 'axis' },
                    legend: { show: false }
                });
                chart.off('click');
                chart.on('click', function(params) {
                    const album = params.name;
                    drillState.level = 4;
                    drillState.locks = { agent: drillState.locks.agent, artist: drillState.locks.artist, album };
                    renderOpsCombo();
                });
            } else if (drillState.active && drillState.metric && drillState.level === 4) {
                const songs = songData.filter(s => s.album === drillState.locks.album).map(s => s.name);
                const values = songs.map((_, i) => {
                    let base = 0;
                    if (drillState.metric === '播放量') base = baseValue(120, i);
                    else if (drillState.metric === '销售量') base = baseValue(100, i);
                    else if (drillState.metric === '下载量') base = baseValue(90, i);
                    else if (drillState.metric === '收入') base = baseValue(80, i) * rate;
                    return Math.round(base * 1.0);
                });
                chart.setOption({
                    title: { text: `${drillState.month} - ${drillState.locks.album} 歌曲 ${drillState.metric}`, left: 'center' },
                    xAxis: { type: 'category', data: songs },
                    yAxis: { name: drillState.metric },
                    series: [{ name: drillState.metric, type: 'bar', data: values, itemStyle: { color: getMetricColor(drillState.metric) } }],
                    tooltip: { trigger: 'axis' },
                    legend: { show: false }
                });
                chart.off('click');
            } else {
                const play = d.play.map(v => Math.round(v * f));
                const sale = d.sale.map(v => Math.round(v * f));
                const download = d.download.map(v => Math.round(v * f));
                const income = d.income.map(v => Math.round(v * f));

                const defaultSeries = [{
                    name: '收入(' + currency.toUpperCase() + ')',
                    type: 'line',
                    yAxisIndex: 0,
                    smooth: true,
                    data: income,
                    itemStyle: { color: getMetricColor('收入') },
                    lineStyle: { color: getMetricColor('收入') }
                }, {
                    name: '播放量',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: play,
                    itemStyle: { color: getMetricColor('播放量') }
                }, {
                    name: '销售量',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: sale,
                    itemStyle: { color: getMetricColor('销售量') }
                }, {
                    name: '下载量',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: download,
                    itemStyle: { color: getMetricColor('下载量') }
                }];

                chart.setOption({
                    title: { text: `经营情况 - ${opsFilterState.currency}`, left: 'center' },
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: ['播放量', '销售量', '下载量', '收入(' + currency.toUpperCase() + ')'],
                        top: 30,
                        right: 10
                    },
                    xAxis: [{
                        type: 'category',
                        data: d.months
                    }],
                    yAxis: [{
                        type: 'value',
                        name: '收入'
                    }, {
                        type: 'value',
                        name: '量'
                    }],
                    series: defaultSeries
                });

                chart.off('click');
                chart.on('click', function(params) {
                    const month = params.name;
                    const sn = params.seriesName || '';
                    const metric = sn.includes('播放') ? '播放量' : sn.includes('销售') ? '销售量' : sn.includes('下载') ? '下载量' : sn.includes('收入') ? '收入' : '播放量';
                    drillState = { active: true, level: 1, month, metric, history: [], locks: {} };
                    renderOpsCombo();
                });
            }
            updateOpsBreadcrumb();
        }


        function renderPlatformPies() {
            if (typeof echarts === 'undefined') { showToast('图表库加载失败', 'error'); return; }
            const platforms = ['网易','TME','酷狗','爱听'];
            let playVals = [35,30,20,15];
            let incomeVals = [40,25,20,15];
            if (opsFilterState.platform) {
                const idx = platforms.indexOf(opsFilterState.platform);
                if (idx >= 0) {
                    const restPlay = (100-60)/(platforms.length-1);
                    const restIncome = (100-60)/(platforms.length-1);
                    playVals = platforms.map((_,i)=> i===idx?60:restPlay);
                    incomeVals = platforms.map((_,i)=> i===idx?60:restIncome);
                }
            }
            const playChart = echarts.init(document.getElementById('platform-play-pie'));
            const incomeChart = echarts.init(document.getElementById('platform-income-pie'));
            playChart.setOption({
                tooltip:{trigger:'item'},
                legend:{orient:'vertical',left:'left'},
                series:[{type:'pie',radius:['40%','70%'],label:{formatter:'{b}: {d}%'},data:platforms.map((p,i)=>({name:p,value:playVals[i]}))}]
            });
            incomeChart.setOption({
                tooltip:{trigger:'item'},
                legend:{orient:'vertical',left:'left'},
                series:[{type:'pie',radius:['40%','70%'],label:{formatter:'{b}: {d}%'},data:platforms.map((p,i)=>({name:p,value:incomeVals[i]}))}]
            });
            [playChart,incomeChart].forEach(ch=>{ ch.off('click'); });
        }
        // ==================== 导入数据功能 ====================
        
        // 导入状态管理
        const importState = {
            currentStep: 1,
            files: [], // 多文件支持: [{name, status: 'success'|'error', errorType, errorData}]
            workbook: null,
            platform: '',
            mapping: {
                period: [],
                artist: [], // 现在支持多个映射，每个可以有自己的分隔符
                album: [],
                song: [],
                play: [],
                download: [],
                sale: [],
                incomeC: [],
                incomeE: []
            },
            artistSeparators: {}, // 存储每个艺人字段映射的分隔符
            simulationResults: [],
            importedData: []
        };

        // 文件错误演示数据
        const fileErrorDemoData = {
            'duplicate': {
                title: '当前表格重复数据',
                content: `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="font-medium text-red-800 mb-2">工作表[明细表-爱听]发现重复数据，请勘正：</p>
                    <div class="text-sm text-gray-700 space-y-1 font-mono">
                        <p>excel行[44]，结算期间=20220601-20220630, 平台=爱听, 类型=VIVO, 专辑名=FRX872128756, 歌曲名=力哥,昊昊HOHO, 歌手名=昊昊，歌曲付费状态=2，广告收入分成-使用量=<span class="text-red-600 font-bold">1</span></p>
                        <p>excel行[45]，结算期间=20220601-20220630, 平台=爱听, 类型=VIVO, 专辑名=FRX872128756, 歌曲名=力哥,昊昊HOHO, 歌手名=昊昊，歌曲付费状态=2，广告收入分成-使用量=<span class="text-red-600 font-bold">10</span></p>
                    </div>
                    <hr class="my-3 border-red-200">
                    <p class="font-medium text-red-800 mb-2">工作表[明细表-爱看]发现重复数据：</p>
                    <div class="text-sm text-gray-700 space-y-1 font-mono">
                        <p>excel行[63]，结算期间=20220601-20220630, 平台=爱听, 类型=VIVO, 专辑名=FRX872128756, 歌曲名=力哥,昊昊HOHO, 歌手名=昊昊，歌曲付费状态=2，广告收入分成-使用量=<span class="text-red-600 font-bold">1</span></p>
                        <p>excel行[67]，结算期间=20220601-20220630, 平台=爱听, 类型=VIVO, 专辑名=FRX872128756, 歌曲名=力哥,昊昊HOHO, 歌手名=昊昊，歌曲付费状态=2，广告收入分成-使用量=<span class="text-red-600 font-bold">10</span></p>
                    </div>
                </div>`
            },
            'structure': {
                title: '表格结构错误',
                content: `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="font-medium text-red-800 mb-2">工作表缺少必需字段：</p>
                    <div class="text-sm text-gray-700">
                        <ul class="list-disc list-inside space-y-1">
                            <li>结算期间</li>
                            <li>歌曲名</li>
                            <li>歌手名</li>
                        </ul>
                    </div>
                </div>`
            },
            'inventory': {
                title: '跟库存表格数据重复',
                content: `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="font-medium text-red-800 mb-2">跟库存表格{库存文件名.xlsx}的数据重复：</p>
                    <div class="text-sm text-gray-700 space-y-1 font-mono">
                        <p>excel{库存文件名.xlsx}的行[63]，结算期间=20220601-20220630, 平台=爱听, 类型=VIVO, 专辑名=FRX872128756, 歌曲名=力哥,昊昊HOHO, 歌手名=昊昊，歌曲付费状态=2，广告收入分成-使用量=<span class="text-red-600 font-bold">1</span></p>
                        <p>excel{当前文件名.xlsx}的行[67]，结算期间=20220601-20220630, 平台=爱听, 类型=VIVO, 专辑名=FRX872128756, 歌曲名=力哥,昊昊HOHO, 歌手名=昊昊，歌曲付费状态=2，广告收入分成-使用量=<span class="text-red-600 font-bold">10</span></p>
                    </div>
                </div>`
            }
        };

        // 系统预设字段配置
        const systemFields = [
            { key: 'period', name: '结算期', required: true },
            { key: 'artist', name: '艺人', required: true },
            { key: 'album', name: '专辑名', required: false },
            { key: 'song', name: '歌曲名', required: true },
            { key: 'play', name: '播放量', required: false },
            { key: 'download', name: '下载量', required: false },
            { key: 'sale', name: '销售量', required: false },
            { key: 'incomeC', name: '收入(CNY)', required: false },
            { key: 'incomeE', name: '收入(EUR)', required: false }
        ];

        const fakeImportHistory = [
            {
                fileName: '平台A-统计.xlsx',
                sheetCount: 2,
                operator: '张经纪',
                importTime: '2025-01-20 10:15',
                rolledBack: false,
                results: [
                    { currency: 'CNY', song: '歌曲1', period: '202501', artist: 'aaa', play: 800, download: 100, sale: 45, income: 6000 },
                    { currency: 'EUR', song: '歌曲1', period: '202501', artist: 'aaa', play: 600, download: 80, sale: 40, income: 600 }
                ]
            },
            {
                fileName: '平台B-明细.xlsx',
                sheetCount: 3,
                operator: '李经纪',
                importTime: '2025-01-18 09:42',
                rolledBack: true,
                results: [
                    { currency: 'CNY', song: '歌曲2', period: '202501', artist: 'bbb', play: 1000, download: 120, sale: 60, income: 8200 },
                    { currency: 'EUR', song: '歌曲2', period: '202502', artist: 'bbb', play: 400, download: 60, sale: 30, income: 400 }
                ]
            },
            {
                fileName: '平台C-汇总.xlsx',
                sheetCount: 1,
                operator: '王经纪',
                importTime: '2025-01-16 16:28',
                rolledBack: false,
                results: [
                    { currency: 'CNY', song: '歌曲3', period: '202501', artist: 'ccc', play: 500, download: 50, sale: 20, income: 3000 }
                ]
            }
        ];

        // 模拟Excel文件读取（使用假数据）
        function fakeWorkbook() {
            return {
                sheets: [
                    {
                        name: '平台A-月报',
                        headers: ['月份(yyyymmdd)', '歌曲', '艺人(多人用/分隔)', '专辑', '播放', '下载', '销售', '收入CNY', '收入EUR'],
                        rows: [
                            ['20250101', '歌曲1', 'aaa/bbb', '专辑X', 600, 80, 40, 5000, 600],
                            ['20250115', '歌曲2', 'bbb', '专辑Y', 400, 60, 30, 3000, 400],
                            ['20250201', '歌曲1', 'aaa', '专辑X', 400, 20, 10, 3000, 300]
                        ]
                    },
                    {
                        name: '平台B-明细',
                        headers: ['结算期(yyyymmdd-yyyymmdd)', '歌名', '艺人', '专辑名', '播放数', '下载数', '销量', '收入(RMB)', '收入(EUR)'],
                        rows: [
                            ['20250101-20250131', '歌曲1', 'aaa', '专辑X', 400, 20, 10, 3000, 300],
                            ['20250101-20250131', '歌曲2', 'bbb', '专辑Y', 600, 40, 20, 5000, 500],
                            ['20250201-20250228', '歌曲2', 'bbb', '专辑Y', 400, 60, 30, 3000, 400]
                        ]
                    }
                ]
            };
        }

        // 步骤切换
        function updateImportStep(step) {
            importState.currentStep = step;
            
            // 更新步骤条样式
            document.querySelectorAll('.step-item').forEach(item => {
                const itemStep = parseInt(item.getAttribute('data-step'));
                const circle = item.querySelector('.step-circle');
                const text = item.querySelector('.step-text');
                
                if (itemStep === step) {
                    circle.classList.remove('bg-gray-300', 'text-gray-600');
                    circle.classList.add('bg-blue-600', 'text-white');
                    text.classList.remove('text-gray-600');
                    text.classList.add('text-blue-600', 'font-medium');
                } else if (itemStep < step) {
                    circle.classList.remove('bg-gray-300', 'text-gray-600', 'bg-blue-600');
                    circle.classList.add('bg-green-600', 'text-white');
                    text.classList.remove('text-blue-600', 'font-medium');
                    text.classList.add('text-gray-600');
                } else {
                    circle.classList.remove('bg-blue-600', 'bg-green-600', 'text-white');
                    circle.classList.add('bg-gray-300', 'text-gray-600');
                    text.classList.remove('text-blue-600', 'font-medium');
                    text.classList.add('text-gray-600');
                }
            });

            // 显示对应步骤内容
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`import-step-${step}`).classList.remove('hidden');

            // 更新按钮状态
            const prevBtn = document.getElementById('prev-step');
            const nextBtn = document.getElementById('next-step');
            
            // 第一步隐藏上一步按钮
            prevBtn.style.display = step === 1 ? 'none' : 'block';
            prevBtn.disabled = step === 1;
            const actions = document.getElementById('import-actions');
            if (actions) {
                if (step === 1) {
                    actions.classList.remove('justify-between');
                    actions.classList.add('justify-end');
                } else {
                    actions.classList.remove('justify-end');
                    actions.classList.add('justify-between');
                }
            }
            
            if (step === 1) {
                // 需要：有文件 + 选择了平台 + 没有错误文件
                const hasFiles = importState.files.length > 0;
                const hasNoErrors = !importState.files.some(f => f.status === 'error');
                const hasPlatform = importState.platform !== '';
                nextBtn.disabled = !(hasFiles && hasNoErrors && hasPlatform);
                nextBtn.textContent = '下一步';
                nextBtn.style.display = 'block';
            } else if (step === 2) {
                nextBtn.disabled = false;
                nextBtn.textContent = '确认导入';
                nextBtn.style.display = 'block';
            } else if (step === 3) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                nextBtn.style.display = 'none';
            }
        }

        // 检查映射是否有效
        function isMappingValid() {
            const requiredFields = systemFields.filter(f => f.required);
            return requiredFields.every(field => importState.mapping[field.key].length > 0);
        }

        // 渲染字段映射界面
        function renderMappingStep() {
            if (!importState.workbook) return;
            
            // 渲染系统字段映射列表
            const systemFieldsList = document.getElementById('system-fields-list');
            systemFieldsList.innerHTML = '';
            
            systemFields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'bg-gray-50 rounded-lg p-3 border';
                fieldDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-sm font-medium ${field.required ? 'text-red-600' : 'text-gray-700'}">${field.name}</span>
                            ${field.required ? '<span class="text-xs text-red-500 ml-1">*</span>' : ''}
                        </div>
                        <button onclick="openFieldSelectionModal('${field.key}', '${field.name}')" 
                                class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                            添加映射
                        </button>
                    </div>
                    <div id="mapping-display-${field.key}" class="space-y-2">
                        <!-- 动态显示已映射的字段 -->
                    </div>
                `;
                systemFieldsList.appendChild(fieldDiv);
            });
            
            updateMappingDisplay();
        }

        // 更新映射显示

        // 更新映射显示
        function updateMappingDisplay() {
            systemFields.forEach(field => {
                const displayContainer = document.getElementById(`mapping-display-${field.key}`);
                if (!displayContainer) return;
                
                displayContainer.innerHTML = '';
                
                importState.mapping[field.key].forEach((mapping, index) => {
                    const mappingDiv = document.createElement('div');
                    mappingDiv.className = 'flex items-center justify-between bg-white p-2 rounded border text-sm';
                    
                    if (field.key === 'artist') {
                        // 艺人字段显示分隔符输入框
                        mappingDiv.innerHTML = `
                            <span class="text-gray-700">${mapping.sheet} ▸ ${mapping.header}</span>
                            <div class="flex items-center space-x-2">
                                <input type="text" value="${importState.artistSeparators[`${mapping.sheet}-${mapping.header}`] || '/'}" 
                                       onchange="updateArtistSeparator('${mapping.sheet}', '${mapping.header}', this.value)"
                                       class="w-12 px-2 py-1 border border-gray-300 rounded text-xs" placeholder="分隔符">
                                <button onclick="removeMapping('${field.key}', ${index})" class="text-red-600 hover:text-red-800 text-xs">删除</button>
                            </div>
                        `;
                    } else {
                        mappingDiv.innerHTML = `
                            <span class="text-gray-700">${mapping.sheet} ▸ ${mapping.header}</span>
                            <button onclick="removeMapping('${field.key}', ${index})" class="text-red-600 hover:text-red-800 text-xs">删除</button>
                        `;
                    }
                    
                    displayContainer.appendChild(mappingDiv);
                });
                
                if (importState.mapping[field.key].length === 0) {
                    displayContainer.innerHTML = '<div class="text-gray-500 text-sm">暂无映射字段</div>';
                }
            });
            
            updateImportStep(importState.currentStep);
        }

        // 打开字段选择模态框
        let currentFieldKey = null;
        let currentFieldName = null;
        
        function openFieldSelectionModal(fieldKey, fieldName) {
            currentFieldKey = fieldKey;
            currentFieldName = fieldName;
            
            document.getElementById('field-selection-title').textContent = `为「${fieldName}」选择映射字段`;
            
            const contentContainer = document.getElementById('field-selection-content');
            contentContainer.innerHTML = '';
            
            importState.workbook.sheets.forEach(sheet => {
                const sheetDiv = document.createElement('div');
                sheetDiv.className = 'mb-4';
                sheetDiv.innerHTML = `
                    <h4 class="text-sm font-medium text-gray-800 mb-2">${sheet.name}</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        ${sheet.headers.map(header => {
                            const isMapped = importState.mapping[fieldKey].some(m => m.sheet === sheet.name && m.header === header);
                            return `
                                <label class="flex items-center p-1 border rounded hover:bg-gray-50 cursor-pointer text-xs">
                                    <input type="checkbox" class="mr-2 field-selection-checkbox" 
                                           data-sheet="${sheet.name}" data-header="${header}" 
                                           ${isMapped ? 'checked' : ''}>
                                    <span class="text-xs text-gray-700">${header}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
                contentContainer.appendChild(sheetDiv);
            });
            
            document.getElementById('field-selection-modal').classList.remove('hidden');
        }

        // 关闭字段选择模态框
        function closeFieldSelectionModal() {
            document.getElementById('field-selection-modal').classList.add('hidden');
            currentFieldKey = null;
            currentFieldName = null;
        }

        // 确认字段选择
        function confirmFieldSelection() {
            if (!currentFieldKey) return;
            
            // 清空当前映射
            importState.mapping[currentFieldKey] = [];
            
            // 收集选中的字段
            document.querySelectorAll('.field-selection-checkbox:checked').forEach(checkbox => {
                const sheet = checkbox.getAttribute('data-sheet');
                const header = checkbox.getAttribute('data-header');
                importState.mapping[currentFieldKey].push({ sheet, header });
                
                // 如果是艺人字段，初始化分隔符
                if (currentFieldKey === 'artist') {
                    const separatorKey = `${sheet}-${header}`;
                    if (!importState.artistSeparators[separatorKey]) {
                        importState.artistSeparators[separatorKey] = '/';
                    }
                }
            });
            
            updateMappingDisplay();
            closeFieldSelectionModal();
        }

        // 删除映射
        function removeMapping(fieldKey, index) {
            const mapping = importState.mapping[fieldKey][index];
            
            // 如果是艺人字段，同时删除分隔符
            if (fieldKey === 'artist') {
                const separatorKey = `${mapping.sheet}-${mapping.header}`;
                delete importState.artistSeparators[separatorKey];
            }
            
            importState.mapping[fieldKey].splice(index, 1);
            updateMappingDisplay();
        }

        // 更新艺人分隔符
        function updateArtistSeparator(sheet, header, separator) {
            const separatorKey = `${sheet}-${header}`;
            importState.artistSeparators[separatorKey] = separator;
        }

        // 更新映射计数显示
        function updateMappingCount(fieldKey) {
            const countElement = document.getElementById(`mapping-count-${fieldKey}`);
            if (countElement) {
                countElement.textContent = `${importState.mapping[fieldKey].length} 个字段`;
            }
        }

        // 模拟导入数据处理
        function simulateImport() {
            // 获取平台显示名称
            const platformNames = {
                'netease': '网易',
                'tme': 'TME',
                'bytedance': '字节',
                'kugou': '酷狗',
                'aiting': '爱听'
            };
            const platformName = platformNames[importState.platform] || importState.platform;

            importState.simulationResults = [
                { currency: 'CNY', platform: platformName, channel: 'APP', song: '歌曲1', period: '202501', artist: 'aaa', play: 1000, download: 100, sale: 50, income: 8000 },
                { currency: 'EUR', platform: platformName, channel: 'WEB', song: '歌曲1', period: '202501', artist: 'aaa', play: 600, download: 80, sale: 40, income: 600 },
                { currency: 'CNY', platform: platformName, channel: 'APP', song: '歌曲2', period: '202501', artist: 'bbb', play: 1000, download: 100, sale: 50, income: 8000 },
                { currency: 'EUR', platform: platformName, channel: 'H5', song: '歌曲2', period: '202502', artist: 'bbb', play: 400, download: 60, sale: 30, income: 400 }
            ];
            renderSimulationResults();
        }

        // 渲染模拟结果
        function renderSimulationResults() {
            const tbody = document.getElementById('simulation-results');
            tbody.innerHTML = importState.simulationResults.map(result => `
                <tr class="table-row">
                    <td class="px-4 py-3 text-sm text-gray-800">${result.currency}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.platform}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.channel}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.song}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.period}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.artist}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.play.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.download.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.sale.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${result.income.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // 执行导入
        function finalizeImport() {
            // 显示进度条
            document.getElementById('import-progress').classList.remove('hidden');
            document.getElementById('import-success').classList.add('hidden');

            let progress = 0;
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 90) progress = 90;

                progressBar.style.width = `${progress}%`;

                if (progress < 30) {
                    progressText.textContent = '正在验证数据格式...';
                } else if (progress < 60) {
                    progressText.textContent = '正在处理数据...';
                } else if (progress < 90) {
                    progressText.textContent = '正在写入数据库...';
                }

                if (progress >= 90) {
                    clearInterval(interval);
                    setTimeout(() => {
                        progressBar.style.width = '100%';
                        progressText.textContent = '导入完成！';

                        setTimeout(() => {
                            document.getElementById('import-progress').classList.add('hidden');
                            document.getElementById('import-success').classList.remove('hidden');

                            // 存储导入的数据（模拟）
                            const fileNames = importState.files.map(f => f.name).join(', ');
                            importState.importedData.push({
                                platform: importState.platform,
                                results: [...importState.simulationResults],
                                importTime: new Date().toISOString(),
                                fileName: fileNames || '未知文件',
                                sheetCount: importState.workbook ? importState.workbook.sheets.length : 0,
                                operator: typeof currentAdmin !== 'undefined' ? currentAdmin : '系统管理员',
                                rolledBack: false
                            });

                            // 更新按钮
                            const nextBtn = document.getElementById('next-step');
                            nextBtn.textContent = '继续导入';
                            nextBtn.disabled = false;
                            nextBtn.style.display = 'inline-block';
                            
                            showToast('数据导入成功！', 'success');
                        }, 500);
                    }, 500);
                }
            }, 200);
        }

        // 绑定导入数据相关事件
        function initImportData() {
            // 文件上传
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                // 模拟处理每个文件，分配不同的状态用于演示
                const errorTypes = ['duplicate', 'structure', 'inventory'];
                const initialFilesCount = importState.files.length;
                const totalFilesAfterUpload = initialFilesCount + files.length;

                files.forEach((file, index) => {
                    // 检查文件类型
                    if (!file.name.endsWith('.xlsx')) {
                        showToast(`${file.name} 请选择 .xlsx 格式的文件`, 'error');
                        return;
                    }

                    if (file.size > 10 * 1024 * 1024) {
                        showToast(`${file.name} 文件大小不能超过 10MB`, 'error');
                        return;
                    }

                    // 模拟错误分配逻辑：
                    // 当总文件数≥4时，演示完整场景：1成功3错误
                    // 第1个成功，第2-4个分别展示三种错误类型
                    const fileIndex = initialFilesCount + index;
                    let status = 'success';
                    let errorType = null;

                    if (totalFilesAfterUpload >= 4) {
                        // 完整演示模式：第1个成功，第2/3/4个分别是三种错误
                        if (fileIndex === 1) {
                            status = 'error';
                            errorType = 'duplicate'; // 当前表格重复数据
                        } else if (fileIndex === 2) {
                            status = 'error';
                            errorType = 'structure'; // 表格结构错误
                        } else if (fileIndex === 3) {
                            status = 'error';
                            errorType = 'inventory'; // 跟库存表格数据重复
                        }
                    } else {
                        // 简单演示模式：第2个文件有错误
                        if (fileIndex === 1) {
                            status = 'error';
                            errorType = 'duplicate';
                        }
                    }

                    const fileData = {
                        name: file.name,
                        size: file.size,
                        status: status,
                        errorType: errorType
                    };
                    importState.files.push(fileData);
                });

                // 渲染文件列表
                renderFileList();

                // 模拟读取Excel文件
                setTimeout(() => {
                    importState.workbook = fakeWorkbook();
                    showToast('文件上传完成！', 'success');
                    updateImportStep(importState.currentStep);
                }, 500);

                // 清空input以便重复上传
                fileInput.value = '';
            });

            // 平台选择变化
            const platformSelect = document.getElementById('import-platform-select');
            if (platformSelect) {
                platformSelect.addEventListener('change', function() {
                    importState.platform = this.value;
                    updateImportStep(importState.currentStep);
                });
            }

            // 步骤按钮
            document.getElementById('prev-step').addEventListener('click', function() {
                if (importState.currentStep > 1) {
                    updateImportStep(importState.currentStep - 1);
                }
            });

            document.getElementById('next-step').addEventListener('click', function() {
                if (importState.currentStep === 3) {
                    // 继续导入：重置流程并回到第一步
                    resetImportFlow();
                    updateImportStep(1);
                    return;
                }

                // Step 1: 需要选择平台 + 有文件 + 没有错误文件
                const hasFiles = importState.files.length > 0;
                const hasNoErrors = !importState.files.some(f => f.status === 'error');
                const hasPlatform = importState.platform !== '';

                if (importState.currentStep === 1 && hasFiles && hasNoErrors && hasPlatform) {
                    updateImportStep(2);
                    simulateImport();
                } else if (importState.currentStep === 2) {
                    updateImportStep(3);
                    finalizeImport();
                }
            });

            // 重置导入流程
            function resetImportFlow() {
                importState.currentStep = 1;
                importState.files = [];
                importState.workbook = null;
                importState.platform = '';
                importState.mapping = {
                    period: [],
                    artist: [],
                    album: [],
                    song: [],
                    play: [],
                    download: [],
                    sale: [],
                    incomeC: [],
                    incomeE: []
                };
                importState.artistSeparators = {};
                importState.simulationResults = [];

                const fileInput = document.getElementById('file-input');
                if (fileInput) fileInput.value = '';
                const fileList = document.getElementById('file-list');
                if (fileList) fileList.innerHTML = '';
                const platformSelect = document.getElementById('import-platform-select');
                if (platformSelect) platformSelect.value = '';
                const progress = document.getElementById('import-progress');
                if (progress) progress.classList.remove('hidden');
                const success = document.getElementById('import-success');
                if (success) success.classList.add('hidden');
                const simBody = document.getElementById('simulation-results');
                if (simBody) simBody.innerHTML = '';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0 || bytes == null) return '0 B';
            const k = 1024;
            const sizes = ['B','KB','MB','GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const val = (bytes / Math.pow(k, i));
            return `${val.toFixed(val >= 100 ? 0 : 1)} ${sizes[i]}`;
        }

        // 渲染文件列表
        function renderFileList() {
            const container = document.getElementById('file-list');
            if (!container) return;

            container.innerHTML = importState.files.map((file, index) => `
                <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center">
                        ${file.status === 'success' ? `
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        ` : `
                            <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `}
                        <span class="text-sm font-medium ${file.status === 'error' ? 'text-red-700' : 'text-gray-700'}">${file.name}</span>
                        <span class="ml-3 text-xs text-gray-500">${formatBytes(file.size)}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${file.status === 'error' ? `
                            <button onclick="showFileErrorDetail(${index})" class="text-blue-600 hover:text-blue-700 text-sm" data-type="button">详情</button>
                        ` : ''}
                        <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-700 text-sm" data-type="button">移除</button>
                    </div>
                </div>
            `).join('');
        }

        // 移除文件
        function removeFile(index) {
            importState.files.splice(index, 1);
            renderFileList();
            updateImportStep(importState.currentStep);
        }

        // 显示文件错误详情
        function showFileErrorDetail(index) {
            const file = importState.files[index];
            if (!file || !file.errorType) return;

            const errorData = fileErrorDemoData[file.errorType];
            if (!errorData) return;

            document.getElementById('file-error-modal-title').textContent = file.name + ' - ' + errorData.title;
            document.getElementById('file-error-content').innerHTML = errorData.content;
            document.getElementById('file-error-modal').classList.remove('hidden');
        }

        // 关闭文件错误详情模态框
        function closeFileErrorModal() {
            document.getElementById('file-error-modal').classList.add('hidden');
        }

        // ==================== 采集预设功能 ====================

        // 预设字段数据
        const presetFieldsData = [
            { name: '渠道商', features: ['渠道商'], purpose: '映射', required: false },
            { name: '结算期', features: ['结算期间'], purpose: '映射', required: true },
            { name: '艺人名', features: ['歌手名'], purpose: '映射', required: true },
            { name: '艺人分隔符', features: [','], purpose: '分隔符', required: true },
            { name: '歌曲名', features: ['歌曲名'], purpose: '映射', required: true },
            { name: '专辑名', features: ['专辑'], purpose: '映射', required: false },
            { name: '播放量', features: ['播放量'], purpose: '求和', required: false },
            { name: '下载量', features: ['总下载量'], purpose: '求和', required: false },
            { name: '销售量', features: ['IOS销量'], purpose: '求和', required: false },
            { name: '收入(CNY)', features: ['CP分成收入'], purpose: '求和', required: false },
            { name: '收入(EUR)', features: ['CP分成收入'], purpose: '求和', required: false }
        ];

        // 平台保留字
        let platformTags = ['网易', 'TME', '字节'];

        // 打开采集预设模态框
        function openCollectionPresetModal() {
            renderPresetFieldsTable();
            renderPlatformTags();
            document.getElementById('collection-preset-modal').classList.remove('hidden');
        }

        // 关闭采集预设模态框
        function closeCollectionPresetModal() {
            document.getElementById('collection-preset-modal').classList.add('hidden');
        }

        // 渲染预设字段表格
        function renderPresetFieldsTable() {
            const tbody = document.getElementById('preset-fields-table');
            tbody.innerHTML = presetFieldsData.map((field, index) => `
                <tr>
                    <td class="px-4 py-2 text-sm align-top">
                        <span class="${field.required ? 'text-red-600' : 'text-gray-700'}">
                            ${field.required ? '*' : ''}${field.name}
                        </span>
                    </td>
                    <td class="px-4 py-2 align-top">
                        <div class="space-y-2">
                            <div class="flex flex-wrap gap-1">
                                ${field.features.map((feature, fIndex) => `
                                    <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-50 text-blue-700 text-xs rounded">
                                        ${feature}
                                        <button onclick="removeFieldFeature(${index}, ${fIndex})" class="text-blue-400 hover:text-red-500" data-type="button">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </span>
                                `).join('')}
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="text" id="feature-input-${index}" placeholder="添加特征"
                                       class="flex-1 h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                       onkeypress="if(event.key==='Enter'){addFieldFeature(${index});event.preventDefault();}">
                                <button onclick="addFieldFeature(${index})" class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded hover:bg-gray-200" data-type="button">+</button>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-2 align-top">
                        <select onchange="updatePresetField(${index}, 'purpose', this.value)"
                                class="w-full h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                            <option value="映射" ${field.purpose === '映射' ? 'selected' : ''}>映射</option>
                            <option value="求和" ${field.purpose === '求和' ? 'selected' : ''}>求和</option>
                            <option value="分隔符" ${field.purpose === '分隔符' ? 'selected' : ''}>分隔符</option>
                        </select>
                    </td>
                    <td class="px-4 py-2 text-center align-top">
                        <button onclick="deletePresetField(${index})"
                                class="text-red-500 hover:text-red-600 p-1"
                                title="删除" data-type="button">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 添加字段特征
        function addFieldFeature(fieldIndex) {
            const input = document.getElementById(`feature-input-${fieldIndex}`);
            const value = input.value.trim();
            if (value && !presetFieldsData[fieldIndex].features.includes(value)) {
                presetFieldsData[fieldIndex].features.push(value);
                renderPresetFieldsTable();
            }
            input.value = '';
        }

        // 删除字段特征
        function removeFieldFeature(fieldIndex, featureIndex) {
            presetFieldsData[fieldIndex].features.splice(featureIndex, 1);
            renderPresetFieldsTable();
        }

        // 更新预设字段
        function updatePresetField(index, key, value) {
            presetFieldsData[index][key] = value;
        }

        // 删除预设字段
        function deletePresetField(index) {
            presetFieldsData.splice(index, 1);
            renderPresetFieldsTable();
        }

        // 添加预设字段
        function addPresetField() {
            const input = document.getElementById('new-field-name-input');
            const fieldName = input.value.trim();
            if (!fieldName) {
                showToast('请输入字段名称', 'error');
                return;
            }
            presetFieldsData.push({
                name: fieldName,
                features: [],
                purpose: '映射',
                required: false
            });
            input.value = '';
            renderPresetFieldsTable();
        }

        // 渲染平台标签
        function renderPlatformTags() {
            const container = document.getElementById('platform-tags-container');
            container.innerHTML = platformTags.map((tag, index) => `
                <span class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">
                    ${tag}
                    <button onclick="removePlatformTag(${index})" class="text-gray-400 hover:text-red-500" data-type="button">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </span>
            `).join('');
        }

        // 添加平台标签
        function addPlatformTag() {
            const input = document.getElementById('new-platform-input');
            const value = input.value.trim();
            if (value && !platformTags.includes(value)) {
                platformTags.push(value);
                renderPlatformTags();
                input.value = '';
            }
        }

        // 删除平台标签
        function removePlatformTag(index) {
            platformTags.splice(index, 1);
            renderPlatformTags();
        }

        // 保存采集预设
        function saveCollectionPreset() {
            showToast('采集预设已保存', 'success');
            closeCollectionPresetModal();
        }

        function renderImportHistoryTable() {
            const tbody = document.getElementById('import-history-table-body');
            if (!tbody) return;
            tbody.innerHTML = (fakeImportHistory || []).map((item, index) => `
                <tr>
                    <td class="px-6 py-3 text-sm text-gray-800">${item.fileName || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-800">${item.sheetCount || 0}</td>
                    <td class="px-6 py-3 text-sm text-gray-800">
                        <button class="text-blue-600 hover:text-blue-800" onclick="openHistoryModal(${index})" aria-label="查看详情">
                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </td>
                    <td class="px-6 py-3 text-sm text-gray-800">${item.operator || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-800">${item.importTime || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-800">
                        ${item.rolledBack ? `<span class=\"text-gray-500\">已回滚</span>` : `<button class=\"px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50\" onclick=\"rollbackImport(${index})\">回滚</button>`}
                    </td>
                </tr>
            `).join('');
        }

        function openHistoryModal(index) {
            const item = fakeImportHistory[index];
            if (!item) return;
            document.getElementById('import-history-modal-title').textContent = `${item.fileName || ''} · ${item.importTime || ''}`;
            const container = document.getElementById('history-detail-content');
            const rows = item.results || [];
            container.innerHTML = `
                <div class=\"overflow-x-auto\">
                    <table class=\"w-full\">
                        <thead class=\"bg-gray-50\">
                            <tr>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">币种</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">歌曲</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">结算期</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">艺人</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">播放</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">下载</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">销售</th>
                                <th class=\"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase\">收入</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(r => `
                                <tr>
                                    <td class=\"px-4 py-3 text-sm\">${r.currency}</td>
                                    <td class=\"px-4 py-3 text-sm\">${r.song}</td>
                                    <td class=\"px-4 py-3 text-sm\">${r.period}</td>
                                    <td class=\"px-4 py-3 text-sm\">${r.artist}</td>
                                    <td class=\"px-4 py-3 text-sm\">${Number(r.play).toLocaleString()}</td>
                                    <td class=\"px-4 py-3 text-sm\">${Number(r.download).toLocaleString()}</td>
                                    <td class=\"px-4 py-3 text-sm\">${Number(r.sale).toLocaleString()}</td>
                                    <td class=\"px-4 py-3 text-sm\">${Number(r.income).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('import-history-modal').classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('import-history-modal').classList.add('hidden');
        }

        function rollbackImport(index) {
            const item = fakeImportHistory[index];
            if (!item || item.rolledBack) return;
            item.rolledBack = true;
            renderImportHistoryTable();
            showToast('已回滚', 'success');
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            initDatePickers();
            const dcApply = document.getElementById('dc-apply-range');
            if (dcApply) dcApply.addEventListener('click', ()=>{ renderOverviewChart(); });
            const opsApply = document.getElementById('ops-apply-range');
            if (opsApply) opsApply.addEventListener('click', ()=>{ const tab = getActiveOpsTab(); if (tab==='ops') renderOpsCombo(); else renderPlatformPies(); });
            const resetBtn = document.getElementById('ops-reset-drill');
            if (resetBtn) resetBtn.addEventListener('click', resetOpsDrilldown);
            
            // 初始化导入数据功能
            initImportData();
            
            switchOpsTab('cny');
        });

        function initDatePickers() {
            if (typeof flatpickr === 'undefined') return;
            const zh = (window.flatpickr && window.flatpickr.l10ns) ? window.flatpickr.l10ns.zh : undefined;
            const optsDay = { dateFormat: 'Y-m-d', altInput: true, altFormat: 'Y-m-d', allowInput: true, locale: zh };
            const optsMonth = { dateFormat: 'Y-m', altInput: true, altFormat: 'Y-m', allowInput: true, locale: zh, plugins: [new monthSelectPlugin({ shorthand: true, dateFormat: 'Y-m', altFormat: 'Y-m' })] };
            const idsDay = ['#dc-start-date', '#dc-end-date'];
            const idsMonth = ['#dc-start-month', '#dc-end-month', '#ops-start-month', '#ops-end-month'];
            idsDay.forEach(sel=>{ const el = document.querySelector(sel); if (el) flatpickr(el, optsDay); });
            idsMonth.forEach(sel=>{ const el = document.querySelector(sel); if (el) flatpickr(el, optsMonth); });
            document.querySelectorAll('input[type="date"]').forEach(el=>{ if (!el._flatpickr) flatpickr(el, optsDay); });
            document.querySelectorAll('#dc-start-month, #dc-end-month, #ops-start-month, #ops-end-month').forEach(el=>{ if (!el._flatpickr) flatpickr(el, optsMonth); });
        }
    </script>
</body>
</html>
