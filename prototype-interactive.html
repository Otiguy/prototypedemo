<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavTag - Interactive Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet.js for real maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- NavTag UI Styles -->
    <link rel="stylesheet" href="styles/navtag-ui.css">
</head>
<body>
    <div style="max-width: 1200px;">
        <!-- Single Interactive Container -->
        <div class="page-container" data-page="interactive" id="interactive-container">
            <div class="status-bar">
                <span class="status-time">9:03</span>
                <div class="status-icons">
                    <i data-lucide="signal"></i>
                    <i data-lucide="wifi"></i>
                    <i data-lucide="battery-full"></i>
                </div>
            </div>
            <div class="content-area" id="interactive-content">
                <!-- Content will be dynamically loaded here -->
            </div>
            <!-- Toast for interactive container -->
            <div class="toast" id="interactive-toast"></div>
            <!-- Modals will be appended here dynamically -->
        </div>
    </div>

    <script>
        // Wait for Leaflet to load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize interactive demo
            initInteractiveDemo();
        });

        // Interactive Demo System
        let interactiveMap = null;
        let currentScreen = 'splash';
        let navigationHistory = [];  // Navigation history stack
        let userMarker = null;
        let tagMarkers = [];

        const mockTags = [
            {
                id: 1,
                name: 'My Keys',
                icon: 'üîë',
                address: 'Building 101, No. 100, Futian Street, Futian District, Shenzhen, Guangdong, China',
                lat: 22.5480,
                lng: 114.0579,
                distance: 'Around You',
                lastUpdate: '2025-11-27 17:24:21',
                mac: '8F:42:A1:D3:7E:C9',
                firmwareVersion: 'v0.1.0',
                hasUpdate: true,
                battery: 100
            },
            {
                id: 2,
                name: 'Backpack',
                icon: 'üéí',
                address: 'Building 101, No. 100, Futian Street, Futian District, Shenzhen, Guangdong, China',
                lat: 22.5380,
                lng: 114.0579,
                distance: '1.2km',
                lastUpdate: '2025-11-27 17:19:21',
                mac: '3A:91:B2:E4:8F:D1',
                firmwareVersion: 'v0.1.0',
                hasUpdate: true,
                battery: 45
            },
            {
                id: 3,
                name: 'Car',
                icon: 'üöó',
                address: 'Building 101, No. 100, Futian Street, Futian District, Shenzhen, Guangdong, China',
                lat: 22.5431,
                lng: 114.0479,
                distance: '2.8km',
                lastUpdate: '2025-11-27 17:09:21',
                mac: 'D7:C2:F3:A5:9E:B8',
                firmwareVersion: 'v0.1.0',
                hasUpdate: true,
                battery: 20
            }
        ];

        // Mock addresses for trusted locations
        const mockAddresses = [
            '625 Division Street, Biloxi, Mississippi 39501, United States',
            '1428 Maple Avenue, Portland, Oregon 97205, United States',
            '892 Ocean Boulevard, Miami Beach, Florida 33139, United States',
            '3547 Pine Street, Seattle, Washington 98101, United States',
            '267 Broadway, New York, New York 10007, United States',
            '1853 Lake Shore Drive, Chicago, Illinois 60611, United States',
            '4192 Market Street, San Francisco, California 94102, United States',
            '736 Highland Avenue, Boston, Massachusetts 02134, United States'
        ];

        // Helper function to get random address
        function getRandomAddress() {
            return mockAddresses[Math.floor(Math.random() * mockAddresses.length)];
        }

        // Mock trajectory data for path tracking
        const mockTrajectoryData = {
            1: [ // My Keys
                {
                    id: 1,
                    timestamp: '2025-12-09 14:30:00',
                    lat: 22.5480,
                    lng: 114.0579,
                    address: 'Building 101, Tower A, No. 100 Futian Street, Futian Central Business District, Shenzhen, Guangdong Province, China'
                },
                {
                    id: 2,
                    timestamp: '2025-12-09 13:15:00',
                    lat: 22.5475,
                    lng: 114.0575,
                    address: 'Futian Metro Station Exit B, Line 1 & Line 11 Interchange, Civic Center Area, Shenzhen'
                },
                {
                    id: 3,
                    timestamp: '2025-12-09 12:00:00',
                    lat: 22.5468,
                    lng: 114.0568,
                    address: 'Starbucks Coffee Reserve, COCO Park Shopping Mall, 1st Floor, Futian District, Shenzhen'
                },
                {
                    id: 4,
                    timestamp: '2025-12-09 09:30:00',
                    lat: 22.5450,
                    lng: 114.0550,
                    address: 'Futian Residence Complex Block C, Unit 2, No. 88 Shennan Boulevard, Futian District, Shenzhen'
                },
                {
                    id: 5,
                    timestamp: '2025-12-08 18:45:00',
                    lat: 22.5440,
                    lng: 114.0545,
                    address: 'MixC Shopping Mall Main Entrance, 3rd Floor Food Court Area, Futian District, Shenzhen City'
                },
                {
                    id: 6,
                    timestamp: '2025-12-08 15:20:00',
                    lat: 22.5435,
                    lng: 114.0540,
                    address: 'Excellence Fortune Tower B, 27th Floor, Futian Central Business District, Shenzhen, Guangdong'
                },
                {
                    id: 7,
                    timestamp: '2025-12-08 09:00:00',
                    lat: 22.5450,
                    lng: 114.0550,
                    address: 'Futian Residence Complex Block C, Unit 2, No. 88 Shennan Boulevard, Futian District, Shenzhen'
                },
                {
                    id: 8,
                    timestamp: '2025-12-07 19:30:00',
                    lat: 22.5460,
                    lng: 114.0560,
                    address: 'Zhenhua Restaurant Street, Building 5, Near Futian Sports Park, Shennan Avenue, Futian, Shenzhen'
                }
            ],
            2: [ // Backpack
                {
                    id: 1,
                    timestamp: '2025-12-09 16:00:00',
                    lat: 22.5380,
                    lng: 114.0579,
                    address: 'Shenzhen University Main Campus, Building 7 Computer Science Department, Nanshan District, Shenzhen'
                },
                {
                    id: 2,
                    timestamp: '2025-12-09 12:30:00',
                    lat: 22.5375,
                    lng: 114.0575,
                    address: 'Central Library Reading Room 3B, 2nd Floor, Futian District Cultural Center, Shenzhen City'
                },
                {
                    id: 3,
                    timestamp: '2025-12-09 08:00:00',
                    lat: 22.5370,
                    lng: 114.0570,
                    address: 'Student Apartment Complex Building 12, Room 305, Shenzhen University South Campus Area, Nanshan'
                }
            ],
            3: [ // Car
                {
                    id: 1,
                    timestamp: '2025-12-09 17:00:00',
                    lat: 22.5431,
                    lng: 114.0479,
                    address: 'Underground Parking Level B2, Slot A123, COCO Park Shopping Center, Futian District, Shenzhen'
                },
                {
                    id: 2,
                    timestamp: '2025-12-09 14:30:00',
                    lat: 22.5425,
                    lng: 114.0475,
                    address: 'Outdoor Parking Area Zone C, High-Tech Industrial Park Phase III, Nanshan District, Shenzhen City'
                },
                {
                    id: 3,
                    timestamp: '2025-12-09 08:00:00',
                    lat: 22.5420,
                    lng: 114.0470,
                    address: 'Residential Community Parking Garage Level 1, Slot 88, Seaview Garden Complex, Futian, Shenzhen'
                }
            ]
        };

        // Global variable for trajectory filtering
        window.trajectoryFilter = {
            tagId: null,
            startDate: null,
            endDate: null
        };

        // Calculate duration between two timestamps
        function calculateDuration(timestamp1, timestamp2) {
            const date1 = new Date(timestamp1);
            const date2 = new Date(timestamp2);
            const diffMs = Math.abs(date2 - date1);
            const hours = Math.floor(diffMs / 3600000);
            const minutes = Math.floor((diffMs % 3600000) / 60000);

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // Filter trajectory data by date range
        function filterTrajectoryByDateRange(tagId, startDate, endDate) {
            const trajectories = mockTrajectoryData[tagId] || [];

            return trajectories.filter(point => {
                const pointDate = new Date(point.timestamp);
                return pointDate >= startDate && pointDate <= endDate;
            }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        // Get point label (S for start, E for end, number for middle)
        function getPointLabel(index, total) {
            if (index === 0) return 'S';
            if (index === total - 1) return 'E';
            return (index + 1).toString();
        }

        function initInteractiveDemo() {
            // Start with splash screen
            setTimeout(() => {
                showInteractiveScreen('login');
            }, 1000);

            showInteractiveScreen('splash');
        }

        function showInteractiveScreen(screenName, addToHistory = true) {
            // Add current screen to history before navigating (if not empty and addToHistory is true)
            if (addToHistory && currentScreen && currentScreen !== screenName) {
                navigationHistory.push(currentScreen);
            }

            currentScreen = screenName;
            const content = document.getElementById('interactive-content');
            content.innerHTML = getScreenHTML(screenName);
            annotateComponents(screenName);

            // Initialize Lucide icons for dynamic content
            lucide.createIcons();

            // Attach event listeners for the current screen
            attachScreenListeners(screenName);
        }

        function goBack(fallbackScreen = 'home') {
            const previousScreen = navigationHistory.pop() || fallbackScreen;
            showInteractiveScreen(previousScreen, false);
        }

        function getScreenHTML(screenName) {
            const screens = {
                splash: `
                    <div class="splash-screen">
                        <img src="resource/Splash_gradient.svg" alt="NavTag" class="splash-logo">
                        <p class="text-body" style="margin-bottom: 40px;">More than finding, unveil the journey</p>
                        <div class="loading-spinner"></div>
                    </div>
                `,
                login: `
                    <div style="padding: 60px 28px;">
                        <h1 class="title-primary" style="margin-bottom: 12px;">WELCOME</h1>
                        <p class="text-body" style="margin-bottom: 48px;">Sign in to your account</p>

                        <div style="margin-bottom: 24px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Email Address</label>
                            <input type="email" class="input-field" placeholder="your.email@example.com" id="demo-login-email">
                        </div>

                        <div style="margin-bottom: 32px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Verification Code</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" class="input-field" placeholder="Enter code" id="demo-login-code" style="flex: 1;">
                                <button class="btn-secondary" style="width: 120px; font-size: 14px;" id="demo-send-code">
                                    Send Code
                                </button>
                            </div>
                        </div>

                        <button class="btn-primary btn-breathing" id="demo-login-btn">
                            Sign In
                        </button>

                        <div style="margin-top: 24px; text-align: center;">
                            <span class="link-text" id="demo-switch-password">Switch to Password Login</span>
                        </div>

                        <div style="margin-top: 20px; text-align: center;">
                            <span class="text-body" style="font-size: 14px;">Don't have an account? </span>
                            <span class="link-text" id="demo-goto-register">Register</span>
                        </div>
                    </div>
                `,
                'login-password': `
                    <div style="padding: 60px 28px;">
                        <h1 class="title-primary" style="margin-bottom: 12px;">WELCOME</h1>
                        <p class="text-body" style="margin-bottom: 48px;">Sign in with password</p>

                        <div style="margin-bottom: 24px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Email / Username</label>
                            <input type="text" class="input-field" placeholder="your.email@example.com">
                        </div>

                        <div style="margin-bottom: 32px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Password</label>
                            <input type="password" class="input-field" placeholder="Enter password">
                        </div>

                        <div style="margin-bottom: 24px; text-align: right;">
                            <span class="link-text" style="font-size: 13px;" id="demo-forgot-password">Forgot Password?</span>
                        </div>

                        <button class="btn-primary btn-breathing" id="demo-login-password-btn">
                            Sign In
                        </button>

                        <div style="margin-top: 24px; text-align: center;">
                            <span class="link-text" id="demo-switch-code">Switch to Verification Code Login</span>
                        </div>

                        <div style="margin-top: 20px; text-align: center;">
                            <span class="text-body" style="font-size: 14px;">Don't have an account? </span>
                            <span class="link-text" id="demo-goto-register2">Register</span>
                        </div>
                    </div>
                `,
                'forgot-password': `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-forgot-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px; margin-bottom: 48px;">
                            <h1 class="title-primary" style="margin-bottom: 12px;">RESET PASSWORD</h1>
                            <p class="text-body">Enter your email to receive verification code</p>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Email Address</label>
                            <input type="email" class="input-field" placeholder="your.email@example.com" id="demo-forgot-email">
                        </div>

                        <button class="btn-primary btn-breathing" id="demo-forgot-send" style="font-size: 14px; letter-spacing: 1px;">
                            Send Verification Code
                        </button>
                    </div>
                `,
                'forgot-password-verify': `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-forgot-verify-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px; margin-bottom: 36px;">
                            <h1 class="title-primary" style="margin-bottom: 12px; font-size: 28px;">VERIFY & RESET</h1>
                            <p class="text-body">Check your email for the verification code</p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Verification Code</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" class="input-field" placeholder="Enter code" id="demo-forgot-code" style="flex: 1;">
                                <button class="btn-secondary" style="width: 120px; font-size: 14px;" id="demo-forgot-resend">
                                    Resend
                                </button>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">New Password</label>
                            <input type="password" class="input-field" placeholder="Enter new password" id="demo-forgot-new-pwd">
                        </div>

                        <div style="margin-bottom: 32px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Confirm New Password</label>
                            <input type="password" class="input-field" placeholder="Re-enter new password" id="demo-forgot-confirm-pwd">
                        </div>

                        <button class="btn-primary btn-breathing" id="demo-forgot-reset">
                            Reset Password
                        </button>
                    </div>
                `,
                'forgot-password-success': `
                    <div style="padding: 80px 28px; text-align: center;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(58, 139, 255, 0.2); border: 2px solid #3A8BFF; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                            <i data-lucide="check" style="font-size: 36px; color: #3A8BFF;"></i>
                        </div>

                        <h1 class="title-primary" style="margin-bottom: 16px;">PASSWORD RESET</h1>
                        <p class="text-body" style="margin-bottom: 48px; font-size: 15px;">
                            Your password has been successfully reset.<br>
                            You can now sign in with your new password.
                        </p>

                        <button class="btn-primary btn-breathing" id="demo-goto-login">
                            Sign In Now
                        </button>
                    </div>
                `,
                register: `
                    <div style="padding: 40px 28px;">
                        <h1 class="title-primary" style="margin-bottom: 12px; font-size: 28px;">CREATE ACCOUNT</h1>
                        <p class="text-body" style="margin-bottom: 36px;">Join NavTag today</p>

                        <div style="margin-bottom: 20px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Email Address</label>
                            <input type="email" class="input-field" placeholder="your.email@example.com" id="demo-register-email">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Verification Code</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" class="input-field" placeholder="Enter code" id="demo-register-code" style="flex: 1;">
                                <button class="btn-secondary" style="width: 120px; font-size: 14px;" id="demo-register-send-code">
                                    Send Code
                                </button>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Password</label>
                            <input type="password" class="input-field" placeholder="Create a strong password" id="demo-register-pwd">
                        </div>

                        <div style="margin-bottom: 28px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Confirm Password</label>
                            <input type="password" class="input-field" placeholder="Re-enter password" id="demo-register-confirm-pwd">
                        </div>

                        <button class="btn-primary btn-breathing" id="demo-register-btn">
                            Create Account
                        </button>

                        <div style="margin-top: 20px; text-align: center;">
                            <span class="text-body" style="font-size: 14px;">Already have an account? </span>
                            <span class="link-text" id="demo-back-login3">Sign In</span>
                        </div>
                    </div>
                `,
                bluetooth: `
                    <div style="padding: 28px; height: 100%; display: flex; flex-direction: column;">
                        <button class="icon-btn back-btn" id="demo-back-home">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; margin-top: 70px;">
                            <div>
                                <h2 class="title-secondary" style="margin-bottom: 8px;">Add Device</h2>
                                <p class="text-body" style="font-size: 13px;">Scanning for nearby tags...</p>
                            </div>
                            <button class="icon-btn" id="demo-qr-scan">
                                <i data-lucide="scan-line"></i>
                            </button>
                        </div>

                        <div style="display: flex; justify-content: center; margin: 24px 0;">
                            <div class="scan-pulse">
                                <div style="width: 80px; height: 80px; background: rgba(58, 139, 255, 0.2); border: 2px solid #3A8BFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                    <i data-lucide="bluetooth" style="font-size: 36px; color: #3A8BFF;"></i>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 24px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <h3 class="text-body" style="font-weight: 600; color: #FFFFFF; margin-bottom: 12px; font-size: 14px; display: flex; align-items: center;">
                                <i data-lucide="bluetooth-searching" style="margin-right: 8px; color: #3A8BFF;"></i>
                                DEVICES FOUND (3)
                            </h3>

                            <!-- Scrollable device list -->
                            <div style="flex: 1; overflow-y: auto; margin: 0 -28px; padding: 0 28px;">
                                <div class="device-item" data-device="1">
                                    <div class="device-icon">
                                        <i data-lucide="tag"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="color: #FFFFFF; font-weight: 600;">ATag-8F42AD245611</div>
                                    </div>
                                </div>

                                <div class="device-item" data-device="2">
                                    <div class="device-icon">
                                        <i data-lucide="tag"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="color: #FFFFFF; font-weight: 600;">ATag-3A91AD245612</div>
                                    </div>
                                </div>

                                <div class="device-item" data-device="3">
                                    <div class="device-icon">
                                        <i data-lucide="tag"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="color: #FFFFFF; font-weight: 600;">ATag-D7C2AD245613</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fixed info text at bottom -->
                        <div style="margin-top: 20px; padding-top: 20px;">
                            <p class="text-body" style="font-size: 13px; text-align: center; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="info" style="margin-right: 6px; color: #3A8BFF; flex-shrink: 0;"></i>
                                <span>Make sure your tag is powered on and nearby</span>
                            </p>
                        </div>
                    </div>
                `,
                home: `
                    <div style="position: relative; height: 100%; overflow: hidden;">
                        <!-- User Center Avatar Button -->
                        <button class="avatar-btn" id="demo-avatar-btn">
                            <img src="resource/avatar/ÂåóÊûÅÁáïÈ∏•.jpg" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        </button>

                        <!-- User Center Drawer Overlay -->
                        <div class="user-drawer-overlay" id="demo-user-drawer-overlay"></div>

                        <!-- User Center Drawer -->
                        <div class="user-drawer" id="demo-user-drawer">
                            <div class="user-drawer-header">
                                <div class="user-drawer-avatar">
                                    <img src="resource/avatar/ÂåóÊûÅÁáïÈ∏•.jpg" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                    <div class="user-drawer-name">Not Set</div>
                                    <button class="icon-btn" id="demo-edit-profile" style="width: 32px; height: 32px; font-size: 14px;">
                                        <i data-lucide="pencil"></i>
                                    </button>
                                </div>
                                <div class="user-drawer-uid">UID: 10240056</div>
                            </div>
                            <div class="user-drawer-menu">
                                <div class="user-menu-item" data-menu="language">
                                    <i data-lucide="globe"></i>
                                    <span>Language</span>
                                </div>
                                <div class="user-menu-item" data-menu="reset-password">
                                    <i data-lucide="key"></i>
                                    <span>Reset Password</span>
                                </div>
                                <div class="user-menu-item disabled" data-menu="help">
                                    <i data-lucide="help-circle"></i>
                                    <span>Help & Feedback</span>
                                </div>
                                <div class="user-menu-item" data-menu="about">
                                    <i data-lucide="info"></i>
                                    <span>About</span>
                                </div>
                                <div class="user-menu-item logout" data-menu="logout">
                                    <i data-lucide="log-out"></i>
                                    <span>Logout</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tag Loss Warning Banner -->
                        <div class="banner-notification" id="demo-tag-loss-banner">
                            <i data-lucide="alert-triangle" class="banner-notification-icon"></i>
                            <div class="banner-notification-content">
                                <div class="banner-notification-title">ÈÉ®ÂàÜTagÂèØËÉΩÂ∑≤ÈÅóÂ§±</div>
                                <div class="banner-notification-body">
                                    ‰æ¶ÊµãÂà∞Ëøô‰∫õÊ†áÁ≠æ‰∏çÂú®ÊÇ®Ë∫´ÊóÅÔºåËØ∑Âú® App ‰∏≠Ê£ÄÊü•ÊòØÂê¶ÈÅóÂ§±„ÄÇ
                                </div>
                            </div>
                            <button class="banner-notification-close" id="demo-banner-close">
                                <i data-lucide="x"></i>
                            </button>
                        </div>

                        <!-- Map Section -->
                        <div class="map-container" style="height: 563px; position: relative;">
                            <div id="demo-map" style="width: 100%; height: 100%;"></div>

                            <!-- Map Controls -->
                            <div class="map-controls">
                                <button class="control-btn" id="demo-zoom-in">
                                    <i data-lucide="plus"></i>
                                </button>
                                <button class="control-btn" id="demo-zoom-out">
                                    <i data-lucide="minus"></i>
                                </button>
                                <button class="control-btn" id="demo-center">
                                    <i data-lucide="locate-fixed"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tag List Drawer -->
                        <div class="drawer" style="height: 281px;" id="demo-drawer">
                            <div class="drawer-handle" id="demo-drawer-handle"></div>

                            <div style="padding: 0 20px 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 class="text-body" style="font-weight: 600; color: #FFFFFF; font-size: 16px;">
                                        MY TAGS (3)
                                    </h3>
                                    <div style="display: flex; gap: 12px;">
                                        <button class="icon-btn" style="width: 36px; height: 36px;" id="demo-refresh">
                                            <i data-lucide="rotate-cw"></i>
                                        </button>
                                        <button class="icon-btn" style="width: 36px; height: 36px;" id="demo-add-device">
                                            <i data-lucide="plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <div id="demo-tag-list">
                                    ${mockTags.map(tag => `
                                        <div class="tag-item-wrapper" data-tag-id="${tag.id}" style="cursor: pointer; position: relative;">
                                            ${tag.hasUpdate ? '<span class="update-badge"></span>' : ''}
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <div style="font-size: 30px;">${tag.icon}</div>
                                                <div style="color: #FFFFFF; font-weight: 600;">${tag.name}</div>
                                                <span class="battery-badge ${tag.battery <= 30 ? 'low' : tag.battery <= 60 ? 'medium' : ''}" data-battery="${tag.battery}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="battery-icon">
                                                        <path d="M 25 14 L 25 10"></path>
                                                        <rect x="0" y="6" width="22" height="12" rx="2"></rect>
                                                    </svg>
                                                </span>
                                                <div style="color: #3A8BFF; font-weight: 600; font-size: 14px; margin-left: auto;">${tag.distance}</div>
                                            </div>
                                            <div class="text-body" style="font-size: 12px; width: 100%;">${tag.address}</div>
                                            <div class="text-body" style="font-size: 11px; margin-top: 2px;">Updated ${tag.lastUpdate}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                    </div>
                `,
                'qr-scanner': `
                    <div class="qr-scanner">
                        <button class="icon-btn back-btn" id="demo-qr-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="text-align: center;">
                            <div class="scanner-frame">
                                <div class="scanner-corner top-left"></div>
                                <div class="scanner-corner top-right"></div>
                                <div class="scanner-corner bottom-left"></div>
                                <div class="scanner-corner bottom-right"></div>
                                <div class="scanner-line"></div>
                            </div>
                            <p class="text-body" style="margin-top: 32px; font-size: 15px;">
                                Align QR code within frame
                            </p>
                        </div>
                    </div>
                `,
                profile: `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-profile-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px; margin-bottom: 32px;">
                            <h2 class="title-secondary" style="margin-bottom: 8px;">Profile</h2>
                            <p class="text-body" style="font-size: 13px;">Edit your personal information</p>
                        </div>

                        <div style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                            <div class="text-body" style="font-size: 14px; color: #8B94A4;">
                                UID: 10240056
                            </div>
                            <button class="icon-btn" id="demo-copy-uid" style="width: 32px; height: 32px; font-size: 14px;">
                                <i data-lucide="copy"></i>
                            </button>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label class="text-body" style="display: block; margin-bottom: 12px; font-size: 13px;">Select Avatar</label>
                            <div class="icon-grid">
                                ${['ÂåóÊûÅÁáïÈ∏•.jpg', 'ËùôËù†.jpg', 'ËèäËä±.jpg', 'ËúúËúÇ.jpg', 'Ëí≤ÂÖ¨Ëã±.jpg', 'Ê§∞Â≠ê.jpg', 'Ê¶õÊûú.jpg', 'Ê¶õÂ≠ê.jpg'].map((imgFile, i) => `
                                    <div class="icon-option ${i === 0 ? 'selected' : ''}" data-avatar="${imgFile}">
                                        <img src="resource/avatar/${imgFile}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Nickname</label>
                            <input type="text" class="input-field" placeholder="Enter your nickname" id="demo-profile-nickname" value="Not Set">
                        </div>

                        <button class="btn-primary" id="demo-profile-save">
                            <i data-lucide="save" style="margin-right: 8px;"></i>
                            Save Changes
                        </button>
                    </div>
                `,
                language: `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-language-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px; margin-bottom: 24px;">
                            <h2 class="title-secondary" style="margin-bottom: 8px;">Language</h2>
                            <p class="text-body" style="font-size: 13px;">Choose your preferred language</p>
                        </div>

                        <div class="language-list" style="height: 600px; overflow-y: auto;">
                            ${[
                                { code: 'zh-CN', name: 'ÁÆÄ‰Ωì‰∏≠Êñá', selected: true },
                                { code: 'zh-TW', name: 'ÁπÅÈ´î‰∏≠Êñá', selected: false },
                                { code: 'en', name: 'English', selected: false },
                                { code: 'ja', name: 'Êó•Êú¨Ë™û', selected: false },
                                { code: 'ko', name: 'ÌïúÍµ≠Ïñ¥', selected: false },
                                { code: 'fr', name: 'Fran√ßais', selected: false },
                                { code: 'de', name: 'Deutsch', selected: false },
                                { code: 'it', name: 'Italiano', selected: false }
                            ].map(lang => `
                                <div class="language-item ${lang.selected ? 'selected' : ''}" data-lang="${lang.code}">
                                    <span class="language-item-name">${lang.name}</span>
                                    <i data-lucide="check" class="language-item-check"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `,
                about: `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-about-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 80px; text-align: center;">
                            <div class="about-icon">
                                <img src="resource/Splash_gradient.svg" alt="NavTag" style="width: 80px; height: 80px;">
                            </div>

                            <h2 class="title-secondary" style="margin-bottom: 24px; font-size: 24px;">NAVTAG</h2>

                            <div class="version-info" style="margin-bottom: 32px;">
                                <div class="version-label">Version</div>
                                <div class="version-value">v1.0.0 (100)</div>
                            </div>

                            <button class="btn-primary" id="demo-check-update" style="max-width: 120px; margin: 0 auto 32px; padding: 12px 16px; font-size: 13px; white-space: nowrap;">
                                <i data-lucide="cloud-download" style="margin-right: 6px; font-size: 12px;"></i>
                                Check Update
                            </button>

                            <div class="about-links">
                                <a href="#" class="about-link">User Policy</a>
                                <a href="#" class="about-link">Privacy Agreement</a>
                            </div>

                            <div style="text-align: center; margin-top: 8px; margin-bottom: 32px;">
                                <a href="#" class="about-link" id="demo-delete-account-link" style="display: inline-flex; align-items: center; gap: 6px;">
                                    <i data-lucide="user-x" style="width: 14px; height: 14px;"></i>
                                    Delete Account
                                </a>
                            </div>

                            <div class="copyright-text">
                                Copyright ¬© 2025 NavTag Co., Ltd. All Rights Reserved
                            </div>
                        </div>
                    </div>
                `,
                'account-deletion': `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-account-deletion-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px;">
                            <h2 class="title-secondary" style="margin-bottom: 32px; font-size: 22px; text-align: center;">Delete Account</h2>

                            <!-- Letter to User -->
                            <div class="deletion-letter">
                                <p class="text-body">
                                    Dear User,
                                </p>
                                <p class="text-body">
                                    Thank you for your continued support. We understand that account cancellation is an important decision. To protect your rights, please review the following before proceeding:
                                </p>
                                <p class="text-body">
                                    ‚Ä¢Data deletion: Once you log out, all personal data (such as profile, history, etc.) stored on your device and cloud will be permanently deleted and cannot be recovered. Please back up important information in advance.
                                </p>
                                <p class="text-body">
                                    ‚Ä¢ Rights processing: Existing membership or value-added services will be terminated upon account cancellation. Unused benefits (such as membership duration and points) will be automatically voided, and refunds are not available. We recommend using them before cancellation.
                                </p>
                                <p class="text-body">
                                    ‚Ä¢Account Closure: This cancellation completes all rights and obligations during your account usage.
                                </p>
                                <p class="text-body">
                                    If you have any questions about data deletion, privacy policies, or user agreements, we are here to help. You can contact us via email at service@iweiyin.com. Thank you for choosing us. We wish you all the best!
                                </p>
                                <p class="text-body" style="margin-top: 20px;">
                                    Sincerely,<br>
                                    The NavTag Team
                                </p>
                            </div>

                            <!-- Checkbox -->
                            <div class="deletion-checkbox" id="demo-deletion-checkbox">
                                <i data-lucide="square" class="checkbox-icon" id="demo-checkbox-icon"></i>
                                <span class="text-body" style="font-size: 14px;">I have read and understood the above terms</span>
                            </div>

                            <!-- Delete Button -->
                            <button class="btn-secondary" id="demo-delete-account-btn" style="width: 100%; margin-top: 24px; border-color: #FF4D4F; color: #FF4D4F;" disabled>Verify</button>
                        </div>
                    </div>
                `,
                'account-deletion-verify': `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-account-deletion-verify-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px; margin-bottom: 48px;">
                            <h1 class="title-primary" style="margin-bottom: 12px;">VERIFY EMAIL</h1>
                            <p class="text-body">Enter the verification code sent to your email</p>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <label class="text-body" style="display: block; margin-bottom: 8px; font-size: 13px;">Verification Code</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" class="input-field" placeholder="Enter 6-digit code" id="demo-deletion-verify-code" style="flex: 1;" maxlength="6">
                                <button class="btn-secondary" style="width: 120px; font-size: 14px;" id="demo-deletion-resend-code">
                                    Resend
                                </button>
                            </div>
                        </div>

                        <button class="btn-primary" id="demo-deletion-verify-btn" style="border-color: #FF4D4F; background: linear-gradient(135deg, #FF4D4F 0%, #DC2626 100%); box-shadow: 0 0 20px rgba(255, 77, 79, 0.4), 0 8px 16px rgba(0, 0, 0, 0.4);">
                            DELETE ACCOUNT
                        </button>

                        <div style="margin-top: 24px; text-align: center;">
                            <span class="text-body" style="font-size: 13px;">Didn't receive code? </span>
                            <span class="link-text" id="demo-deletion-resend-link">Resend</span>
                        </div>
                    </div>
                `,
                'lost-mode-settings': `
                    <div style="padding: 28px;">
                        <button class="icon-btn back-btn" id="demo-lost-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 60px; margin-bottom: 32px;">
                            <h1 class="title-primary">LOST MODE</h1>
                        </div>

                        <!-- 1. Lost Notification Toggle -->
                        <div class="setting-row">
                            <div class="setting-row-header">
                                <div>
                                    <div class="setting-label">Lost Notification</div>
                                    <div class="setting-desc">Alert when tag leaves trusted locations</div>
                                </div>
                                <div class="toggle-switch" id="demo-lost-toggle">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Reminder Interval (disabled by default) -->
                        <div class="setting-row" id="demo-interval-section" style="opacity: 0.5; pointer-events: none;">
                            <div class="setting-label">Reminder Interval</div>
                            <div class="segment-control" style="width: 100%;">
                                <button class="segment-option selected" data-interval="5">5 min</button>
                                <button class="segment-option" data-interval="10">10 min</button>
                                <button class="segment-option" data-interval="30">30 min</button>
                            </div>
                        </div>

                        <!-- 3. Trusted Locations -->
                        <div id="demo-trusted-locations-section" style="opacity: 0.5; pointer-events: none;">
                            <div class="setting-label" style="margin-top: 32px; margin-bottom: 16px;">
                                Trusted Locations
                            </div>

                            <!-- Empty State (show when no locations) -->
                            <div class="empty-state" id="demo-trusted-empty">
                                <i data-lucide="map-pinned" class="empty-icon"></i>
                                <div class="text-body" style="margin-bottom: 8px;">No trusted locations yet</div>
                                <div class="text-body" style="font-size: 12px; color: #8B94A4;">
                                    Add locations where you don't want to be alerted
                                </div>
                            </div>

                            <!-- Location List (show when locations exist) -->
                            <div id="demo-trusted-list" style="display: none;"></div>

                            <!-- Add Location Button -->
                            <button class="btn-secondary" id="demo-add-location" style="margin-top: 16px;" disabled>
                                <i data-lucide="plus" style="margin-right: 8px;"></i>
                                Add Trusted Location
                            </button>
                        </div>
                    </div>
                `,
                'tag-info': `
                    <div style="padding: 28px; height: 100%; display: flex; flex-direction: column;">
                        <button class="icon-btn back-btn" id="tag-info-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 70px; margin-bottom: 24px;">
                            <h2 class="title-secondary">Tag Information</h2>
                            <p class="text-body" style="font-size: 13px;">View and edit tag details</p>
                        </div>

                        <!-- Icon ÁºñËæëÂå∫ -->
                        <div style="margin-bottom: 24px;">
                            <div class="text-body" style="font-size: 12px; margin-bottom: 8px;">Tag Icon</div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div id="tag-info-icon-display" style="font-size: 32px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(58, 139, 255, 0.1); border: 1px solid rgba(58, 139, 255, 0.3); border-radius: 12px;"></div>
                                <button class="btn-secondary" style="flex: 1; font-size: 14px;" id="tag-info-change-icon">
                                    Change Icon
                                </button>
                            </div>
                            <div id="tag-info-icon-selector" style="display: none; margin-top: 12px; padding: 12px; background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 12px;">
                                <div id="tag-info-icon-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;"></div>
                            </div>
                        </div>

                        <!-- Name ÁºñËæëÂå∫ -->
                        <div style="margin-bottom: 24px;">
                            <label class="text-body" style="display: block; font-size: 12px; margin-bottom: 8px;">Device Name</label>
                            <input type="text" class="input-field" id="tag-info-name-input" style="font-size: 15px;">
                        </div>

                        <!-- MAC Address (Âè™ËØª) -->
                        <div style="margin-bottom: 24px;">
                            <div class="text-body" style="font-size: 12px; margin-bottom: 8px;">MAC Address</div>
                            <div id="tag-info-mac" style="color: #FFFFFF; font-size: 15px; font-family: 'Courier New', monospace;"></div>
                        </div>

                        <!-- Location (Âè™ËØª) -->
                        <div style="margin-bottom: 24px;">
                            <div class="text-body" style="font-size: 12px; margin-bottom: 8px;">Location</div>
                            <div id="tag-info-location" style="color: #FFFFFF; font-size: 15px;"></div>
                        </div>

                        <!-- Last Update (Âè™ËØª) -->
                        <div style="margin-bottom: 24px;">
                            <div class="text-body" style="font-size: 12px; margin-bottom: 8px;">Last Update</div>
                            <div id="tag-info-last-update" style="color: #FFFFFF; font-size: 15px;"></div>
                        </div>

                        <!-- Firmware Version (Êñ∞Â¢ûÔºåÂ∏¶ÂçáÁ∫ßÊåâÈíÆ) -->
                        <div style="margin-bottom: 24px;">
                            <div class="text-body" style="font-size: 12px; margin-bottom: 8px;">Firmware Version</div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div id="tag-info-firmware" style="color: #FFFFFF; font-size: 15px; font-family: 'Courier New', monospace;"></div>
                                <button class="icon-btn" id="check-firmware-btn" style="width: 36px; height: 36px; position: relative;">
                                    <i data-lucide="cloud-download"></i>
                                    <span id="firmware-update-badge" class="update-badge" style="display: none;"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
                        <div style="margin-top: 20px;">
                            <button class="btn-secondary" style="width: 100%;" id="tag-info-unbind">Unbind Tag</button>
                        </div>

                        <!-- Unbind Confirmation Modal -->
                        <div class="modal-overlay" id="unbind-modal">
                            <div class="modal-content">
                                <div class="title-secondary" style="text-align: center; font-size: 20px; margin-bottom: 12px;">Unbind Tag?</div>
                                <div class="text-body" style="text-align: center; font-size: 14px; margin-bottom: 24px;">
                                    Are you sure you want to unbind this tag? This action cannot be undone and you'll need to pair it again to use it.
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="btn-secondary" style="flex: 1;" id="unbind-cancel">Cancel</button>
                                    <button class="btn-primary" style="flex: 1; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);" id="unbind-confirm">Unbind</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                'firmware-update': `
                    <div style="padding: 28px; height: 100%; display: flex; flex-direction: column;">
                        <button class="icon-btn back-btn" id="firmware-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <div style="margin-top: 70px; margin-bottom: 20px; text-align: center;">
                            <h2 class="title-secondary" style="font-size: 22px; margin-bottom: 8px;">New Firmware Available</h2>
                            <p class="text-body" style="font-size: 14px; color: #3A8BFF;">Version 1.1.0 is now available</p>
                        </div>

                        <!-- Êõ¥Êñ∞ËØ¥ÊòéÔºàÂèØÊªöÂä®Ôºâ -->
                        <div style="max-height: 120px; overflow-y: auto; margin-bottom: 20px; padding: 16px; background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 16px;">
                            <p class="text-body" style="margin-bottom: 12px;">This update includes performance improvements, bug fixes, and enhanced battery optimization.</p>
                            <p class="text-body" style="margin-bottom: 12px;">Key features: Improved Bluetooth connectivity, faster location updates, and extended battery life.</p>
                            <p class="text-body">We recommend updating all your tags for the best experience.</p>
                        </div>

                        <!-- È¢Ñ‰∏ãËΩΩÊåâÈíÆ / ËøõÂ∫¶Êù° -->
                        <div style="margin-bottom: 24px;" id="download-section">
                            <button class="btn-primary btn-breathing" id="pre-download-btn" style="padding: 10px 20px; font-size: 14px;">
                                <i data-lucide="download"></i>
                                Pre-Download Firmware
                            </button>
                            <!-- ËøõÂ∫¶Êù°ÔºàÂàùÂßãÈöêËóèÔºâ -->
                            <div id="download-progress" style="display: none;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span class="text-body" style="font-size: 13px;" id="download-status">Downloading...</span>
                                    <span class="text-body" style="font-size: 13px;" id="download-percent">0%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 4px; overflow: hidden;">
                                    <div id="download-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3A8BFF 0%, #2563EB 100%); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tags Available for OTA -->
                        <div style="flex: 1; min-height: 0;">
                            <h3 class="text-body" style="font-weight: 600; color: #FFFFFF; margin-bottom: 12px; font-size: 14px;">Tags Available for OTA</h3>
                            <div id="ota-tags-list" style="height: 100%; overflow-y: auto;"></div>
                        </div>
                    </div>
                `,
                'add-trusted-location': `
                    <div style="position: relative; height: 100%; overflow: hidden;">
                        <!-- Header Bar -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 80px; background: rgba(13, 17, 26, 0.95); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid rgba(58, 139, 255, 0.2);">
                            <button class="icon-btn" id="demo-add-location-back">
                                <i data-lucide="arrow-left"></i>
                            </button>
                            <h3 class="title-secondary" style="font-size: 18px;">Add Trusted Location</h3>
                            <button class="icon-btn" id="demo-add-location-save">
                                <i data-lucide="check"></i>
                            </button>
                        </div>

                        <!-- Address Display Bar -->
                        <div style="position: absolute; top: 80px; left: 0; right: 0; height: 60px; background: rgba(26, 31, 43, 0.9); backdrop-filter: blur(10px); z-index: 900; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid rgba(58, 139, 255, 0.2);">
                            <i data-lucide="map-pin" style="color: #3A8BFF; margin-right: 12px; width: 20px; height: 20px;"></i>
                            <div style="flex: 1;">
                                <div class="text-body" style="font-size: 13px; color: #8B94A4;">Selected Location</div>
                                <div class="text-body" style="font-size: 14px; color: #FFFFFF;" id="demo-selected-address">
                                    Tap on map to select location
                                </div>
                            </div>
                        </div>

                        <!-- Full Map -->
                        <div id="demo-trusted-location-map" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>

                        <!-- Bottom Control Panel -->
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(13, 17, 26, 0.95); backdrop-filter: blur(10px); z-index: 1000; padding: 20px; border-top: 1px solid rgba(58, 139, 255, 0.2);">
                            <!-- Fence Type Selector -->
                            <div class="segment-control" style="margin-bottom: 16px;">
                                <button class="segment-option selected" id="demo-fence-circle" data-type="circle">
                                    <i data-lucide="circle" style="margin-right: 6px; width: 14px; height: 14px;"></i>
                                    Circle
                                </button>
                                <button class="segment-option" id="demo-fence-polygon" data-type="polygon">
                                    <i data-lucide="pentagon" style="margin-right: 6px; width: 14px; height: 14px;"></i>
                                    Polygon
                                </button>
                            </div>

                            <!-- Circle Radius Slider (visible by default) -->
                            <div id="demo-radius-control" style="display: block;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span class="text-body" style="font-size: 13px;">Radius</span>
                                    <span class="text-body" style="font-size: 14px; color: #3A8BFF; font-weight: 600;" id="demo-radius-value">500m</span>
                                </div>
                                <input type="range" id="demo-radius-slider" min="100" max="1000" value="500" step="50"
                                       style="width: 100%; height: 6px; background: rgba(58, 139, 255, 0.3); border-radius: 3px; outline: none; -webkit-appearance: none;">
                            </div>

                            <!-- Polygon Instructions (hidden by default) -->
                            <div id="demo-polygon-instructions" style="display: none;">
                                <div class="text-body" style="font-size: 13px; color: #8B94A4; text-align: center; margin-bottom: 8px;">
                                    Tap on map to add points (minimum 3)
                                </div>
                                <button class="btn-secondary" id="demo-clear-polygon" style="width: 100%;" disabled>
                                    <i data-lucide="trash-2" style="margin-right: 8px;"></i>
                                    Clear Points
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'path-datepicker': `
                    <div style="padding: 28px; height: 100%; display: flex; flex-direction: column;">
                        <!-- Back Button -->
                        <button class="icon-btn back-btn" id="demo-path-picker-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <!-- Header -->
                        <div style="margin-top: 40px; margin-bottom: 24px;">
                            <h2 class="title-secondary" style="margin-bottom: 8px;">Select Time Range</h2>
                            <p class="text-body" style="font-size: 13px;">Choose dates to view path history</p>
                        </div>

                        <!-- Date Picker (Calendar View) - Moved to top -->
                        <div style="flex: 0 1 auto;">
                            <div style="background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 16px; padding: 16px;">
                                <!-- Month/Year Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <button class="icon-btn" id="prev-month" style="width: 36px; height: 36px;">
                                        <i data-lucide="chevron-left"></i>
                                    </button>
                                    <div style="color: #FFFFFF; font-weight: 600; font-size: 15px; letter-spacing: 1px;" id="calendar-month-year">
                                        2025-12
                                    </div>
                                    <button class="icon-btn" id="next-month" style="width: 36px; height: 36px;">
                                        <i data-lucide="chevron-right"></i>
                                    </button>
                                </div>

                                <!-- Weekday Headers -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">Su</div>
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">Mo</div>
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">Tu</div>
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">We</div>
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">Th</div>
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">Fr</div>
                                    <div style="text-align: center; color: #8B94A4; font-size: 11px; padding: 4px;">Sa</div>
                                </div>

                                <!-- Calendar Grid (will be populated by JS) -->
<div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;">
                                    <!-- Populated by renderCalendar() -->
                                </div>
                            </div>

                            <!-- Time Range Selection with Wheel Picker -->
                            <div style="background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 16px; padding: 16px; margin-top: 16px;">
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <div class="time-picker-trigger" id="start-time-trigger" style="flex: 1; padding: 12px; background: rgba(58, 139, 255, 0.1); border: 1px solid rgba(58, 139, 255, 0.3); border-radius: 8px; color: #FFFFFF; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                        <span id="start-time-display">00:00</span>
                                    </div>
                                    <span style="color: #8B94A4;">~</span>
                                    <div class="time-picker-trigger" id="end-time-trigger" style="flex: 1; padding: 12px; background: rgba(58, 139, 255, 0.1); border: 1px solid rgba(58, 139, 255, 0.3); border-radius: 8px; color: #FFFFFF; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                        <span id="end-time-display">23:59</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Selection Buttons - Tag style -->
                        <div style="margin-bottom: 16px; margin-top: 16px;">
                            <div style="display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto;">
                                <button class="tag-btn selected quick-select-btn" data-range="today" style="white-space: nowrap;">Today</button>
                                <button class="tag-btn quick-select-btn" data-range="yesterday" style="white-space: nowrap;">Yesterday</button>
                                <button class="tag-btn quick-select-btn" data-range="past3d" style="white-space: nowrap;">Past 3D</button>
                                <button class="tag-btn quick-select-btn disabled" data-range="past7d" style="position: relative; white-space: nowrap;">
                                    Past 7D
                                    <i data-lucide="play-circle" style="position: absolute; top: 2px; right: 2px; width: 12px; height: 12px; color: #FF9E4A;"></i>
                                </button>
                            </div>
                        </div>

                        <!-- View Path Button -->
                        <button class="btn-primary btn-breathing" id="view-path-btn">
                            <i data-lucide="waypoints" style="margin-right: 8px;"></i>
                            View Path
                        </button>

                        <!-- Time Wheel Picker Modal -->
                        <div id="time-wheel-picker-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: flex-end; justify-content: center;">
                            <div style="width: 100%; background: rgba(26, 31, 43, 0.98); backdrop-filter: blur(20px); border-radius: 28px 28px 0 0; padding: 20px; box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.5);">
                                <!-- Header -->
                                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <button class="btn-secondary" id="time-picker-close" style="padding: 6px 12px; font-size: 13px; width: 70px;">
                                        Cancel
                                    </button>
                                    <h3 style="color: #FFFFFF; font-size: 16px; font-weight: 600; flex: 1; text-align: center; min-width: 0;">Time range</h3>
                                    <button class="btn-primary" id="time-picker-confirm" style="padding: 6px 12px; font-size: 13px; width: 70px;">
                                        Save
                                    </button>
                                </div>

                                <!-- Wheel Picker Container -->
                                <div style="display: flex; gap: 6px; justify-content: center; align-items: center; margin-bottom: 24px; position: relative; height: 200px; overflow: hidden;">
                                    <!-- Start Time -->
                                    <div style="flex: 1; position: relative;">
                                        <div id="start-hour-wheel" class="time-wheel" style="height: 200px; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;">
                                            <!-- Generated by JS -->
                                        </div>
                                    </div>
                                    <span style="color: #FFFFFF; font-size: 16px; font-weight: 600;">:</span>
                                    <div style="flex: 1; position: relative;">
                                        <div id="start-minute-wheel" class="time-wheel" style="height: 200px; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;">
                                            <!-- Generated by JS -->
                                        </div>
                                    </div>

                                    <!-- Separator -->
                                    <span style="color: #8B94A4; font-size: 18px; font-weight: 600; padding: 0 4px;">~</span>

                                    <!-- End Time -->
                                    <div style="flex: 1; position: relative;">
                                        <div id="end-hour-wheel" class="time-wheel" style="height: 200px; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;">
                                            <!-- Generated by JS -->
                                        </div>
                                    </div>
                                    <span style="color: #FFFFFF; font-size: 16px; font-weight: 600;">:</span>
                                    <div style="flex: 1; position: relative;">
                                        <div id="end-minute-wheel" class="time-wheel" style="height: 200px; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch;">
                                            <!-- Generated by JS -->
                                        </div>
                                    </div>

                                    <!-- Selection Indicator -->
                                    <div style="position: absolute; top: 50%; left: 0; right: 0; height: 40px; transform: translateY(-50%); border-top: 1px solid rgba(58, 139, 255, 0.5); border-bottom: 1px solid rgba(58, 139, 255, 0.5); pointer-events: none; background: rgba(58, 139, 255, 0.1);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                'path-view': `
                    <div style="position: relative; height: 100%; display: flex; flex-direction: column;">
                        <!-- Back Button -->
                        <button class="icon-btn back-btn" id="demo-path-view-back" style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <!-- Map Container -->
                        <div id="demo-path-map" style="flex: 1; width: 100%; position: relative;"></div>

                        <!-- Map Controls -->
                        <div class="map-controls" style="position: absolute; right: 20px; top: 20px; z-index: 400;">
                            <button class="control-btn" id="demo-path-zoom-in">
                                <i data-lucide="plus"></i>
                            </button>
                            <button class="control-btn" id="demo-path-zoom-out">
                                <i data-lucide="minus"></i>
                            </button>
                            <button class="control-btn" id="demo-path-center">
                                <i data-lucide="locate-fixed"></i>
                            </button>
                            <button class="control-btn" id="demo-path-list">
                                <i data-lucide="scroll-text"></i>
                            </button>
                        </div>

                        <!-- Point Detail Drawer (hidden by default, slides from bottom) -->
                        <div id="point-tooltip" style="display: none; position: absolute; left: 0; right: 0; bottom: 0; z-index: 500;">
                            <div class="drawer" style="background: rgba(26, 31, 43, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(58, 139, 255, 0.3); padding: 12px 12px; box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.6); box-sizing: border-box; overflow: hidden;">
                                <!-- Header: MAC + sequence + nav buttons -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                                        <div id="tooltip-mac-display" class="text-body poppins" style="height: 36px; padding: 0 10px; display: flex; align-items: center; justify-content: center; background: rgba(26, 31, 34, 0.6); backdrop-filter: blur(10px); border-radius: 8px; border: 1px solid rgba(58, 139, 255, 0.3); color: rgba(255, 255, 255, 0.6); letter-spacing: 0.5px; font-size: 13px; flex-shrink: 0;">
                                            AC:84:C6:2F:1A:3B
                                        </div>
                                        <div style="color: #3A8BFF; font-weight: 700; font-size: 14px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="tooltip-sequence">Start</div>
                                    </div>
                                    <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                        <button class="icon-btn" id="tooltip-prev" style="width: 36px !important; height: 36px !important; min-width: 36px;">
                                            <i data-lucide="chevron-left"></i>
                                        </button>
                                        <button class="icon-btn" id="tooltip-next" style="width: 36px !important; height: 36px !important; min-width: 36px;">
                                            <i data-lucide="chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <div style="flex: 1; min-width: 0; max-width: 50%;">
                                        <div class="text-body" style="font-size: 11px; margin-bottom: 4px;">Timestamp</div>
                                        <div style="color: #FFFFFF; font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="tooltip-timestamp">2025-12-09 14:30:00</div>
                                    </div>
                                    <div style="flex: 1; min-width: 0; max-width: 50%;">
                                        <div class="text-body" style="font-size: 11px; margin-bottom: 4px;">Duration</div>
                                        <div style="color: #FFFFFF; font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="tooltip-duration">1h 15m</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <div class="text-body" style="font-size: 11px; margin-bottom: 6px;">Address</div>
                                    <div style="color: #FFFFFF; font-size: 12px; line-height: 1.5; cursor: pointer; display: flex; align-items: start; gap: 6px;" id="tooltip-address-container">
                                        <span id="tooltip-address" style="flex: 1; min-width: 0; word-break: break-word; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">Building 101, No. 100, Futian Street</span>
                                        <button class="icon-btn" id="tooltip-copy-address" style="width: 36px !important; height: 36px !important; min-width: 28px; flex-shrink: 0;">
                                            <i data-lucide="copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <button class="btn-secondary" id="tooltip-navigate" style="width: 100%; padding: 9px 10px; font-size: 13px;">
                                    <i data-lucide="navigation" style="margin-right: 6px; width: 14px; height: 14px;"></i>
                                    Navigate
                                </button>
                            </div>
                        </div>

                        <!-- Navigation App Modal -->
                        <div class="modal-overlay" id="demo-nav-modal-overlay">
                            <div class="modal-content">
                                <h3 class="title-secondary" style="font-size: 20px; margin-bottom: 20px; text-align: center;">
                                    Choose Navigation App
                                </h3>
                                <button class="btn-secondary" style="margin-bottom: 12px; text-align: left; padding-left: 24px;" id="demo-nav-google">
                                    <i data-lucide="map"></i>
                                    Google Maps
                                </button>
                                <button class="btn-secondary" style="margin-bottom: 12px; text-align: left; padding-left: 24px;" id="demo-nav-amap">
                                    <i data-lucide="map-pin"></i>
                                    È´òÂæ∑Âú∞Âõæ
                                </button>
                                <button class="btn-secondary" style="margin-bottom: 20px; text-align: left; padding-left: 24px;" id="demo-nav-baidu">
                                    <i data-lucide="compass"></i>
                                    ÁôæÂ∫¶Âú∞Âõæ
                                </button>
                                <button class="btn-secondary" id="demo-nav-cancel">Cancel</button>
                            </div>
                        </div>
                    </div>
                `,
                'history-point': `
                    <div style="padding: 28px; height: 100%; display: flex; flex-direction: column;">
                        <!-- Back Button -->
                        <button class="icon-btn back-btn" id="demo-history-point-back">
                            <i data-lucide="arrow-left"></i>
                        </button>

                        <!-- Header -->
                        <div style="margin-top: 40px; margin-bottom: 20px;">
                            <h2 class="title-secondary" style="margin-bottom: 8px;">History Points</h2>
                            <p class="text-body" style="font-size: 13px;" id="history-point-count">8 locations found</p>
                        </div>

                        <!-- Scrollable Point List -->
                        <div id="history-point-list" style="flex: 1; overflow-y: auto; margin: 0 -28px; padding: 0 28px;">
                            <!-- Populated by renderHistoryPointsList() -->
                        </div>
                    </div>
                `
            };
            const inner = screens[screenName] || screens.splash;
            return `<div data-page="${screenName}" class="page-${screenName}" style="height:100%; width:100%;">${inner}</div>`;
        }

        function annotateComponents(screenName) {
            const root = document.querySelector(`.page-${screenName}`);
            if (!root) return;
            root.querySelectorAll('.device-item').forEach(el => el.setAttribute('data-component', 'comp-device-item'));
            root.querySelectorAll('.device-icon').forEach(el => el.setAttribute('data-component', 'comp-device-icon'));
            root.querySelectorAll('.user-drawer').forEach(el => el.setAttribute('data-component', 'comp-user-drawer'));
            root.querySelectorAll('.user-menu-item').forEach(el => el.setAttribute('data-component', 'comp-user-menu-item'));
            root.querySelectorAll('.map-container').forEach(el => el.setAttribute('data-component', 'group-map-container'));
            root.querySelectorAll('.map-controls').forEach(el => el.setAttribute('data-component', 'group-map-controls'));
            root.querySelectorAll('.drawer').forEach(el => el.setAttribute('data-component', 'comp-drawer'));
            root.querySelectorAll('.tag-item-wrapper').forEach(el => el.setAttribute('data-component', 'comp-tag-item'));
            root.querySelectorAll('.tag-item-content').forEach(el => el.setAttribute('data-component', 'comp-tag-content'));
            root.querySelectorAll('.btn-primary, .btn-secondary, .icon-btn, .control-btn, .action-btn').forEach(el => el.setAttribute('data-type', 'button'));
            root.querySelectorAll('.input-field').forEach(el => el.setAttribute('data-type', 'input'));
            root.querySelectorAll('.about-link').forEach(el => el.setAttribute('data-component', 'link'));
            document.getElementById('interactive-toast')?.setAttribute('data-type', 'toast');
        }

        // 60-second countdown timer
        function startCountdown(buttonElement) {
            let countdown = 60;
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.5';
            buttonElement.style.cursor = 'not-allowed';

            const originalText = buttonElement.textContent;

            const timer = setInterval(() => {
                countdown--;
                buttonElement.textContent = `Resend (${countdown}s)`;

                if (countdown <= 0) {
                    clearInterval(timer);
                    buttonElement.disabled = false;
                    buttonElement.style.opacity = '1';
                    buttonElement.style.cursor = 'pointer';
                    buttonElement.textContent = originalText;
                }
            }, 1000);
        }

        function attachScreenListeners(screenName) {
            switch (screenName) {
                case 'login':
                    const sendCodeBtn = document.getElementById('demo-send-code');
                    sendCodeBtn?.addEventListener('click', () => {
                        showInteractiveToast('Verification code sent to your email');
                        startCountdown(sendCodeBtn);
                    });
                    document.getElementById('demo-login-btn')?.addEventListener('click', () => {
                        showInteractiveToast('Logging in...');
                        setTimeout(() => showInteractiveScreen('bluetooth'), 1500);
                    });
                    document.getElementById('demo-switch-password')?.addEventListener('click', () => {
                        showInteractiveScreen('login-password');
                    });
                    document.getElementById('demo-goto-register')?.addEventListener('click', () => {
                        showInteractiveScreen('register');
                    });
                    break;

                case 'login-password':
                    document.getElementById('demo-login-password-btn')?.addEventListener('click', () => {
                        showInteractiveToast('Logging in...');
                        setTimeout(() => showInteractiveScreen('bluetooth'), 1500);
                    });
                    document.getElementById('demo-switch-code')?.addEventListener('click', () => {
                        showInteractiveScreen('login');
                    });
                    document.getElementById('demo-forgot-password')?.addEventListener('click', () => {
                        showInteractiveScreen('forgot-password');
                    });
                    document.getElementById('demo-goto-register2')?.addEventListener('click', () => {
                        showInteractiveScreen('register');
                    });
                    break;

                case 'register':
                    const registerSendBtn = document.getElementById('demo-register-send-code');
                    registerSendBtn?.addEventListener('click', () => {
                        showInteractiveToast('Verification code sent to your email');
                        startCountdown(registerSendBtn);
                    });
                    document.getElementById('demo-register-btn')?.addEventListener('click', () => {
                        const code = document.getElementById('demo-register-code')?.value;
                        if (code && code !== '123456') {
                            showInteractiveToast('‚ùå Incorrect verification code', 'error');
                        } else {
                            showInteractiveToast('Account created successfully! Logging in...');
                            setTimeout(() => showInteractiveScreen('bluetooth'), 1500);
                        }
                    });
                    document.getElementById('demo-back-login3')?.addEventListener('click', () => {
                        showInteractiveScreen('login');
                    });
                    break;

                case 'forgot-password':
                    document.getElementById('demo-forgot-send')?.addEventListener('click', () => {
                        const email = document.getElementById('demo-forgot-email')?.value;
                        if (email && email.includes('@')) {
                            showInteractiveToast('Verification code sent to your email');
                            setTimeout(() => showInteractiveScreen('forgot-password-verify'), 1000);
                        } else {
                            showInteractiveToast('‚ùå Please enter a valid email address', 'error');
                        }
                    });
                    document.getElementById('demo-forgot-back')?.addEventListener('click', () => {
                        goBack('login-password');
                    });
                    break;

                case 'forgot-password-verify':
                    const forgotResendBtn = document.getElementById('demo-forgot-resend');
                    forgotResendBtn?.addEventListener('click', () => {
                        showInteractiveToast('Verification code resent');
                        startCountdown(forgotResendBtn);
                    });
                    document.getElementById('demo-forgot-reset')?.addEventListener('click', () => {
                        const code = document.getElementById('demo-forgot-code')?.value;
                        const newPwd = document.getElementById('demo-forgot-new-pwd')?.value;
                        const confirmPwd = document.getElementById('demo-forgot-confirm-pwd')?.value;

                        if (!code) {
                            showInteractiveToast('‚ùå Please enter verification code', 'error');
                        } else if (code !== '123456') {
                            showInteractiveToast('‚ùå Incorrect verification code', 'error');
                        } else if (!newPwd || newPwd.length < 6) {
                            showInteractiveToast('‚ùå Password must be at least 6 characters', 'error');
                        } else if (newPwd !== confirmPwd) {
                            showInteractiveToast('‚ùå Passwords do not match', 'error');
                        } else {
                            showInteractiveToast('Password reset successful!');
                            setTimeout(() => {
                                // Check if user came from home (user center) or login flow
                                const previousPage = navigationHistory[0];
                                if (previousPage === 'home') {
                                    returnToDrawerOpen();
                                } else {
                                    showInteractiveScreen('login-password', false);
                                }
                                navigationHistory = [];  // Clear history after navigation
                            }, 1000);
                        }
                    });
                    document.getElementById('demo-forgot-verify-back')?.addEventListener('click', () => {
                        showInteractiveScreen('forgot-password', false);
                    });
                    break;

                case 'forgot-password-success':
                    document.getElementById('demo-goto-login')?.addEventListener('click', () => {
                        showInteractiveScreen('login');
                    });
                    break;

                case 'bluetooth':
                    document.getElementById('demo-back-home')?.addEventListener('click', () => {
                        showInteractiveScreen('home');
                    });
                    document.getElementById('demo-qr-scan')?.addEventListener('click', () => {
                        showInteractiveScreen('qr-scanner');
                    });
                    document.querySelectorAll('.device-item').forEach(item => {
                        item.addEventListener('click', () => {
                            showInteractiveToast('Device connected! Redirecting to home...');
                            setTimeout(() => showInteractiveScreen('home'), 1500);
                        });
                    });
                    break;

                case 'qr-scanner':
                    document.getElementById('demo-qr-back')?.addEventListener('click', () => {
                        showInteractiveScreen('bluetooth');
                    });
                    break;

                case 'home':
                    // Initialize interactive map
                    setTimeout(() => {
                        initInteractiveMap();
                        attachHomeListeners();
                        attachUserCenterListeners();
                    }, 100);
                    break;

                case 'profile':
                    document.getElementById('demo-profile-back')?.addEventListener('click', () => {
                        returnToDrawerOpen();
                    });

                    // Avatar selection
                    document.querySelectorAll('.icon-option').forEach(option => {
                        option.addEventListener('click', () => {
                            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                            option.classList.add('selected');
                        });
                    });

                    // UID copy button
                    document.getElementById('demo-copy-uid')?.addEventListener('click', () => {
                        navigator.clipboard.writeText('10240056').then(() => {
                            showInteractiveToast('‚úÖ UID copied to clipboard', 'success');
                        }).catch(() => {
                            showInteractiveToast('‚ùå Failed to copy UID', 'error');
                        });
                    });

                    document.getElementById('demo-profile-save')?.addEventListener('click', () => {
                        const nickname = document.getElementById('demo-profile-nickname')?.value || 'Not Set';
                        const selectedAvatar = document.querySelector('.icon-option.selected')?.dataset.avatar || 'ÂåóÊûÅÁáïÈ∏•.jpg';
                        showInteractiveToast('‚úÖ Profile updated successfully!', 'success');
                        // Store for home screen update
                        window.userProfile = { nickname, avatar: selectedAvatar };
                        setTimeout(() => returnToDrawerOpen(), 1500);
                    });
                    break;

                case 'language':
                    document.getElementById('demo-language-back')?.addEventListener('click', () => {
                        returnToDrawerOpen();
                    });

                    document.querySelectorAll('.language-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.querySelectorAll('.language-item').forEach(i => i.classList.remove('selected'));
                            item.classList.add('selected');
                            const langName = item.querySelector('.language-item-name').textContent;
                            showInteractiveToast(`Language set to ${langName}`, 'success');
                        });
                    });
                    break;

                case 'about':
                    document.getElementById('demo-about-back')?.addEventListener('click', () => {
                        returnToDrawerOpen();
                    });

                    document.getElementById('demo-check-update')?.addEventListener('click', () => {
                        const hasUpdate = Math.random() > 0.5;
                        if (hasUpdate) {
                            showUpdateModal();
                        } else {
                            showInteractiveToast('You are using the latest version', 'success');
                        }
                    });

                    document.getElementById('demo-delete-account-link')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        showInteractiveScreen('account-deletion');
                    });
                    break;

                case 'account-deletion':
                    let isCheckboxChecked = false;

                    document.getElementById('demo-account-deletion-back')?.addEventListener('click', () => {
                        goBack();
                    });

                    document.getElementById('demo-deletion-checkbox')?.addEventListener('click', () => {
                        isCheckboxChecked = !isCheckboxChecked;
                        const checkboxIcon = document.getElementById('demo-checkbox-icon');
                        const deleteBtn = document.getElementById('demo-delete-account-btn');

                        if (isCheckboxChecked) {
                            checkboxIcon.setAttribute('data-lucide', 'check-square');
                            deleteBtn.disabled = false;
                            deleteBtn.style.opacity = '1';
                            deleteBtn.style.cursor = 'pointer';
                        } else {
                            checkboxIcon.setAttribute('data-lucide', 'square');
                            deleteBtn.disabled = true;
                            deleteBtn.style.opacity = '0.5';
                            deleteBtn.style.cursor = 'not-allowed';
                        }

                        lucide.createIcons();
                    });

                    document.getElementById('demo-delete-account-btn')?.addEventListener('click', () => {
                        if (!isCheckboxChecked) return;

                        // ÂèëÈÄÅÈ™åËØÅÁ†ÅÂπ∂Ë∑≥ËΩ¨Âà∞È™åËØÅÈ°µÈù¢
                        showInteractiveToast('Verification code sent to your email', 'success');
                        setTimeout(() => {
                            showInteractiveScreen('account-deletion-verify');
                        }, 1000);
                    });
                    break;

                case 'account-deletion-verify':
                    // ÂÄíËÆ°Êó∂Áä∂ÊÄÅ
                    let resendCooldown = false;

                    // Back button
                    document.getElementById('demo-account-deletion-verify-back')?.addEventListener('click', () => {
                        goBack('account-deletion');
                    });

                    // Verify button
                    document.getElementById('demo-deletion-verify-btn')?.addEventListener('click', () => {
                        const code = document.getElementById('demo-deletion-verify-code')?.value;

                        if (!code) {
                            showInteractiveToast('‚ùå Please enter verification code', 'error');
                            return;
                        }

                        if (code.length !== 6) {
                            showInteractiveToast('‚ùå Verification code must be 6 digits', 'error');
                            return;
                        }

                        // Ê®°ÊãüÈ™åËØÅÁ†ÅÊ£ÄÊü•ÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫îËØ•Ë∞ÉÁî® APIÔºâ
                        if (code !== '123456') {
                            showInteractiveToast('‚ùå Incorrect verification code', 'error');
                            return;
                        }

                        // È™åËØÅÊàêÂäüÔºåÂà†Èô§Ë¥¶Êà∑
                        showInteractiveToast('Account deleted successfully. Logging out...', 'success');
                        setTimeout(() => {
                            navigationHistory = [];
                            showInteractiveScreen('login', false);
                        }, 2000);
                    });

                    // Resend button
                    document.getElementById('demo-deletion-resend-code')?.addEventListener('click', () => {
                        if (resendCooldown) return;

                        showInteractiveToast('Verification code resent to your email', 'success');
                        startCountdown(document.getElementById('demo-deletion-resend-code'));
                        resendCooldown = true;
                        setTimeout(() => { resendCooldown = false; }, 60000);
                    });

                    // Resend link
                    document.getElementById('demo-deletion-resend-link')?.addEventListener('click', () => {
                        if (resendCooldown) return;

                        showInteractiveToast('Verification code resent to your email', 'success');
                        startCountdown(document.getElementById('demo-deletion-resend-code'));
                        resendCooldown = true;
                        setTimeout(() => { resendCooldown = false; }, 60000);
                    });
                    break;

                case 'lost-mode-settings':
                    // Initialize or restore state from cache
                    if (!window.lostModeSettings) {
                        window.lostModeSettings = {
                            notificationEnabled: false,
                            reminderInterval: 5
                        };
                    }
                    let lostNotificationEnabled = window.lostModeSettings.notificationEnabled;
                    let reminderInterval = window.lostModeSettings.reminderInterval;
                    let trustedLocations = window.trustedLocations || [];

                    // Back button
                    document.getElementById('demo-lost-back')?.addEventListener('click', () => {
                        if (window.currentTag) {
                            showTagDetailView(window.currentTag);
                        } else {
                            goBack('home');
                        }
                    });

                    // Lost notification toggle
                    const lostToggle = document.getElementById('demo-lost-toggle');
                    const intervalSection = document.getElementById('demo-interval-section');
                    const trustedSection = document.getElementById('demo-trusted-locations-section');
                    const addLocationBtn = document.getElementById('demo-add-location');

                    // Restore toggle state
                    if (lostNotificationEnabled) {
                        lostToggle.classList.add('active');
                        intervalSection.style.opacity = '1';
                        intervalSection.style.pointerEvents = 'auto';
                        trustedSection.style.opacity = '1';
                        trustedSection.style.pointerEvents = 'auto';
                        addLocationBtn.disabled = false;
                    }

                    // Restore selected interval
                    document.querySelectorAll('.segment-option').forEach(option => {
                        if (parseInt(option.dataset.interval) === reminderInterval) {
                            option.classList.add('selected');
                        } else {
                            option.classList.remove('selected');
                        }
                    });

                    lostToggle?.addEventListener('click', () => {
                        lostNotificationEnabled = !lostNotificationEnabled;
                        lostToggle.classList.toggle('active');

                        // Update cache
                        window.lostModeSettings.notificationEnabled = lostNotificationEnabled;

                        // Enable/disable dependent sections
                        if (lostNotificationEnabled) {
                            intervalSection.style.opacity = '1';
                            intervalSection.style.pointerEvents = 'auto';
                            trustedSection.style.opacity = '1';
                            trustedSection.style.pointerEvents = 'auto';
                            addLocationBtn.disabled = false;
                            showInteractiveToast('‚úÖ Lost notification enabled');
                        } else {
                            intervalSection.style.opacity = '0.5';
                            intervalSection.style.pointerEvents = 'none';
                            trustedSection.style.opacity = '0.5';
                            trustedSection.style.pointerEvents = 'none';
                            addLocationBtn.disabled = true;
                            showInteractiveToast('Lost notification disabled');
                        }
                    });

                    // Segment control for interval
                    document.querySelectorAll('.segment-option').forEach(option => {
                        option.addEventListener('click', () => {
                            if (!lostNotificationEnabled) return;
                            document.querySelectorAll('.segment-option').forEach(o => o.classList.remove('selected'));
                            option.classList.add('selected');
                            reminderInterval = parseInt(option.dataset.interval);

                            // Update cache
                            window.lostModeSettings.reminderInterval = reminderInterval;

                            showInteractiveToast(`Reminder set to ${reminderInterval} minutes`);
                        });
                    });

                    // Add location button
                    addLocationBtn?.addEventListener('click', () => {
                        if (!lostNotificationEnabled) return;
                        showInteractiveScreen('add-trusted-location');
                    });

                    // Render existing locations
                    function renderLocations() {
                        const listContainer = document.getElementById('demo-trusted-list');
                        const emptyState = document.getElementById('demo-trusted-empty');

                        if (trustedLocations.length === 0) {
                            emptyState.style.display = 'block';
                            listContainer.style.display = 'none';
                        } else {
                            emptyState.style.display = 'none';
                            listContainer.style.display = 'block';
                            listContainer.innerHTML = trustedLocations.map((loc, index) => `
                                <div class="location-item">
                                    <div class="location-item-info">
                                        <div class="location-item-name">${loc.address}</div>
                                        <div class="location-item-detail">${loc.type === 'circle' ? `Circle ‚Ä¢ ${loc.radius}m radius` : `Polygon ‚Ä¢ ${loc.points.length} points`}</div>
                                    </div>
                                    <button class="location-item-delete" data-index="${index}">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            `).join('');

                            lucide.createIcons();

                            // Delete handlers
                            document.querySelectorAll('.location-item-delete').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const index = parseInt(btn.dataset.index);
                                    trustedLocations.splice(index, 1);
                                    window.trustedLocations = trustedLocations;
                                    renderLocations();
                                    showInteractiveToast('Location removed');
                                });
                            });
                        }
                    }

                    renderLocations();
                    break;

                case 'tag-info':
                    const currentTag = window.currentTag;
                    if (!currentTag) {
                        console.error('No tag context for tag-info screen');
                        goBack('home');
                        return;
                    }

                    const availableIcons = ['üîë', 'üéí', 'üöó', 'üì±', 'üíº', 'üéß', '‚åö', 'üëú', 'üè†', 'üö≤', 'üì∑', 'üíª'];
                    let selectedIcon = currentTag.icon;

                    // Populate tag info fields
                    document.getElementById('tag-info-icon-display').textContent = currentTag.icon;
                    const nameInput = document.getElementById('tag-info-name-input');
                    nameInput.value = currentTag.name;
                    document.getElementById('tag-info-mac').textContent = currentTag.mac;
                    document.getElementById('tag-info-location').textContent = `${currentTag.lat.toFixed(4)}¬∞ N, ${Math.abs(currentTag.lng).toFixed(4)}¬∞ W`;
                    document.getElementById('tag-info-last-update').textContent = currentTag.lastUpdate;
                    document.getElementById('tag-info-firmware').textContent = currentTag.firmwareVersion;

                    // Auto-save name on blur (when user finishes editing)
                    nameInput.addEventListener('blur', () => {
                        const newName = nameInput.value.trim();

                        if (!newName) {
                            showInteractiveToast('‚ùå Device name cannot be empty', 'error');
                            nameInput.value = currentTag.name; // Restore previous value
                            return;
                        }

                        if (newName !== currentTag.name) {
                            currentTag.name = newName;
                            showInteractiveToast('‚úÖ Name saved', 'success');
                        }
                    });

                    // Show firmware update badge if available
                    if (currentTag.hasUpdate) {
                        document.getElementById('firmware-update-badge').style.display = 'block';
                    }

                    // Populate icon grid
                    const iconGrid = document.getElementById('tag-info-icon-grid');
                    iconGrid.innerHTML = availableIcons.map(icon => `
                        <button class="tag-info-icon-option" data-icon="${icon}" style="font-size: 24px; width: 48px; height: 48px; background: ${icon === currentTag.icon ? 'rgba(58, 139, 255, 0.3)' : 'rgba(58, 139, 255, 0.1)'}; border: 1px solid ${icon === currentTag.icon ? 'rgba(58, 139, 255, 0.6)' : 'rgba(58, 139, 255, 0.2)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                            ${icon}
                        </button>
                    `).join('');

                    // Back button
                    document.getElementById('tag-info-back')?.addEventListener('click', () => {
                        showTagDetailView(currentTag);
                    });

                    // Change icon button
                    document.getElementById('tag-info-change-icon')?.addEventListener('click', () => {
                        const iconSelector = document.getElementById('tag-info-icon-selector');
                        iconSelector.style.display = iconSelector.style.display === 'none' ? 'block' : 'none';
                    });

                    // Icon selection with auto-save
                    document.querySelectorAll('.tag-info-icon-option').forEach(btn => {
                        btn.addEventListener('click', () => {
                            selectedIcon = btn.dataset.icon;
                            document.getElementById('tag-info-icon-display').textContent = selectedIcon;

                            // Highlight selected icon
                            document.querySelectorAll('.tag-info-icon-option').forEach(b => {
                                b.style.background = 'rgba(58, 139, 255, 0.1)';
                                b.style.borderColor = 'rgba(58, 139, 255, 0.2)';
                            });
                            btn.style.background = 'rgba(58, 139, 255, 0.3)';
                            btn.style.borderColor = 'rgba(58, 139, 255, 0.6)';

                            // Auto-save icon change
                            currentTag.icon = selectedIcon;
                            showInteractiveToast('‚úÖ Icon saved', 'success');

                            // Auto-hide icon selector after selection
                            setTimeout(() => {
                                document.getElementById('tag-info-icon-selector').style.display = 'none';
                            }, 500);
                        });

                        // Hover effect
                        btn.addEventListener('mouseenter', () => {
                            if (btn.dataset.icon !== selectedIcon) {
                                btn.style.background = 'rgba(58, 139, 255, 0.2)';
                            }
                        });
                        btn.addEventListener('mouseleave', () => {
                            if (btn.dataset.icon !== selectedIcon) {
                                btn.style.background = 'rgba(58, 139, 255, 0.1)';
                            }
                        });
                    });

                    // Check firmware button
                    document.getElementById('check-firmware-btn')?.addEventListener('click', () => {
                        if (currentTag.hasUpdate) {
                            // Navigate to firmware update screen
                            showInteractiveScreen('firmware-update');
                        } else {
                            showInteractiveToast('‚úÖ Firmware is up to date');
                        }
                    });

                    // Unbind button with confirmation modal
                    document.getElementById('tag-info-unbind')?.addEventListener('click', () => {
                        document.getElementById('unbind-modal').classList.add('active');
                    });

                    // Modal cancel button
                    document.getElementById('unbind-cancel')?.addEventListener('click', () => {
                        document.getElementById('unbind-modal').classList.remove('active');
                    });

                    // Modal confirm button
                    document.getElementById('unbind-confirm')?.addEventListener('click', () => {
                        document.getElementById('unbind-modal').classList.remove('active');
                        showInteractiveToast('‚úÖ Tag unbound successfully', 'success');
                        setTimeout(() => {
                            showInteractiveScreen('home');
                        }, 1000);
                    });

                    lucide.createIcons();
                    break;

                case 'firmware-update':
                    let isDownloaded = false;

                    // Populate OTA tags list with 4 demo tags
                    const otaTagsData = [
                        { id: 1, name: 'My Keys', icon: 'üîë', version: 'v0.1.0', battery: 85, scenario: 'success', isUpdated: false },
                        { id: 2, name: 'Backpack', icon: 'üéí', version: 'v0.1.0', battery: 45, scenario: 'connection-failed', isUpdated: false },
                        { id: 3, name: 'Car', icon: 'üöó', version: 'v0.1.0', battery: 20, scenario: 'low-battery', isUpdated: false },
                        { id: 4, name: 'Wallet', icon: 'üíº', version: 'v0.1.0', battery: 60, scenario: 'write-interrupted', isUpdated: false }
                    ];

                    // Function to attach event listeners to OTA update buttons
                    const attachOtaUpdateListeners = () => {
                        document.querySelectorAll('.ota-update-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                if (!isDownloaded) {
                                    showInteractiveToast('‚ùå Please download firmware first', 'error');
                                    return;
                                }

                                const tagId = parseInt(this.dataset.tagId);
                                const scenario = this.dataset.scenario;

                                // Disable button during update
                                this.disabled = true;

                                // Simulate OTA update based on scenario
                                setTimeout(() => {
                                    switch(scenario) {
                                        case 'success':
                                            // Success scenario
                                            showInteractiveToast('üîó Connecting to tag...');
                                            setTimeout(() => {
                                                showInteractiveToast('üîã Checking battery...');
                                                setTimeout(() => {
                                                    showInteractiveToast('üìù Writing firmware...');
                                                    setTimeout(() => {
                                                        showInteractiveToast('‚úÖ Update successful!');

                                                        // Mark tag as updated and re-render list
                                                        const tagData = otaTagsData.find(t => t.id === tagId);
                                                        if (tagData) {
                                                            tagData.isUpdated = true;
                                                            renderOtaTagsList();
                                                        }
                                                    }, 2000);
                                                }, 1000);
                                            }, 1000);
                                            break;

                                        case 'connection-failed':
                                            // Connection failed scenario
                                            showInteractiveToast('üîó Connecting to tag...');
                                            setTimeout(() => {
                                                showInteractiveToast('‚ùå Connection failed. Please ensure tag is nearby.', 'error');
                                                this.disabled = false;
                                            }, 2000);
                                            break;

                                        case 'low-battery':
                                            // Low battery scenario
                                            showInteractiveToast('üîó Connecting to tag...');
                                            setTimeout(() => {
                                                showInteractiveToast('üîã Checking battery...');
                                                setTimeout(() => {
                                                    showInteractiveToast('‚ùå Battery too low (< 30%). Please charge the tag first.', 'error');
                                                    this.disabled = false;
                                                }, 1000);
                                            }, 1000);
                                            break;

                                        case 'write-interrupted':
                                            // Write interrupted scenario
                                            showInteractiveToast('üîó Connecting to tag...');
                                            setTimeout(() => {
                                                showInteractiveToast('üîã Checking battery...');
                                                setTimeout(() => {
                                                    showInteractiveToast('üìù Writing firmware...');
                                                    setTimeout(() => {
                                                        showInteractiveToast('‚ùå Write interrupted. Tag moved out of range.', 'error');
                                                        this.disabled = false;
                                                    }, 1500);
                                                }, 1000);
                                            }, 1000);
                                            break;
                                    }
                                }, 500);
                            });
                        });
                    };

                    // Function to render OTA tags list
                    const renderOtaTagsList = () => {
                        // Sort tags: ÂèØÊõ¥Êñ∞ÁöÑ > Â∑≤Êõ¥Êñ∞ÁöÑ > ÊåâÂêçÂ≠óÊéíÂ∫è
                        otaTagsData.sort((a, b) => {
                            // Á¨¨‰∏Ä‰ºòÂÖàÁ∫ßÔºöÂèØÊõ¥Êñ∞ÁöÑÔºàÊú™Êõ¥Êñ∞ÁöÑÔºâÊéíÂâçÈù¢
                            if (!a.isUpdated && b.isUpdated) return -1;
                            if (a.isUpdated && !b.isUpdated) return 1;
                            // Á¨¨‰∫å‰ºòÂÖàÁ∫ßÔºöÂêåÁ∫ßÂà´ÂÜÖÊåâÂêçÂ≠óÊéíÂ∫è
                            return a.name.localeCompare(b.name);
                        });

                        const otaTagsList = document.getElementById('ota-tags-list');
                        otaTagsList.innerHTML = otaTagsData.map(tag => `
                            <div class="ota-tag-item" data-tag-id="${tag.id}" style="background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 16px; padding: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                        <span style="font-size: 24px;">${tag.icon}</span>
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <div style="color: #FFFFFF; font-weight: 600; font-size: 15px;">${tag.name}</div>
                                                <!-- ÁîµÈáèÂõæÊ†áÁ¥ßË∑üÂú®ÂêçÂ≠óÂêéÈù¢ -->
                                                <span class="battery-badge ${tag.battery <= 30 ? 'low' : tag.battery <= 60 ? 'medium' : ''}" data-battery="${tag.battery}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="battery-icon">
                                                        <path d="M 25 14 L 25 10"></path>
                                                        <rect x="0" y="6" width="22" height="12" rx="2"></rect>
                                                    </svg>
                                                </span>
                                            </div>
                                            <div style="color: #8B94A4; font-size: 12px;">${tag.isUpdated ? 'v1.1.0 (Up to date)' : tag.version + ' ‚Üí v1.1.0'}</div>
                                        </div>
                                    </div>
                                    <!-- Update ÊåâÈíÆÔºà‰∏ãËΩΩÂÆåÊàêÂêéÊòæÁ§∫ÔºåÂ∑≤Êõ¥Êñ∞ÁöÑ‰∏çÊòæÁ§∫Ôºâ -->
                                    <button class="icon-btn ota-update-btn" data-tag-id="${tag.id}" data-scenario="${tag.scenario}" style="display: ${tag.isUpdated ? 'none' : (isDownloaded ? 'flex' : 'none')}; width: 36px; height: 36px;">
                                        <i data-lucide="hard-drive-download"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('');

                        // Re-attach event listeners
                        attachOtaUpdateListeners();
                        lucide.createIcons();
                    };

                    // Initial render
                    renderOtaTagsList();

                    // Back button
                    document.getElementById('firmware-back')?.addEventListener('click', () => {
                        goBack('tag-info');
                    });

                    // Pre-download button
                    document.getElementById('pre-download-btn')?.addEventListener('click', () => {
                        const downloadBtn = document.getElementById('pre-download-btn');
                        const downloadProgress = document.getElementById('download-progress');
                        const downloadFill = document.getElementById('download-fill');
                        const downloadPercent = document.getElementById('download-percent');
                        const downloadStatus = document.getElementById('download-status');

                        downloadBtn.style.display = 'none';
                        downloadProgress.style.display = 'block';

                        // Simulate download progress
                        let progress = 0;
                        const downloadInterval = setInterval(() => {
                            progress += 5;
                            downloadFill.style.width = progress + '%';
                            downloadPercent.textContent = progress + '%';

                            if (progress >= 100) {
                                clearInterval(downloadInterval);
                                isDownloaded = true;
                                downloadStatus.textContent = 'Download completed';
                                setTimeout(() => {
                                    showInteractiveToast('‚úÖ Firmware downloaded successfully');
                                    // Show all update buttons
                                    document.querySelectorAll('.ota-update-btn').forEach(btn => {
                                        btn.style.display = 'flex';
                                    });
                                }, 300);
                            }
                        }, 100);
                    });

                    lucide.createIcons();
                    break;

                case 'add-trusted-location':
                    let trustedLocationMap;
                    let selectedCenter = null;
                    let circleLayer = null;
                    let polygonPoints = [];
                    let polygonMarkers = [];
                    let polygonLayer = null;
                    let fenceType = 'circle';
                    let radius = 500;
                    let currentLocationAddress = '';

                    setTimeout(() => {
                        // Initialize map
                        trustedLocationMap = L.map('demo-trusted-location-map', {
                            center: [22.5431, 114.0579],
                            zoom: 15,
                            zoomControl: false,
                            attributionControl: false
                        });

                        L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                            subdomains: ['1', '2', '3', '4'],
                            attribution: '&copy; È´òÂæ∑Âú∞Âõæ',
                            maxZoom: 19
                        }).addTo(trustedLocationMap);

                        // Map click handler
                        trustedLocationMap.on('click', (e) => {
                            const latlng = e.latlng;

                            if (fenceType === 'circle') {
                                // Circle mode: update center
                                selectedCenter = latlng;
                                updateCircle();
                                updateAddress(latlng);
                            } else {
                                // Polygon mode: add point
                                addPolygonPoint(latlng);
                                if (polygonPoints.length === 1) {
                                    updateAddress(latlng);
                                }
                            }
                        });

                        function updateCircle() {
                            if (circleLayer) {
                                trustedLocationMap.removeLayer(circleLayer);
                            }
                            if (selectedCenter) {
                                circleLayer = L.circle(selectedCenter, {
                                    radius: radius,
                                    color: '#3A8BFF',
                                    fillColor: '#3A8BFF',
                                    fillOpacity: 0.2,
                                    weight: 2
                                }).addTo(trustedLocationMap);
                            }
                        }

                        function addPolygonPoint(latlng) {
                            polygonPoints.push(latlng);

                            // Add marker
                            const marker = L.circleMarker(latlng, {
                                radius: 6,
                                color: '#3A8BFF',
                                fillColor: '#FFFFFF',
                                fillOpacity: 1,
                                weight: 2
                            }).addTo(trustedLocationMap);
                            polygonMarkers.push(marker);

                            // Update polygon
                            if (polygonLayer) {
                                trustedLocationMap.removeLayer(polygonLayer);
                            }
                            if (polygonPoints.length >= 3) {
                                polygonLayer = L.polygon(polygonPoints, {
                                    color: '#3A8BFF',
                                    fillColor: '#3A8BFF',
                                    fillOpacity: 0.2,
                                    weight: 2
                                }).addTo(trustedLocationMap);
                            } else if (polygonPoints.length === 2) {
                                // Draw line between 2 points
                                polygonLayer = L.polyline(polygonPoints, {
                                    color: '#3A8BFF',
                                    weight: 2,
                                    dashArray: '5, 5'
                                }).addTo(trustedLocationMap);
                            }

                            // Enable clear button
                            document.getElementById('demo-clear-polygon').disabled = false;
                        }

                        function updateAddress(latlng) {
                            // Get random address from mock data
                            currentLocationAddress = getRandomAddress();
                            document.getElementById('demo-selected-address').textContent = currentLocationAddress;
                        }

                        // Fence type toggle
                        document.getElementById('demo-fence-circle')?.addEventListener('click', () => {
                            fenceType = 'circle';
                            document.getElementById('demo-fence-circle').classList.add('selected');
                            document.getElementById('demo-fence-polygon').classList.remove('selected');
                            document.getElementById('demo-radius-control').style.display = 'block';
                            document.getElementById('demo-polygon-instructions').style.display = 'none';

                            // Clear polygon layers
                            polygonMarkers.forEach(m => trustedLocationMap.removeLayer(m));
                            if (polygonLayer) trustedLocationMap.removeLayer(polygonLayer);
                            polygonPoints = [];
                            polygonMarkers = [];
                            currentLocationAddress = '';
                            document.getElementById('demo-selected-address').textContent = 'Tap on map to select location';
                        });

                        document.getElementById('demo-fence-polygon')?.addEventListener('click', () => {
                            fenceType = 'polygon';
                            document.getElementById('demo-fence-polygon').classList.add('selected');
                            document.getElementById('demo-fence-circle').classList.remove('selected');
                            document.getElementById('demo-radius-control').style.display = 'none';
                            document.getElementById('demo-polygon-instructions').style.display = 'block';

                            // Clear circle layer
                            if (circleLayer) trustedLocationMap.removeLayer(circleLayer);
                            selectedCenter = null;
                            currentLocationAddress = '';
                            document.getElementById('demo-selected-address').textContent = 'Tap on map to select location';
                        });

                        // Radius slider
                        document.getElementById('demo-radius-slider')?.addEventListener('input', (e) => {
                            radius = parseInt(e.target.value);
                            document.getElementById('demo-radius-value').textContent = `${radius}m`;
                            updateCircle();
                        });

                        // Clear polygon button
                        document.getElementById('demo-clear-polygon')?.addEventListener('click', () => {
                            polygonMarkers.forEach(m => trustedLocationMap.removeLayer(m));
                            if (polygonLayer) trustedLocationMap.removeLayer(polygonLayer);
                            polygonPoints = [];
                            polygonMarkers = [];
                            polygonLayer = null;
                            currentLocationAddress = '';
                            document.getElementById('demo-clear-polygon').disabled = true;
                            document.getElementById('demo-selected-address').textContent = 'Tap on map to select location';
                            showInteractiveToast('Points cleared');
                        });

                        lucide.createIcons();
                    }, 100);

                    // Back button
                    document.getElementById('demo-add-location-back')?.addEventListener('click', () => {
                        goBack('lost-mode-settings');
                    });

                    // Save button
                    document.getElementById('demo-add-location-save')?.addEventListener('click', () => {
                        if (fenceType === 'circle' && !selectedCenter) {
                            showInteractiveToast('‚ùå Please select a location on the map', 'error');
                            return;
                        }
                        if (fenceType === 'polygon' && polygonPoints.length < 3) {
                            showInteractiveToast('‚ùå Polygon requires at least 3 points', 'error');
                            return;
                        }

                        const location = {
                            type: fenceType,
                            address: currentLocationAddress || getRandomAddress(),
                            center: selectedCenter,
                            radius: radius,
                            points: polygonPoints.map(p => [p.lat, p.lng])
                        };

                        if (!window.trustedLocations) {
                            window.trustedLocations = [];
                        }
                        window.trustedLocations.push(location);

                        showInteractiveToast('‚úÖ Trusted location added');
                        setTimeout(() => goBack('lost-mode-settings'), 1000);
                    });
                    break;

                case 'path-datepicker':
                    // Initialize calendar
                    const today = new Date();
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                    document.getElementById('calendar-month-year').textContent = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    renderCalendar(today.getFullYear(), today.getMonth());

                    // Set default to today
                    setQuickRange('today');

                    // Back button
                    document.getElementById('demo-path-picker-back')?.addEventListener('click', function() {
                        goBack('home');
                        this.blur();
                    });

                    // Quick select buttons
                    document.querySelectorAll('.quick-select-btn:not(.disabled)').forEach(btn => {
                        btn.addEventListener('click', function() {
                            // Remove selected from all
                            document.querySelectorAll('.quick-select-btn').forEach(b => b.classList.remove('selected'));
                            // Add selected to clicked
                            this.classList.add('selected');
                            // Set range
                            setQuickRange(this.dataset.range);
                        });
                    });

                    // Disabled week button shows toast
                    document.querySelector('[data-range="past7d"]')?.addEventListener('click', () => {
                        showInteractiveToast('üì∫ Watch ad to unlock this week\'s history');
                    });

                    // Month navigation
                    let currentMonth = today.getMonth();
                    let currentYear = today.getFullYear();

                    document.getElementById('prev-month')?.addEventListener('click', () => {
                        currentMonth--;
                        if (currentMonth < 0) {
                            currentMonth = 11;
                            currentYear--;
                        }
                        renderCalendar(currentYear, currentMonth);
                        document.getElementById('calendar-month-year').textContent =
                            `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                    });

                    document.getElementById('next-month')?.addEventListener('click', () => {
                        currentMonth++;
                        if (currentMonth > 11) {
                            currentMonth = 0;
                            currentYear++;
                        }
                        renderCalendar(currentYear, currentMonth);
                        document.getElementById('calendar-month-year').textContent =
                            `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                    });

                    // Time picker trigger (opens modal with both times)
                    document.getElementById('start-time-trigger')?.addEventListener('click', () => {
                        initTimeWheelPicker();
                    });

                    document.getElementById('end-time-trigger')?.addEventListener('click', () => {
                        initTimeWheelPicker();
                    });

                    // Time picker modal controls
                    document.getElementById('time-picker-close')?.addEventListener('click', closeTimeWheelPicker);
                    document.getElementById('time-picker-confirm')?.addEventListener('click', confirmTimeSelection);

                    // Close modal on background click
                    document.getElementById('time-wheel-picker-modal')?.addEventListener('click', (e) => {
                        if (e.target.id === 'time-wheel-picker-modal') {
                            closeTimeWheelPicker();
                        }
                    });

                    // View path button
                    document.getElementById('view-path-btn')?.addEventListener('click', () => {
                        if (!selectedStartDate) {
                            showInteractiveToast('Please select a date range', 'error');
                            return;
                        }

                        showInteractiveScreen('path-view');
                    });
                    break;

                case 'path-view':
                    // Initialize map after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        initPathViewMap();
                    }, 100);

                    // Back button
                    document.getElementById('demo-path-view-back')?.addEventListener('click', function() {
                        // If we came from history-point, skip back to path-datepicker
                        if (cameFromHistory) {
                            cameFromHistory = false; // Reset flag
                            showInteractiveScreen('path-datepicker', false);
                        } else {
                            goBack('path-datepicker');
                        }
                        this.blur();
                    });

                    // Map controls
                    document.getElementById('demo-path-zoom-in')?.addEventListener('click', function() {
                        if (pathMap) pathMap.zoomIn();
                        this.blur();
                    });

                    document.getElementById('demo-path-zoom-out')?.addEventListener('click', function() {
                        if (pathMap) pathMap.zoomOut();
                        this.blur();
                    });

                    document.getElementById('demo-path-center')?.addEventListener('click', function() {
                        if (pathMap && userLocation) {
                            pathMap.setView([userLocation.lat, userLocation.lng], 15, {
                                animate: true,
                                duration: 0.5
                            });
                        }
                        this.blur();
                    });

                    document.getElementById('demo-path-list')?.addEventListener('click', function() {
                        cameFromHistory = false; // Reset flag when navigating to history normally
                        showInteractiveScreen('history-point');
                        this.blur();
                    });

                    // Tooltip navigation
                    document.getElementById('tooltip-prev')?.addEventListener('click', function() {
                        navigatePoints(-1);
                        this.blur();
                    });

                    document.getElementById('tooltip-next')?.addEventListener('click', function() {
                        navigatePoints(1);
                        this.blur();
                    });

                    // Copy address
                    document.getElementById('tooltip-copy-address')?.addEventListener('click', async function() {
                        const address = document.getElementById('tooltip-address')?.textContent;
                        if (address) {
                            try {
                                await navigator.clipboard.writeText(address);
                                showInteractiveToast('üìã Address copied');
                            } catch (e) {
                                showInteractiveToast('Failed to copy address', 'error');
                            }
                        }
                        this.blur();
                    });

                    // Navigate button
                    document.getElementById('tooltip-navigate')?.addEventListener('click', () => {
                        const modal = document.getElementById('demo-nav-modal-overlay');
                        if (modal) {
                            modal.classList.add('active');
                        }
                    });

                    // Navigation modal handlers
                    document.getElementById('demo-nav-google')?.addEventListener('click', () => {
                        showInteractiveToast('üó∫Ô∏è Opening Google Maps...');
                        document.getElementById('demo-nav-modal-overlay')?.classList.remove('active');
                    });

                    document.getElementById('demo-nav-amap')?.addEventListener('click', () => {
                        showInteractiveToast('üìç Opening È´òÂæ∑Âú∞Âõæ...');
                        document.getElementById('demo-nav-modal-overlay')?.classList.remove('active');
                    });

                    document.getElementById('demo-nav-baidu')?.addEventListener('click', () => {
                        showInteractiveToast('üß≠ Opening ÁôæÂ∫¶Âú∞Âõæ...');
                        document.getElementById('demo-nav-modal-overlay')?.classList.remove('active');
                    });

                    document.getElementById('demo-nav-cancel')?.addEventListener('click', () => {
                        document.getElementById('demo-nav-modal-overlay')?.classList.remove('active');
                    });

                    // Close modal on overlay click
                    document.getElementById('demo-nav-modal-overlay')?.addEventListener('click', (e) => {
                        if (e.target.id === 'demo-nav-modal-overlay') {
                            e.target.classList.remove('active');
                        }
                    });
                    break;

                case 'history-point':
                    renderHistoryPointsList();

                    // Back button
                    document.getElementById('demo-history-point-back')?.addEventListener('click', function() {
                        goBack('path-view');
                        this.blur();
                    });
                    break;
            }
        }

        function initInteractiveMap() {
            const mapElement = document.getElementById('demo-map');
            if (!mapElement) return;

            // Clean up existing map if it exists
            if (interactiveMap) {
                interactiveMap.remove();
                interactiveMap = null;
            }

            interactiveMap = L.map('demo-map', {
                center: [22.5431, 114.0579],
                zoom: 15,
                zoomControl: false,
                attributionControl: false
            });

            // Use AMap tiles
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '&copy; È´òÂæ∑Âú∞Âõæ',
                maxZoom: 19
            }).addTo(interactiveMap);

            // Add scale bar
            L.control.scale({
                position: 'bottomleft',
                imperial: false,
                metric: true
            }).addTo(interactiveMap);

            // Add user marker
            const userIcon = L.divIcon({
                className: 'user-marker-icon',
                iconSize: [20, 20]
            });
            userMarker = L.marker([22.5431, 114.0579], { icon: userIcon }).addTo(interactiveMap);

            // Add tag markers
            tagMarkers = mockTags.map(tag => {
                const tagIcon = L.divIcon({
                    className: 'tag-marker-icon',
                    html: tag.icon,
                    iconSize: [32, 32]
                });
                const marker = L.marker([tag.lat, tag.lng], { icon: tagIcon }).addTo(interactiveMap);

                // Bind popup with custom content
                const popupContent = `
                    <div class="popup-tag-name">${tag.icon} ${tag.name}</div>
                    <div class="popup-tag-info">${tag.address}</div>
                    <div class="popup-tag-info">Updated ${tag.lastUpdate}</div>
                    <div class="popup-tag-distance" style="margin-top: 8px;">${tag.distance}</div>
                `;
                marker.bindPopup(popupContent, {
                    closeButton: true,
                    maxWidth: 250,
                    className: 'custom-popup'
                });

                return marker;
            });
        }

        function attachHomeListeners() {
            // Banner notification close button
            const bannerCloseBtn = document.getElementById('demo-banner-close');
            if (bannerCloseBtn) {
                bannerCloseBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const banner = document.getElementById('demo-tag-loss-banner');
                    if (banner) {
                        banner.classList.add('hidden');
                        showInteractiveToast('ÈÄöÁü•Â∑≤ÂÖ≥Èó≠');
                    }
                });
            }

            // Zoom controls
            document.getElementById('demo-zoom-in')?.addEventListener('click', () => {
                if (interactiveMap) {
                    interactiveMap.zoomIn();
                    showInteractiveToast('Zooming in...');
                }
            });
            document.getElementById('demo-zoom-out')?.addEventListener('click', () => {
                if (interactiveMap) {
                    interactiveMap.zoomOut();
                    showInteractiveToast('Zooming out...');
                }
            });
            document.getElementById('demo-center')?.addEventListener('click', () => {
                if (interactiveMap) {
                    interactiveMap.setView([22.5431, 114.0579], 15);
                    showInteractiveToast('Centering on your location...');
                }
            });

            // Add device button
            document.getElementById('demo-add-device')?.addEventListener('click', () => {
                showInteractiveScreen('bluetooth');
            });

            // Refresh button
            document.getElementById('demo-refresh')?.addEventListener('click', () => {
                showInteractiveToast('Refreshing tags...');
            });

            // Drawer handle
            let drawerExpanded = false;
            document.getElementById('demo-drawer-handle')?.addEventListener('click', () => {
                const drawer = document.getElementById('demo-drawer');
                if (drawerExpanded) {
                    drawer.style.height = '281px';
                    drawerExpanded = false;
                } else {
                    drawer.style.height = '500px';
                    drawerExpanded = true;
                }
            });

            // Tag item click functionality
            const tagWrappers = document.querySelectorAll('.tag-item-wrapper');
            tagWrappers.forEach(wrapper => {
                wrapper.addEventListener('click', () => {
                    const tagId = wrapper.dataset.tagId;
                    const tag = mockTags.find(t => t.id == tagId);
                    showTagDetailView(tag);
                });
            });
        }


        function showTagDetailView(tag) {
            // Find current tag index
            const currentIndex = mockTags.findIndex(t => t.id === tag.id);
            const totalTags = mockTags.length;

            // Determine battery badge class based on battery level
            const batteryClass = tag.battery <= 30 ? 'low' : tag.battery <= 60 ? 'medium' : '';

            const content = document.getElementById('interactive-content');
            content.innerHTML = `
                <div style="position: relative; height: 100%; overflow: hidden;">
                    <!-- <button class="icon-btn back-btn" id="demo-tag-detail-back" style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
                        <i data-lucide="arrow-left"></i>
                    </button> -->

                    <!-- Map focused on tag -->
                    <div class="map-container" style="height: 644px; position: relative;">
                        <div id="demo-tag-detail-map" style="width: 100%; height: 100%;"></div>

                        <div class="map-controls">
                            <button class="control-btn" id="demo-tag-zoom-in">
                                <i data-lucide="plus"></i>
                            </button>
                            <button class="control-btn" id="demo-tag-zoom-out">
                                <i data-lucide="minus"></i>
                            </button>
                            <button class="control-btn" id="demo-tag-center">
                                <i data-lucide="locate-fixed"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Tag Info Drawer -->
                    <div class="drawer" style="height: auto;">
                        <div style="padding: 20px;">
                            <!-- 1. Top Control Bar: MAC Switching + Action Buttons -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <button class="icon-btn" id="demo-tag-prev" style="width: 36px; height: 36px;">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                                <div id="tag-mac-display" class="text-body poppins" style="height: 36px; width: 180px; display: flex; align-items: center; justify-content: center; padding: 0 16px; background: rgba(26, 31, 34, var(--alpha-glass-bg)); backdrop-filter: blur(10px); border-radius: var(--radius-xs); border: 1px solid rgba(58, 139, 255, 0.3); color: var(--color-text-muted); cursor: pointer; letter-spacing: 0.5px; font-size: 13px;">
                                    ${tag.mac}
                                </div>
                                <button class="icon-btn" id="demo-tag-next" style="width: 36px; height: 36px;">
                                    <i data-lucide="chevron-right"></i>
                                </button>
                                <button class="icon-btn" id="demo-tag-share" style="width: 36px; height: 36px;">
                                    <i data-lucide="external-link"></i>
                                </button>
                                <button class="icon-btn" id="demo-tag-detail-close" style="width: 36px; height: 36px;">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>

                            <!-- 2. Tag Info -->
                            <div id="tag-info-swipeable" style="margin-bottom: 16px; touch-action: pan-y; transition: opacity 0.3s ease;">
                                <h3 class="title-secondary" style="font-size: 22px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                    <div style="font-size: 30px;">${tag.icon}</div>
                                    <span>${tag.name}</span>
                                    <span class="battery-badge ${batteryClass}" data-battery="${tag.battery}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="battery-icon">
                                            <path d="M 25 14 L 25 10"></path>
                                            <rect x="0" y="6" width="22" height="12" rx="2"></rect>
                                        </svg>
                                    </span>
                                </h3>
                                <div class="text-body" style="font-size: 13px; margin-bottom: 4px; width: 100%;">${tag.address}</div>
                                <div class="text-body" style="font-size: 12px;">‚Ä¢ ${tag.lastUpdate}</div>
                            </div>

                            <!-- 3. Action Buttons Grid -->
                            <div style="display: flex; justify-content: space-between; gap: 8px;">
                                <button class="tag-action-btn" id="demo-tag-nav" data-action="nav">
                                    <div class="tag-action-icon" style="background: linear-gradient(135deg, #3A8BFF 0%, #2563EB 100%);">
                                        <i data-lucide="navigation"></i>
                                    </div>
                                    <span>Nav</span>
                                </button>
                                <button class="tag-action-btn" id="demo-tag-ring" data-action="ring">
                                    <div class="tag-action-icon" style="background: linear-gradient(135deg, #FF9E4A 0%, #F97316 100%);">
                                        <i data-lucide="bell"></i>
                                    </div>
                                    <span>Ring</span>
                                </button>
                                <button class="tag-action-btn" id="demo-tag-path" data-action="path">
                                    <div class="tag-action-icon" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
                                        <i data-lucide="waypoints"></i>
                                    </div>
                                    <span>Path</span>
                                </button>
                                <button class="tag-action-btn" id="demo-tag-lost" data-action="lost">
                                    <div class="tag-action-icon" style="background: linear-gradient(135deg, #EC6C70 0%, #E43B41 100%);">
                                        <i data-lucide="alert-triangle"></i>
                                    </div>
                                    <span>Lost</span>
                                </button>
                                <button class="tag-action-btn" id="demo-tag-fence" data-action="fence">
                                    <div class="tag-action-icon" style="background: linear-gradient(135deg, #06B6D4 0%, #0891B2 100%);">
                                        <i data-lucide="map-pinned"></i>
                                    </div>
                                    <span>Fence</span>
                                </button>
                                <button class="tag-action-btn" id="demo-tag-info" data-action="info">
                                    <div class="tag-action-icon" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); position: relative;">
                                        <i data-lucide="info"></i>
                                        ${tag.hasUpdate ? '<span class="update-badge"></span>' : ''}
                                    </div>
                                    <span>Info</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation App Modal -->
                    <div class="modal-overlay" id="demo-nav-modal-overlay">
                        <div class="modal-content">
                            <h3 class="title-secondary" style="font-size: 20px; margin-bottom: 20px; text-align: center;">
                                Choose Navigation App
                            </h3>
                            <button class="btn-secondary" style="margin-bottom: 12px; text-align: left; padding-left: 24px;" id="demo-nav-google">
                                <i data-lucide="map"></i>
                                Google Maps
                            </button>
                            <button class="btn-secondary" style="margin-bottom: 12px; text-align: left; padding-left: 24px;" id="demo-nav-amap">
                                <i data-lucide="map-pin"></i>
                                È´òÂæ∑Âú∞Âõæ
                            </button>
                            <button class="btn-secondary" style="margin-bottom: 20px; text-align: left; padding-left: 24px;" id="demo-nav-baidu">
                                <i data-lucide="compass"></i>
                                ÁôæÂ∫¶Âú∞Âõæ
                            </button>
                            <button class="btn-secondary" id="demo-nav-cancel">Cancel</button>
                        </div>
                    </div>

                    <!-- Ring Modal -->
                    <div class="modal-overlay" id="demo-tag-ring-modal-overlay">
                        <div class="modal-content">
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="font-size: 64px; margin-bottom: 16px; animation: pulse 2s ease-in-out infinite;">üîî</div>
                                <h3 class="title-secondary" style="font-size: 20px; margin-bottom: 8px;">Ring Tag?</h3>
                                <p class="text-body" style="font-size: 14px;">Your tag will beep to help you locate it</p>
                            </div>

                            <div style="display: flex; gap: 12px;">
                                <button class="btn-secondary" style="flex: 1;" id="demo-tag-ring-cancel">Cancel</button>
                                <button class="btn-primary btn-breathing" style="flex: 1;" id="demo-tag-ring-now">
                                    <i data-lucide="bell"></i>
                                    Ring Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize icons
            lucide.createIcons();

            // Initialize map focused on tag
            setTimeout(() => {
                const detailMap = L.map('demo-tag-detail-map', {
                    center: [tag.lat, tag.lng],
                    zoom: 16,
                    zoomControl: false,
                    attributionControl: false
                });

                L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                    subdomains: ['1', '2', '3', '4'],
                    attribution: '&copy; È´òÂæ∑Âú∞Âõæ',
                    maxZoom: 19
                }).addTo(detailMap);

                // Add scale bar
                L.control.scale({
                    position: 'bottomleft',
                    imperial: false,
                    metric: true
                }).addTo(detailMap);

                // Add tag marker
                const tagMarkerDiv = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="font-size: 32px;">${tag.icon}</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });
                L.marker([tag.lat, tag.lng], { icon: tagMarkerDiv }).addTo(detailMap);

                // Add user marker
                const userMarkerDiv = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="width: 16px; height: 16px; background: #3A8BFF; border: 3px solid #FFFFFF; border-radius: 50%;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                L.marker([37.7749, -122.4194], { icon: userMarkerDiv }).addTo(detailMap);

                // Tag switching functions
                const switchToTag = (newIndex) => {
                    if (newIndex >= 0 && newIndex < mockTags.length) {
                        const tagInfoDiv = document.getElementById('tag-info-swipeable');
                        tagInfoDiv.style.opacity = '0';
                        setTimeout(() => {
                            showTagDetailView(mockTags[newIndex]);
                        }, 200);
                    }
                };

                // Previous/Next button listeners with circular navigation
                document.getElementById('demo-tag-prev')?.addEventListener('click', () => {
                    const currentIndex = mockTags.findIndex(t => t.id === tag.id);
                    // Circular: if at first tag, go to last tag
                    const newIndex = currentIndex === 0 ? mockTags.length - 1 : currentIndex - 1;
                    switchToTag(newIndex);
                });

                document.getElementById('demo-tag-next')?.addEventListener('click', () => {
                    const currentIndex = mockTags.findIndex(t => t.id === tag.id);
                    // Circular: if at last tag, go to first tag
                    const newIndex = currentIndex === mockTags.length - 1 ? 0 : currentIndex + 1;
                    switchToTag(newIndex);
                });

                const macDisplay = document.getElementById('tag-mac-display');
                macDisplay?.addEventListener('click', async () => {
                    const text = tag.mac;
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(text);
                        } else {
                            const ta = document.createElement('textarea');
                            ta.value = text;
                            document.body.appendChild(ta);
                            ta.select();
                            document.execCommand('copy');
                            document.body.removeChild(ta);
                        }
                        showInteractiveToast('Â∑≤Â§çÂà∂ MACÔºö' + text);
                    } catch (e) {
                        showInteractiveToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
                    }
                });


                // Swipe gesture support with circular navigation
                const swipeableArea = document.getElementById('tag-info-swipeable');
                let touchStartX = 0;
                let touchEndX = 0;

                swipeableArea?.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                }, { passive: true });

                swipeableArea?.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].clientX;
                    const diff = touchEndX - touchStartX;
                    const currentIndex = mockTags.findIndex(t => t.id === tag.id);

                    // Swipe right (previous tag) - circular
                    if (diff > 50) {
                        const newIndex = currentIndex === 0 ? mockTags.length - 1 : currentIndex - 1;
                        switchToTag(newIndex);
                    }
                    // Swipe left (next tag) - circular
                    else if (diff < -50) {
                        const newIndex = currentIndex === mockTags.length - 1 ? 0 : currentIndex + 1;
                        switchToTag(newIndex);
                    }
                }, { passive: true });

                // Attach event listeners
                // document.getElementById('demo-tag-detail-back')?.addEventListener('click', () => {
                //     showInteractiveScreen('home');
                // });

                document.getElementById('demo-tag-detail-close')?.addEventListener('click', () => {
                    showInteractiveScreen('home');
                });

                // Action buttons
                document.getElementById('demo-tag-nav')?.addEventListener('click', () => {
                    document.getElementById('demo-nav-modal-overlay').classList.add('active');
                });

                document.getElementById('demo-tag-ring')?.addEventListener('click', () => {
                    document.getElementById('demo-tag-ring-modal-overlay').classList.add('active');
                });

                document.getElementById('demo-tag-path')?.addEventListener('click', () => {
                    window.currentTag = tag;  // Store tag context
                    showInteractiveScreen('path-datepicker');
                });

                document.getElementById('demo-tag-share')?.addEventListener('click', () => {
                    showInteractiveToast('üîó Share feature coming soon');
                });

                document.getElementById('demo-tag-lost')?.addEventListener('click', () => {
                    window.currentTag = tag;  // Store tag context
                    showInteractiveScreen('lost-mode-settings');
                });

                document.getElementById('demo-tag-fence')?.addEventListener('click', () => {
                    showInteractiveToast('üó∫Ô∏è Geo-fence feature coming soon');
                });

                document.getElementById('demo-tag-info')?.addEventListener('click', () => {
                    window.currentTag = tag;  // Store tag context
                    showInteractiveScreen('tag-info');
                });

                // Map controls
                document.getElementById('demo-tag-zoom-in')?.addEventListener('click', () => {
                    detailMap.zoomIn();
                });

                document.getElementById('demo-tag-zoom-out')?.addEventListener('click', () => {
                    detailMap.zoomOut();
                });

                document.getElementById('demo-tag-center')?.addEventListener('click', () => {
                    detailMap.setView([tag.lat, tag.lng], 16);
                });

                // Ring modal - Cancel button
                document.getElementById('demo-tag-ring-cancel')?.addEventListener('click', () => {
                    document.getElementById('demo-tag-ring-modal-overlay').classList.remove('active');
                });

                // Ring modal - Ring Now button
                document.getElementById('demo-tag-ring-now')?.addEventListener('click', () => {
                    document.getElementById('demo-tag-ring-modal-overlay').classList.remove('active');
                    showInteractiveToast('üîî Ringing ' + tag.name + '...');
                });

                // Ring modal - Close when clicking overlay
                document.getElementById('demo-tag-ring-modal-overlay')?.addEventListener('click', (e) => {
                    if (e.target.id === 'demo-tag-ring-modal-overlay') {
                        e.target.classList.remove('active');
                    }
                });

                // Navigation app selection handlers
                document.getElementById('demo-nav-google')?.addEventListener('click', () => {
                    document.getElementById('demo-nav-modal-overlay').classList.remove('active');
                    showInteractiveToast('Opening Google Maps for ' + tag.name);
                });

                document.getElementById('demo-nav-amap')?.addEventListener('click', () => {
                    document.getElementById('demo-nav-modal-overlay').classList.remove('active');
                    showInteractiveToast('Opening È´òÂæ∑Âú∞Âõæ for ' + tag.name);
                });

                document.getElementById('demo-nav-baidu')?.addEventListener('click', () => {
                    document.getElementById('demo-nav-modal-overlay').classList.remove('active');
                    showInteractiveToast('Opening ÁôæÂ∫¶Âú∞Âõæ for ' + tag.name);
                });

                document.getElementById('demo-nav-cancel')?.addEventListener('click', () => {
                    document.getElementById('demo-nav-modal-overlay').classList.remove('active');
                });

                // Close modal when clicking overlay
                document.getElementById('demo-nav-modal-overlay')?.addEventListener('click', (e) => {
                    if (e.target.id === 'demo-nav-modal-overlay') {
                        e.target.classList.remove('active');
                    }
                });
            }, 100);
        }

        function returnToDrawerOpen() {
            showInteractiveScreen('home');
            setTimeout(() => {
                const userDrawer = document.getElementById('demo-user-drawer');
                const userDrawerOverlay = document.getElementById('demo-user-drawer-overlay');
                userDrawer?.classList.add('active');
                userDrawerOverlay?.classList.add('active');
            }, 200);
        }

        function attachUserCenterListeners() {
            const avatarBtn = document.getElementById('demo-avatar-btn');
            const userDrawer = document.getElementById('demo-user-drawer');
            const userDrawerOverlay = document.getElementById('demo-user-drawer-overlay');
            const editProfileBtn = document.getElementById('demo-edit-profile');

            // Update user profile display if saved
            if (window.userProfile) {
                const drawerAvatar = userDrawer.querySelector('.user-drawer-avatar');
                const drawerName = userDrawer.querySelector('.user-drawer-name');
                const avatarImgSrc = `resource/avatar/${window.userProfile.avatar}`;
                drawerAvatar.innerHTML = `<img src="${avatarImgSrc}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                drawerName.textContent = window.userProfile.nickname;
                avatarBtn.innerHTML = `<img src="${avatarImgSrc}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            }

            // Open drawer
            avatarBtn?.addEventListener('click', () => {
                userDrawer.classList.add('active');
                userDrawerOverlay.classList.add('active');
            });

            // Close drawer when clicking overlay
            userDrawerOverlay?.addEventListener('click', () => {
                userDrawer.classList.remove('active');
                userDrawerOverlay.classList.remove('active');
            });

            // Edit profile button
            editProfileBtn?.addEventListener('click', () => {
                userDrawer.classList.remove('active');
                userDrawerOverlay.classList.remove('active');
                showInteractiveScreen('profile');
            });

            // Menu item clicks
            document.querySelectorAll('.user-menu-item').forEach(item => {
                if (item.classList.contains('disabled')) return;

                item.addEventListener('click', () => {
                    const menu = item.dataset.menu;

                    // Close drawer
                    userDrawer.classList.remove('active');
                    userDrawerOverlay.classList.remove('active');

                    // Navigate based on menu
                    switch(menu) {
                        case 'language':
                            showInteractiveScreen('language');
                            break;
                        case 'reset-password':
                            navigationHistory = ['home'];  // Clear history and set home as previous
                            showInteractiveScreen('forgot-password');
                            break;
                        case 'about':
                            showInteractiveScreen('about');
                            break;
                        case 'logout':
                            showInteractiveToast('Logging out...', 'success');
                            setTimeout(() => showInteractiveScreen('login'), 1500);
                            break;
                    }
                });
            });
        }

        function showUpdateModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.setAttribute('data-type', 'modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="title-secondary" style="font-size: 20px; margin-bottom: 16px; text-align: center;">New Version Available</h3>
                    <p class="text-body" style="margin-bottom: 20px; text-align: center; font-size: 14px;">
                        Version 1.1.0 is now available
                    </p>

                    <div style="background: rgba(26, 31, 43, 0.6); border-radius: 16px; padding: 16px; margin-bottom: 24px;">
                        <div class="text-body" style="font-size: 13px; line-height: 1.8;">
                            <strong style="color: #FFFFFF;">What's New:</strong><br>
                            ‚Ä¢ Added new tag tracking features<br>
                            ‚Ä¢ Improved map performance<br>
                            ‚Ä¢ Bug fixes and stability improvements
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-secondary" style="flex: 1;" id="update-cancel">Later</button>
                        <button class="btn-primary" style="flex: 1;" id="update-now">
                            Update Now
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('interactive-container').appendChild(modal);
            modal.querySelector('.modal-content')?.setAttribute('data-component', 'comp-modal');

            modal.querySelector('#update-cancel').addEventListener('click', () => {
                modal.remove();
            });

            modal.querySelector('#update-now').addEventListener('click', () => {
                showInteractiveToast('Starting update...', 'success');
                modal.remove();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showTagInfoModal(tag) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.setAttribute('data-type', 'modal');

            const availableIcons = ['üîë', 'üéí', 'üöó', 'üì±', 'üíº', 'üéß', '‚åö', 'üëú', 'üè†', 'üö≤', 'üì∑', 'üíª'];

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px;">
                    <h3 class="title-secondary" style="font-size: 20px; margin-bottom: 20px; text-align: center;">Tag Information</h3>

                    <!-- Icon Selection -->
                    <div style="margin-bottom: 16px;">
                        <div class="text-body" style="font-size: 12px; margin-bottom: 8px;">Tag Icon</div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div id="selected-icon-display" style="font-size: 32px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(58, 139, 255, 0.1); border: 1px solid rgba(58, 139, 255, 0.3); border-radius: 12px;">${tag.icon}</div>
                            <button class="btn-secondary" style="flex: 1; font-size: 14px;" id="change-icon-btn">
                                Change Icon
                            </button>
                        </div>
                        <div id="icon-selector" style="display: none; margin-top: 12px; padding: 12px; background: rgba(26, 31, 43, 0.6); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 12px;">
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                ${availableIcons.map(icon => `
                                    <button class="icon-option-btn" data-icon="${icon}" style="font-size: 24px; width: 48px; height: 48px; background: rgba(58, 139, 255, 0.1); border: 1px solid rgba(58, 139, 255, 0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                                        ${icon}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Device Name (Editable) -->
                    <div style="margin-bottom: 16px;">
                        <label class="text-body" style="display: block; font-size: 12px; margin-bottom: 8px;">Device Name</label>
                        <input type="text" class="input-field" id="tag-name-input" value="${tag.name}" style="font-size: 15px;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="text-body" style="font-size: 12px; margin-bottom: 4px;">MAC Address</div>
                        <div style="color: #FFFFFF; font-size: 15px; font-family: 'Courier New', monospace;">${tag.mac}</div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="text-body" style="font-size: 12px; margin-bottom: 4px;">Location</div>
                        <div style="color: #FFFFFF; font-size: 15px;">${tag.lat.toFixed(4)}¬∞ N, ${Math.abs(tag.lng).toFixed(4)}¬∞ W</div>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <div class="text-body" style="font-size: 12px; margin-bottom: 4px;">Last Update</div>
                        <div style="color: #FFFFFF; font-size: 15px;">${tag.lastUpdate}</div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-secondary" style="flex: 1;" id="modal-close">Close</button>
                        <button class="btn-primary" style="flex: 1;" id="modal-save">
                            Save
                        </button>
                        <button class="btn-primary" style="flex: 1; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);" id="modal-unbind">
                            Unbind
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('interactive-container').appendChild(modal);
            modal.querySelector('.modal-content')?.setAttribute('data-component', 'comp-modal');

            let selectedIcon = tag.icon;

            // Icon change button
            modal.querySelector('#change-icon-btn').addEventListener('click', () => {
                const iconSelector = modal.querySelector('#icon-selector');
                iconSelector.style.display = iconSelector.style.display === 'none' ? 'block' : 'none';
            });

            // Icon selection
            modal.querySelectorAll('.icon-option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedIcon = btn.dataset.icon;
                    modal.querySelector('#selected-icon-display').textContent = selectedIcon;

                    // Highlight selected icon
                    modal.querySelectorAll('.icon-option-btn').forEach(b => {
                        b.style.background = 'rgba(58, 139, 255, 0.1)';
                        b.style.borderColor = 'rgba(58, 139, 255, 0.2)';
                    });
                    btn.style.background = 'rgba(58, 139, 255, 0.3)';
                    btn.style.borderColor = 'rgba(58, 139, 255, 0.6)';
                });

                // Highlight currently selected icon
                if (btn.dataset.icon === tag.icon) {
                    btn.style.background = 'rgba(58, 139, 255, 0.3)';
                    btn.style.borderColor = 'rgba(58, 139, 255, 0.6)';
                }
            });

            // Add hover effect for icon buttons
            modal.querySelectorAll('.icon-option-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    if (btn.dataset.icon !== selectedIcon) {
                        btn.style.background = 'rgba(58, 139, 255, 0.2)';
                    }
                });
                btn.addEventListener('mouseleave', () => {
                    if (btn.dataset.icon !== selectedIcon) {
                        btn.style.background = 'rgba(58, 139, 255, 0.1)';
                    }
                });
            });

            // Close button
            modal.querySelector('#modal-close').addEventListener('click', () => {
                modal.remove();
            });

            // Save button
            modal.querySelector('#modal-save').addEventListener('click', () => {
                const newName = modal.querySelector('#tag-name-input').value.trim();

                if (!newName) {
                    showInteractiveToast('‚ùå Device name cannot be empty', 'error');
                    return;
                }

                // Update tag data
                tag.name = newName;
                tag.icon = selectedIcon;

                showInteractiveToast('‚úÖ Tag information updated successfully', 'success');
                modal.remove();

                // Refresh the tag list display
                const tagElement = document.querySelector(`[data-tag-id="${tag.id}"] .tag-item-content`);
                if (tagElement) {
                    tagElement.querySelector('.tag-icon').textContent = selectedIcon;
                    tagElement.querySelector('.tag-name').textContent = newName;
                }
            });

            // Unbind button
            modal.querySelector('#modal-unbind').addEventListener('click', () => {
                showInteractiveToast('Tag unbound successfully', 'success');
                modal.remove();
            });

            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ========== Calendar Logic Functions ==========

        // Calendar state variables
        let selectedStartDate = null;
        let selectedEndDate = null;

        // Render calendar for a specific month/year
        function renderCalendar(year, month) {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const threeDaysAgo = new Date(today);
            threeDaysAgo.setDate(today.getDate() - 3);

            let html = '';

            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);
                const isToday = date.getTime() === today.getTime();
                const isFuture = date > today;
                const isTooOld = date < threeDaysAgo;
                const isDisabled = isFuture || isTooOld;

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isDisabled) classes += ' disabled';

                html += `
                    <div class="${classes}" data-date="${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}"
                         style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
                                border-radius: 8px; font-size: 13px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};
                                ${isToday ? 'border: 2px solid #3A8BFF;' : ''}
                                ${isDisabled ? 'opacity: 0.3;' : ''}
                                color: #FFFFFF;">
                        ${day}
                    </div>
                `;
            }

            grid.innerHTML = html;

            // Attach click listeners
            document.querySelectorAll('.calendar-day:not(.disabled)').forEach(dayEl => {
                dayEl.addEventListener('click', function() {
                    const dateStr = this.dataset.date;
                    if (dateStr) {
                        handleDateSelection(dateStr);
                    }
                });
            });

            // Highlight selected dates
            highlightSelectedDates();
        }

        // Handle date selection
        function handleDateSelection(dateStr) {
            const clickedDate = new Date(dateStr);
            clickedDate.setHours(0, 0, 0, 0);

            // Simple range selection logic
            if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                // Start new selection
                selectedStartDate = clickedDate;
                selectedEndDate = null;
            } else {
                // Complete range
                if (clickedDate < selectedStartDate) {
                    selectedEndDate = selectedStartDate;
                    selectedStartDate = clickedDate;
                } else {
                    selectedEndDate = clickedDate;
                }
            }

            highlightSelectedDates();
        }

        // Time storage variables
        let selectedStartTime = '00:00';
        let selectedEndTime = '23:59';

        // Get formatted datetime string for storage (not display)
        function getFormattedDateTime(date, time) {
            if (!date) return null;
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${time}:00`;
        }

        // Highlight selected date range on calendar
        function highlightSelectedDates() {
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected', 'range-start', 'range-end', 'in-range');
            });

            if (!selectedStartDate) return;

            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                if (!dayEl.dataset.date) return;
                const dayDate = new Date(dayEl.dataset.date);
                dayDate.setHours(0, 0, 0, 0);

                const startTime = new Date(selectedStartDate);
                startTime.setHours(0, 0, 0, 0);

                if (dayDate.getTime() === startTime.getTime()) {
                    if (!selectedEndDate || selectedStartDate.getTime() === selectedEndDate.getTime()) {
                        dayEl.classList.add('selected');
                    } else {
                        dayEl.classList.add('range-start');
                    }
                } else if (selectedEndDate) {
                    const endTime = new Date(selectedEndDate);
                    endTime.setHours(0, 0, 0, 0);

                    if (dayDate.getTime() === endTime.getTime()) {
                        dayEl.classList.add('range-end');
                    } else if (dayDate > startTime && dayDate < endTime) {
                        dayEl.classList.add('in-range');
                    }
                }
            });
        }

        // Quick select handlers
        function setQuickRange(range) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            switch(range) {
                case 'today':
                    selectedStartDate = new Date(today);
                    selectedEndDate = new Date(today);
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    selectedStartDate = new Date(yesterday);
                    selectedEndDate = new Date(yesterday);
                    break;
                case 'past3d':
                    const threeDaysAgo = new Date(today);
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 2);
                    selectedStartDate = new Date(threeDaysAgo);
                    selectedEndDate = new Date(today);
                    break;
            }

            highlightSelectedDates();
        }

        // ========== Time Wheel Picker Functions ==========

        let currentPickerType = 'start'; // 'start' or 'end'

        // Initialize time wheel picker
        function initTimeWheelPicker() {
            const modal = document.getElementById('time-wheel-picker-modal');
            if (!modal) return;

            const [startHour, startMinute] = selectedStartTime.split(':');
            const [endHour, endMinute] = selectedEndTime.split(':');

            // Generate start hour wheel
            const startHourWheel = document.getElementById('start-hour-wheel');
            if (startHourWheel) {
                let hourHtml = '<div style="height: 80px;"></div>';
                for (let i = 0; i <= 23; i++) {
                    const h = String(i).padStart(2, '0');
                    hourHtml += `<div class="time-wheel-item" data-value="${h}">${h}</div>`;
                }
                hourHtml += '<div style="height: 80px;"></div>';
                startHourWheel.innerHTML = hourHtml;
                setTimeout(() => {
                    const selectedItem = startHourWheel.querySelector(`[data-value="${startHour}"]`);
                    if (selectedItem) {
                        startHourWheel.scrollTop = selectedItem.offsetTop - startHourWheel.offsetHeight / 2 + 20;
                    }
                }, 50);
            }

            // Generate start minute wheel
            const startMinuteWheel = document.getElementById('start-minute-wheel');
            if (startMinuteWheel) {
                let minuteHtml = '<div style="height: 80px;"></div>';
                for (let i = 0; i <= 59; i++) {
                    const m = String(i).padStart(2, '0');
                    minuteHtml += `<div class="time-wheel-item" data-value="${m}">${m}</div>`;
                }
                minuteHtml += '<div style="height: 80px;"></div>';
                startMinuteWheel.innerHTML = minuteHtml;
                setTimeout(() => {
                    const selectedItem = startMinuteWheel.querySelector(`[data-value="${startMinute}"]`);
                    if (selectedItem) {
                        startMinuteWheel.scrollTop = selectedItem.offsetTop - startMinuteWheel.offsetHeight / 2 + 20;
                    }
                }, 50);
            }

            // Generate end hour wheel
            const endHourWheel = document.getElementById('end-hour-wheel');
            if (endHourWheel) {
                let hourHtml = '<div style="height: 80px;"></div>';
                for (let i = 0; i <= 23; i++) {
                    const h = String(i).padStart(2, '0');
                    hourHtml += `<div class="time-wheel-item" data-value="${h}">${h}</div>`;
                }
                hourHtml += '<div style="height: 80px;"></div>';
                endHourWheel.innerHTML = hourHtml;
                setTimeout(() => {
                    const selectedItem = endHourWheel.querySelector(`[data-value="${endHour}"]`);
                    if (selectedItem) {
                        endHourWheel.scrollTop = selectedItem.offsetTop - endHourWheel.offsetHeight / 2 + 20;
                    }
                }, 50);
            }

            // Generate end minute wheel
            const endMinuteWheel = document.getElementById('end-minute-wheel');
            if (endMinuteWheel) {
                let minuteHtml = '<div style="height: 80px;"></div>';
                for (let i = 0; i <= 59; i++) {
                    const m = String(i).padStart(2, '0');
                    minuteHtml += `<div class="time-wheel-item" data-value="${m}">${m}</div>`;
                }
                minuteHtml += '<div style="height: 80px;"></div>';
                endMinuteWheel.innerHTML = minuteHtml;
                setTimeout(() => {
                    const selectedItem = endMinuteWheel.querySelector(`[data-value="${endMinute}"]`);
                    if (selectedItem) {
                        endMinuteWheel.scrollTop = selectedItem.offsetTop - endMinuteWheel.offsetHeight / 2 + 20;
                    }
                }, 50);
            }

            // Show modal
            modal.style.display = 'flex';
            lucide.createIcons();
        }

        // Get selected times from wheel picker
        function getSelectedTimesFromWheel() {
            const startHourWheel = document.getElementById('start-hour-wheel');
            const startMinuteWheel = document.getElementById('start-minute-wheel');
            const endHourWheel = document.getElementById('end-hour-wheel');
            const endMinuteWheel = document.getElementById('end-minute-wheel');

            if (!startHourWheel || !startMinuteWheel || !endHourWheel || !endMinuteWheel) {
                return { startTime: '00:00', endTime: '23:59' };
            }

            // Helper to find closest item to center
            const getClosestValue = (wheel) => {
                const center = wheel.scrollTop + wheel.offsetHeight / 2;
                const items = wheel.querySelectorAll('.time-wheel-item');
                let minDist = Infinity;
                let value = '00';
                items.forEach(item => {
                    const itemCenter = item.offsetTop + item.offsetHeight / 2;
                    const dist = Math.abs(itemCenter - center);
                    if (dist < minDist) {
                        minDist = dist;
                        value = item.dataset.value;
                    }
                });
                return value;
            };

            const startHour = getClosestValue(startHourWheel);
            const startMinute = getClosestValue(startMinuteWheel);
            const endHour = getClosestValue(endHourWheel);
            const endMinute = getClosestValue(endMinuteWheel);

            return {
                startTime: `${startHour}:${startMinute}`,
                endTime: `${endHour}:${endMinute}`
            };
        }

        // Close time wheel picker
        function closeTimeWheelPicker() {
            const modal = document.getElementById('time-wheel-picker-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Confirm time selection
        function confirmTimeSelection() {
            const times = getSelectedTimesFromWheel();
            selectedStartTime = times.startTime;
            selectedEndTime = times.endTime;

            const startDisplay = document.getElementById('start-time-display');
            const endDisplay = document.getElementById('end-time-display');
            if (startDisplay) startDisplay.textContent = times.startTime;
            if (endDisplay) endDisplay.textContent = times.endTime;

            closeTimeWheelPicker();
        }

        // ========== Path View Map Functions ==========

        let pathMap = null;
        let pathMarkers = [];
        let pathPolyline = null;
        let currentFocusedIndex = null;
        let pendingFocusIndex = null; // Store pending focus request from history list
        let cameFromHistory = false; // Track if we navigated from history-point screen
        let userLocationMarker = null; // Store user's location marker
        let userLocation = null; // Store user's location coordinates

        // Initialize path view map
        function initPathViewMap(initialFocusIndex = null) {
            const mapElement = document.getElementById('demo-path-map');
            if (!mapElement) return;

            // Clean up existing map
            if (pathMap) {
                pathMap.remove();
                pathMap = null;
            }

            // Get trajectory data (for demo, always show all points)
            const tagId = window.currentTag?.id || 1;
            const trajectoryPoints = mockTrajectoryData[tagId] || [];

            if (trajectoryPoints.length === 0) {
                showInteractiveToast('No trajectory data available', 'error');
                setTimeout(() => {
                    goBack('path-datepicker');
                }, 1500);
                return;
            }

            // Store points globally for tooltip navigation
            window.currentTrajectoryPoints = trajectoryPoints;

            // Initialize map centered on focus point or last point
            // Check for pending focus request first
            let focusIndex = initialFocusIndex;
            if (focusIndex === null && pendingFocusIndex !== null) {
                focusIndex = pendingFocusIndex;
                pendingFocusIndex = null; // Clear pending request
            }
            if (focusIndex === null) {
                focusIndex = trajectoryPoints.length - 1; // Default to last point
            }
            const centerPoint = trajectoryPoints[focusIndex];
            pathMap = L.map('demo-path-map', {
                center: [centerPoint.lat, centerPoint.lng],
                zoom: 14,
                zoomControl: false,
                attributionControl: false
            });

            // Add AMap tiles
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '&copy; È´òÂæ∑Âú∞Âõæ',
                maxZoom: 19
            }).addTo(pathMap);

            // Render trajectory
            renderTrajectoryLine(trajectoryPoints);
            createKeyPointMarkers(trajectoryPoints);

            // Add user location marker (mock location visible on screen)
            createUserLocationMarker(trajectoryPoints);

            // Focus on specified point after a short delay
            setTimeout(() => {
                focusOnPoint(focusIndex, trajectoryPoints);
            }, 500);
        }

        // Create user location marker
        function createUserLocationMarker(trajectoryPoints) {
            if (!pathMap || trajectoryPoints.length === 0) return;

            // Remove existing marker
            if (userLocationMarker && pathMap) {
                pathMap.removeLayer(userLocationMarker);
            }

            // Set user location near the middle point of trajectory (for demo visibility)
            const midIndex = Math.floor(trajectoryPoints.length / 2);
            const midPoint = trajectoryPoints[midIndex];

            // Offset slightly from trajectory point to ensure visibility
            userLocation = {
                lat: midPoint.lat + 0.002,  // Offset ~200m north
                lng: midPoint.lng - 0.002   // Offset ~200m west
            };

            // Create custom marker for user location
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                html: `
                    <div style="position: relative; width: 40px; height: 40px;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background: #3A8BFF; border: 3px solid #FFFFFF; border-radius: 50%; box-shadow: 0 0 0 4px rgba(58, 139, 255, 0.3), 0 2px 8px rgba(0, 0, 0, 0.3);"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: rgba(58, 139, 255, 0.2); border-radius: 50%; animation: pulse-ring 2s infinite;"></div>
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: userIcon,
                zIndexOffset: 1000  // Keep above trajectory markers
            }).addTo(pathMap);
        }

        // Render trajectory line
        function renderTrajectoryLine(points) {
            if (pathPolyline && pathMap) {
                pathMap.removeLayer(pathPolyline);
            }

            if (!pathMap || points.length === 0) return;

            const latLngs = points.map(p => [p.lat, p.lng]);

            pathPolyline = L.polyline(latLngs, {
                color: '#3A8BFF',
                weight: 3,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(pathMap);

            // Fit bounds to show entire path
            if (points.length > 1) {
                pathMap.fitBounds(pathPolyline.getBounds(), { padding: [50, 50] });
            }
        }

        // Create key point markers
        function createKeyPointMarkers(points) {
            // Clear existing markers
            pathMarkers.forEach(m => {
                if (pathMap) pathMap.removeLayer(m);
            });
            pathMarkers = [];

            if (!pathMap) return;

            points.forEach((point, index) => {
                const label = getPointLabel(index, points.length);
                const isStart = index === 0;
                const isEnd = index === points.length - 1;

                let markerColor = '#3A8BFF'; // Middle points
                if (isStart) markerColor = '#22C55E'; // Green for start
                if (isEnd) markerColor = '#EC6C70'; // Red for end

                const markerIcon = L.divIcon({
                    className: 'trajectory-marker',
                    html: `
                        <div class="trajectory-marker-inner" data-index="${index}" style="
                            width: 24px;
                            height: 24px;
                            background: ${markerColor};
                            border: 2px solid #FFFFFF;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #FFFFFF;
                            font-weight: 700;
                            font-size: 11px;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                            transition: transform 0.2s ease;
                        ">
                            ${label}
                        </div>
                    `,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([point.lat, point.lng], {
                    icon: markerIcon
                }).addTo(pathMap);

                pathMarkers.push(marker);
            });

            // Add click listeners to markers after DOM render
            setTimeout(() => {
                document.querySelectorAll('.trajectory-marker-inner').forEach(markerEl => {
                    markerEl.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        focusOnPoint(index, points);
                    });
                });
            }, 100);
        }

        // Focus on a specific point and show tooltip
        function focusOnPoint(index, points) {
            if (index < 0 || index >= points.length) return;

            currentFocusedIndex = index;
            const point = points[index];

            // Center map on point
            if (pathMap) {
                pathMap.setView([point.lat, point.lng], 16, { animate: true });
            }

            // Update tooltip content
            const label = getPointLabel(index, points.length);
            const seqEl = document.getElementById('tooltip-sequence');
            // Use sequential numbers with "No." prefix (1, 2, 3, ... N)
            if (seqEl) {
                seqEl.textContent = 'No.' + (index + 1);
            }

            const timeEl = document.getElementById('tooltip-timestamp');
            if (timeEl) timeEl.textContent = point.timestamp;

            // Calculate duration to next point
            const durationEl = document.getElementById('tooltip-duration');
            if (durationEl) {
                if (index < points.length - 1) {
                    const duration = calculateDuration(point.timestamp, points[index + 1].timestamp);
                    durationEl.textContent = duration;
                } else {
                    durationEl.textContent = 'Final point';
                }
            }

            const addressEl = document.getElementById('tooltip-address');
            if (addressEl) addressEl.textContent = point.address;

            // Update prev/next button states
            const prevBtn = document.getElementById('tooltip-prev');
            const nextBtn = document.getElementById('tooltip-next');

            if (prevBtn) {
                if (index === 0) {
                    prevBtn.style.opacity = '0.3';
                    prevBtn.style.pointerEvents = 'none';
                } else {
                    prevBtn.style.opacity = '1';
                    prevBtn.style.pointerEvents = 'auto';
                }
            }

            if (nextBtn) {
                if (index === points.length - 1) {
                    nextBtn.style.opacity = '0.3';
                    nextBtn.style.pointerEvents = 'none';
                } else {
                    nextBtn.style.opacity = '1';
                    nextBtn.style.pointerEvents = 'auto';
                }
            }

            // Show tooltip
            showPointTooltip();

            // Highlight focused marker
            document.querySelectorAll('.trajectory-marker-inner').forEach(m => {
                if (parseInt(m.dataset.index) === index) {
                    m.style.transform = 'scale(1.3)';
                    m.style.zIndex = '1000';
                } else {
                    m.style.transform = 'scale(1)';
                    m.style.zIndex = 'auto';
                }
            });
        }

        // Show point tooltip
        function showPointTooltip() {
            const tooltip = document.getElementById('point-tooltip');
            if (tooltip) {
                tooltip.style.display = 'block';
            }
        }

        // Navigate to previous/next point
        function navigatePoints(direction) {
            const points = window.currentTrajectoryPoints;
            if (!points || currentFocusedIndex === null) return;

            const newIndex = currentFocusedIndex + direction;
            if (newIndex >= 0 && newIndex < points.length) {
                focusOnPoint(newIndex, points);
            }
        }

        // ========== History Point List Function ==========

        // Render history points list
        function renderHistoryPointsList() {
            const listContainer = document.getElementById('history-point-list');
            if (!listContainer) return;

            const tagId = window.currentTag?.id || 1;
            // Use all mock data for demo (consistent with path-view)
            const points = mockTrajectoryData[tagId] || [];

            // Store points globally
            window.currentTrajectoryPoints = points;

            // Update count
            const countEl = document.getElementById('history-point-count');
            if (countEl) countEl.textContent = `${points.length} locations found`;

            if (points.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #8B94A4; padding: 20px;">No points available</div>';
                return;
            }

            // Render cards
            const html = points.map((point, index) => {
                const label = getPointLabel(index, points.length);
                const isStart = index === 0;
                const isEnd = index === points.length - 1;

                let labelColor = '#3A8BFF';
                if (isStart) labelColor = '#22C55E';
                if (isEnd) labelColor = '#EC6C70';

                const duration = index < points.length - 1
                    ? calculateDuration(point.timestamp, points[index + 1].timestamp)
                    : 'Final point';

                return `
                    <div class="history-point-card" data-index="${index}" style="
                        background: rgba(26, 31, 43, 0.6);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(58, 139, 255, 0.15);
                        border-radius: 16px;
                        padding: 16px;
                        margin-bottom: 12px;
                        transition: all 0.3s ease;
                    ">
                        <!-- First row: sequence + timestamp + chevron -->
                        <div class="history-card-first-row" style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; cursor: pointer;">
                            <div style="
                                width: 32px;
                                height: 32px;
                                background: ${labelColor};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: #FFFFFF;
                                font-weight: 700;
                                font-size: 13px;
                                flex-shrink: 0;
                            ">
                                ${label}
                            </div>
                            <div style="flex: 1; color: #FFFFFF; font-weight: 600; font-size: 14px;">
                                ${point.timestamp}
                            </div>
                            <i data-lucide="chevron-right" style="color: #3A8BFF; flex-shrink: 0;"></i>
                        </div>
                        <!-- Second row: duration + address (full width) - Click to copy -->
                        <div>
                            <div class="text-body history-copy-duration" data-copy-text="${duration}" style="font-size: 12px; margin-bottom: 4px; cursor: pointer; transition: color 0.2s ease;">
                                Duration: ${duration}
                            </div>
                            <div class="text-body history-copy-address" data-copy-text="${point.address}" style="font-size: 12px; line-height: 1.4; word-break: break-word; cursor: pointer; transition: color 0.2s ease;">
                                ${point.address}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            listContainer.innerHTML = html;

            // Re-init lucide icons
            lucide.createIcons();

            // Attach click listeners
            // Attach click listeners to first row only
            document.querySelectorAll('.history-card-first-row').forEach(firstRow => {
                firstRow.addEventListener('click', function() {
                    const card = this.closest('.history-point-card');
                    const index = parseInt(card.dataset.index);
                    // Store pending focus index and set flag that we came from history
                    pendingFocusIndex = index;
                    cameFromHistory = true;
                    showInteractiveScreen('path-view', false);
                });
            });

            // Attach hover effect to card
            document.querySelectorAll('.history-point-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.borderColor = 'rgba(58, 139, 255, 0.5)';
                    this.style.transform = 'translateX(4px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.borderColor = 'rgba(58, 139, 255, 0.15)';
                    this.style.transform = 'translateX(0)';
                });
            });

            // Attach copy listeners to duration and address
            document.querySelectorAll('.history-copy-duration').forEach(el => {
                el.addEventListener('click', async function(e) {
                    e.stopPropagation(); // Prevent card navigation
                    const text = this.dataset.copyText;
                    try {
                        await navigator.clipboard.writeText(text);
                        showInteractiveToast('‚è±Ô∏è Duration copied');
                        // Visual feedback
                        const originalColor = this.style.color;
                        this.style.color = '#3A8BFF';
                        setTimeout(() => {
                            this.style.color = originalColor;
                        }, 200);
                    } catch (e) {
                        showInteractiveToast('Failed to copy', 'error');
                    }
                });
                // Hover effect
                el.addEventListener('mouseenter', function() {
                    this.style.color = '#3A8BFF';
                });
                el.addEventListener('mouseleave', function() {
                    this.style.color = '';
                });
            });

            document.querySelectorAll('.history-copy-address').forEach(el => {
                el.addEventListener('click', async function(e) {
                    e.stopPropagation(); // Prevent card navigation
                    const text = this.dataset.copyText;
                    try {
                        await navigator.clipboard.writeText(text);
                        showInteractiveToast('üìç Address copied');
                        // Visual feedback
                        const originalColor = this.style.color;
                        this.style.color = '#3A8BFF';
                        setTimeout(() => {
                            this.style.color = originalColor;
                        }, 200);
                    } catch (e) {
                        showInteractiveToast('Failed to copy', 'error');
                    }
                });
                // Hover effect
                el.addEventListener('mouseenter', function() {
                    this.style.color = '#3A8BFF';
                });
                el.addEventListener('mouseleave', function() {
                    this.style.color = '';
                });
            });
        }

        function showInteractiveToast(message, type = 'success') {
            const toast = document.getElementById('interactive-toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        console.log('%c NavTag Interactive Prototype ', 'background: #3A8BFF; color: #FFFFFF; font-size: 16px; padding: 10px; border-radius: 8px;');
        console.log('Full user flow with real map integration');
    </script>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
